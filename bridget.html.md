# Bridget


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## Why Bridget?

Jupyter notebooks serve two primary functions: 1.
**Exploratory/Educational**: Interactive computing and learning 2.
**Development**: Literate programming and package creation (via nbdev)

While code creation is well-served by various notebook environments
(Jupyter, VSCode, Marimo, etc.), the display and interaction
capabilities are often limited by IPython‚Äôs well-thought but basic and
aging display system. Modern development requires:

- Rich data visualization
- Interactive system integration
- Better control over output rendering

### The Front-end Challenge

Notebooks already run in browsers (or browser-like environments), giving
us access to powerful HTML/JavaScript capabilities. The front-end and
kernel are inherently connected, suggesting we shouldn‚Äôt need additional
communication layers.

However, the notebook ecosystem is fragmented: - Jupyter (nbclassic,
Notebook, Lab): ipywidgets - VSCode/Cursor: Extensions - Marimo: Custom
solutions - Google Colab: Proprietary package

This fragmentation forces users needing better display solutions to deal
with complex, environment-specific tooling.

### Enter FastHTML and HTMX

FastHTML provides an innovative approach to web apps, emphasizing
HTML-first development through HTMX. While Jupyter support isn‚Äôt its
core focus, FastHTML itself is developed using nbdev in notebooks.

Current FastHTML notebook integration: - Launches a separate Uvicorn
server - Connects HTMX via standard HTTP/AJAX - Works across most
notebook variants

This approach is general, clean and lightweight but involves spawning a
full HTTP server with: - Multi-user capabilities (unnecessary for
notebooks) - Async architecture (notebooks are sync) - Complex lifecycle
management - Production-level features (overkill for notebook use) -
IPython Javascript display object in each cell to trigger HTMX.

### The Bridget Solution

Bridget proposes using a widget-based approach that: 1. **Simplifies**:
Replaces HTTP server with direct widget communication 2.
**Generalizes**: Works across notebook environments via AnyWidget 3.
**Extends**: Enables creation of notebook-specific components 4.
**Integrates**: Provides Python API for HTMX functionality

This proof-of-concept shows how we can maintain FastHTML‚Äôs powerful
features while better adapting to the notebook environment‚Äôs unique
characteristics and constraints.

<div>

> **Note**
>
> Personal note: My interest here isn‚Äôt web apps, but notebook
> development.
>
> I like ipywidgets, or at least the intention. I‚Äôve written several and
> used them in many personal projects. However, they‚Äôre a challenging
> piece of software with complicated tooling. They inherit all the
> nightmarish complexity of the JavaScript ecosystem, where the tooling
> is more involved than the language itself. AnyWidget is a step in the
> right direction, liberating us Pythonistas from the JS ecosystem. But
> the notebook part, the Python part, remains an unsolved problem in my
> opinion.
>
> Of all solutions I‚Äôve explored for achieving full interactivity in
> notebooks, HTMX + FastHTML comes closest, feeling more natural and
> integrating better with the notebook environment.

</div>

<!-- # Prologue -->

``` python
bridge_cfg.auto_show = True
bridge_cfg.auto_id = True
```

These flags control automatic behaviors throughout this notebook. See
`01_helpers.ipynb` for full configuration options.

# Helpers

> Some convenience utils to work with FastHTML in Notebooks.

``` python
# nb = get_nb(show_logger=True, show_feedback=True, summary=True)
# bridge = get_bridge(plugins=[HTMXCommanderPlugin()], wait=5)
bridge = get_bridge(plugins=[HTMXCommanderPlugin(), NBHooksPlugin()], show_logger=True, summary=True, wait=5)
```

Bridget automatically loads required JavaScript libraries:

1.  HTMX
2.  FastHTML core scripts
3.  Awesome gnat‚Äôs Scope and Surreal scripts
4.  Bridge helpers

These are loaded by default when creating a Bridget app. You can
customize this by overriding defaults when creating the app (covered in
app creation section)

## ClientP

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridget.py#L68"
target="_blank" style="float:right; font-size:smaller">source</a>

### ClientP

>  ClientP (*args, **kwargs)

*HTTP client interface supporting REST operations (get, post, delete)*

## Bridget utils

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridget.py#L78"
target="_blank" style="float:right; font-size:smaller">source</a>

### request2httpx_request

>  request2httpx_request (cli:httpx.AsyncClient,
>                             http_request:dict[str,typing.Any])

*Convert bridget request dict to httpx Request object*

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridget.py#L105"
target="_blank" style="float:right; font-size:smaller">source</a>

### httpx_response_to_json

>  httpx_response_to_json (response:httpx.Response)

*Convert httpx Response to JSON dict with headers and content*

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridget.py#L97"
target="_blank" style="float:right; font-size:smaller">source</a>

### request2response

>  request2response (cli:httpx.AsyncClient, http_request)

*Execute bridget request and return httpx Response*

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridget.py#L90"
target="_blank" style="float:right; font-size:smaller">source</a>

### HasHTML

>  HasHTML (*args, **kwargs)

*Objects that can render themselves as HTML strings*

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridget.py#L87"
target="_blank" style="float:right; font-size:smaller">source</a>

### HasFT

>  HasFT (*args, **kwargs)

*Objects that can convert themselves to FastHTML FT components*

``` python
@FC.patch
def _ipython_display_(self: Response):
    # dhdl = DisplayId()
    # dhdl.display(self.text)
    IDISPLAY(HTML(self.text))
```

# BridgetClient

> A mixin class that wraps FastHTML and Client functionality for
> displaying and mounting components.

Display: - FT & objects with `__ft__` or `__html__` - Mappings in the
form of HTTP requests - URLs

Mount: - APIRouter or RouteProvider

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridget.py#L125"
target="_blank" style="float:right; font-size:smaller">source</a>

### BridgetClient

>  BridgetClient ()

*A simple wrapper around `FastHTML` and `Client`.*

`BridgeClient` is a mixin class that provides:

1.  **Client functionality**:
2.  **Display functionality**: Renders FastHTML objects and route
    responses in notebook cells
3.  **Component mounting**: Helper for mounting route providers

It serves as a mixin class for
[`Bridget`](https://civvic.github.io/bridget/bridget.html#bridget),
which provides the full HTMX integration.

The class handles different types of ‚Äúbridgeable‚Äù content: - FastHTML
objects (FT) - Objects with `__ft__` or `__html__` methods - Route
paths - Request mappings

``` python
brt_cli = BridgetClient().setup()
app, rt = brt_cli.app, brt_cli.app.route

brt_cli();
```

404 Not Found
<brd-mark id="884db9a043bea536b92afc911933b57f"></brd-mark>

``` python
@app.get("/")  # type: ignore
def home():
    # return "<strong>Config</strong>: " + str(bridge_cfg.as_dict())
    # return Span(Strong('Config'), ': ' + str(bridge_cfg.as_dict()))
    return DetailsJSON(bridge_cfg.as_dict(), summary='Bridget Config').__ft__()

brt_cli();
```

``` python
@rt("/hi")
def get():
    return 'Hi there'

http_request = {
    'upload': {},
    'headers': {
        'HX-Request': 'true',
        'HX-Current-URL': 'vscode-webview://1ql27b...er'
    },
    'headerNames': {'hx-request': 'HX-Request', 'hx-current-url': 'HX-Current-URL'},
    'status': 0,
    'method': 'GET',
    'url': '/hi',
    'async': True,
    'timeout': 0,
    'withCredentials': False,
    'body': None
}

response = brt_cli._response(http_request)
test_eq(response.status_code, 200)
test_eq(response.text, 'Hi there')

console.print_json(data=(json_resp := httpx_response_to_json(response)))
test_eq(json_resp['status'], 200)
test_eq(json_resp['data'], 'Hi there')
test_eq(json_resp['headers']['content-length'], '8')

response
```

<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span>
  <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">"headers"</span>: <span style="font-weight: bold">{</span>
    <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">"vary"</span>: <span style="color: #008000; text-decoration-color: #008000">"HX-Request, HX-History-Restore-Request"</span>,
    <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">"content-length"</span>: <span style="color: #008000; text-decoration-color: #008000">"8"</span>,
    <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">"content-type"</span>: <span style="color: #008000; text-decoration-color: #008000">"text/html; charset=utf-8"</span>,
    <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">"last-modified"</span>: <span style="color: #008000; text-decoration-color: #008000">"Wed, 03 Dec 2025 14:22:36 GMT"</span>,
    <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">"cache-control"</span>: <span style="color: #008000; text-decoration-color: #008000">"no-store, no-cache, must-revalidate"</span>
  <span style="font-weight: bold">}</span>,
  <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">"status"</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">200</span>,
  <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">"statusText"</span>: <span style="color: #008000; text-decoration-color: #008000">"OK"</span>,
  <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">"data"</span>: <span style="color: #008000; text-decoration-color: #008000">"Hi there"</span>,
  <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">"xml"</span>: <span style="color: #800080; text-decoration-color: #800080; font-style: italic">null</span>,
  <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">"finalUrl"</span>: <span style="color: #008000; text-decoration-color: #008000">"http://nb/hi"</span>
<span style="font-weight: bold">}</span>
</pre>
&#10;<brd-mark id="b044f5250-b2e327cd-fd825ee6-76653548"></brd-mark>

Hi there
<brd-mark id="bd5610cbf-6392de39-4751bbca-b2861446"></brd-mark>

``` python
brt_cli(http_request);
```

Hi there
<brd-mark id="09003df5a195d6ab98c71c46b3d9af96"></brd-mark>

``` python
class Buttons:
    def __ft__(self):
        return (
            Button(garlic=True, hx_get='/test', hx_select='button[vampire]', hx_swap='afterend')(_n,
                Style(self._css_.format('hsl(264 80% 47%)', 'hsl(264 80% 60%)')),
                'garlic ', Span('üßÑ', cls='icon'),
            _n), _n,
            Button(vampire=True, hx_get='/test', hx_select='button[garlic]', hx_swap='afterend')(_n,
                Style(self._css_.format('hsl(150 80% 47%)', 'hsl(150 80% 60%)')), 
                'vampire ', Span('üßõ', cls='icon'),
            _n), _n,
        )
    _css_ = '''
    me {{ margin: 4px; padding: 10px 30px; min-width: 80px; background: {0}; border-bottom: 0.5rem solid hsl(264 80% 20%); }}
    me {{ color: antiquewhite; font-size: 14pt; font-variant: all-small-caps; font-weight: bold; }}
    me:hover {{ background: {1}; }}
    me span.icon {{ font-size:16pt; }}
'''
```

``` python
@rt("/test")
def get():
    return Buttons()

http_request = {
    'headers': {'hx-request': '1'},
    'method': 'GET',
    'url': 'http://nb/test',
}

r = brt_cli._response(http_request)
display(Markdown(f"```HTML\n{r.text}\n```"))
r
```

``` html
<button garlic hx-get="/test" hx-select="button[vampire]" hx-swap="afterend">
   <style>
    me { margin: 4px; padding: 10px 30px; min-width: 80px; background: hsl(264 80% 47%); border-bottom: 0.5rem solid hsl(264 80% 20%); }
    me { color: antiquewhite; font-size: 14pt; font-variant: all-small-caps; font-weight: bold; }
    me:hover { background: hsl(264 80% 60%); }
    me span.icon { font-size:16pt; }
</style>
garlic <span class="icon">üßÑ</span>
</button>
<button vampire hx-get="/test" hx-select="button[garlic]" hx-swap="afterend">
   <style>
    me { margin: 4px; padding: 10px 30px; min-width: 80px; background: hsl(150 80% 47%); border-bottom: 0.5rem solid hsl(264 80% 20%); }
    me { color: antiquewhite; font-size: 14pt; font-variant: all-small-caps; font-weight: bold; }
    me:hover { background: hsl(150 80% 60%); }
    me span.icon { font-size:16pt; }
</style>
vampire <span class="icon">üßõ</span>
</button>
```

<button garlic hx-get="/test" hx-select="button[vampire]" hx-swap="afterend">
   <style>
    me { margin: 4px; padding: 10px 30px; min-width: 80px; background: hsl(264 80% 47%); border-bottom: 0.5rem solid hsl(264 80% 20%); }
    me { color: antiquewhite; font-size: 14pt; font-variant: all-small-caps; font-weight: bold; }
    me:hover { background: hsl(264 80% 60%); }
    me span.icon { font-size:16pt; }
</style>
garlic <span class="icon">üßÑ</span>
</button>
<button vampire hx-get="/test" hx-select="button[garlic]" hx-swap="afterend">
   <style>
    me { margin: 4px; padding: 10px 30px; min-width: 80px; background: hsl(150 80% 47%); border-bottom: 0.5rem solid hsl(264 80% 20%); }
    me { color: antiquewhite; font-size: 14pt; font-variant: all-small-caps; font-weight: bold; }
    me:hover { background: hsl(150 80% 60%); }
    me span.icon { font-size:16pt; }
</style>
vampire <span class="icon">üßõ</span>
</button>
&#10;<brd-mark id="b0a771e5b-1e6a4043-16df5c52-d77f98bf"></brd-mark>

``` python
brt_cli('/test');
```

<button garlic hx-get="/test" hx-select="button[vampire]" hx-swap="afterend">
   <style>
    me { margin: 4px; padding: 10px 30px; min-width: 80px; background: hsl(264 80% 47%); border-bottom: 0.5rem solid hsl(264 80% 20%); }
    me { color: antiquewhite; font-size: 14pt; font-variant: all-small-caps; font-weight: bold; }
    me:hover { background: hsl(264 80% 60%); }
    me span.icon { font-size:16pt; }
</style>
garlic <span class="icon">üßÑ</span>
</button>
<button vampire hx-get="/test" hx-select="button[garlic]" hx-swap="afterend">
   <style>
    me { margin: 4px; padding: 10px 30px; min-width: 80px; background: hsl(150 80% 47%); border-bottom: 0.5rem solid hsl(264 80% 20%); }
    me { color: antiquewhite; font-size: 14pt; font-variant: all-small-caps; font-weight: bold; }
    me:hover { background: hsl(150 80% 60%); }
    me span.icon { font-size:16pt; }
</style>
vampire <span class="icon">üßõ</span>
</button>
&#10;<brd-mark id="7ded6d040d05938d238c4ea81c49fa2a"></brd-mark>

``` python
brt_cli(Buttons());
```

<button garlic hx-get="/test" hx-select="button[vampire]" hx-swap="afterend">
  <style>
    me { margin: 4px; padding: 10px 30px; min-width: 80px; background: hsl(264 80% 47%); border-bottom: 0.5rem solid hsl(264 80% 20%); }
    me { color: antiquewhite; font-size: 14pt; font-variant: all-small-caps; font-weight: bold; }
    me:hover { background: hsl(264 80% 60%); }
    me span.icon { font-size:16pt; }
</style>
garlic <span class="icon">üßÑ</span>
</button>
<button vampire hx-get="/test" hx-select="button[garlic]" hx-swap="afterend">
  <style>
    me { margin: 4px; padding: 10px 30px; min-width: 80px; background: hsl(150 80% 47%); border-bottom: 0.5rem solid hsl(264 80% 20%); }
    me { color: antiquewhite; font-size: 14pt; font-variant: all-small-caps; font-weight: bold; }
    me:hover { background: hsl(150 80% 60%); }
    me span.icon { font-size:16pt; }
</style>
vampire <span class="icon">üßõ</span>
</button>
&#10;<brd-mark id="f8508c42ac4e90e839dc9c2651e329fe"></brd-mark>

``` python
# css = Style(':root {--pico-font-size:90%,--pico-font-family: Pacifico, cursive;}')

@app.route("/page")
def get():
    return (Title("Hello World"), 
            Main(H1('Hello, World'), cls="container"))

r = brt_cli._response(req := {
    # 'headers': {'hx-request': '1'},
    'method': 'GET',
    'url': 'http://nb/page',
})
display(Markdown(f"```HTML\n{r.text}\n```"))
brt_cli('page');
```

``` html
 <!doctype html>
 <html>
   <head>
     <title>Hello World</title>
     <link rel="canonical" href="http://nb/page">
<script>
    function sendmsg() {
        window.parent.postMessage({height: document.documentElement.offsetHeight}, '*');
    }
    window.onload = function() {
        sendmsg();
        document.body.addEventListener('htmx:afterSettle',    sendmsg);
        document.body.addEventListener('htmx:wsAfterMessage', sendmsg);
    };</script>   </head>
   <body>
<main class="container">       <h1>Hello, World</h1>
</main>   </body>
 </html>
```

 <title>Hello World</title>
<main class="container">   <h1>Hello, World</h1>
</main>
<brd-mark id="d3bb254d1ac71f59ad66cfd7dcd023f2"></brd-mark>

``` python
dtl = Details(cls='pale', open=True)(
    Style('me details { border: 1px solid #aaa; padding: 0.5em 0.5em 0; } me summary { font-weight: bold; margin: -0.5em -0.5em 0; padding: 0.5em; } me pre { margin: 0; }'),
    Summary('What Lucy get?'),
    Div(cls='contents', style='display: flex; flex-direction: column;')(
        Pre('She'),
        Pre('got'),
        Pre('diamonds!')
    )
)
display(dtl)
brt_cli(dtl);
```

``` html
<details open class="pale">  <style>me details { border: 1px solid #aaa; padding: 0.5em 0.5em 0; } me summary { font-weight: bold; margin: -0.5em -0.5em 0; padding: 0.5em; } me pre { margin: 0; }</style>
<summary>What Lucy get?</summary>  <div class="contents" style="display: flex; flex-direction: column;">
<pre>She</pre><pre>got</pre><pre>diamonds!</pre>  </div>
</details>
```

<details open class="pale">  <style>me details { border: 1px solid #aaa; padding: 0.5em 0.5em 0; } me summary { font-weight: bold; margin: -0.5em -0.5em 0; padding: 0.5em; } me pre { margin: 0; }</style>
<summary>What Lucy get?</summary>  <div class="contents" style="display: flex; flex-direction: column;">
<pre>She</pre><pre>got</pre><pre>diamonds!</pre>  </div>
</details>
<brd-mark id="2eb4d13a81062a09d245a1edeb7a1810"></brd-mark>

``` python
def details_ft(
        *contents, 
        summary:str|None=None, 
        closed:bool=False, 
        direction:str='column', 
        height:str|None=None,
        contents_style:str='', item_style:str=''):
    style = f"display: flex; flex-direction: {direction};{height or ''}{contents_style or ''}"
    return Details(cls='pale', open=not closed)(
        Summary(summary),
        Div(cls='contents', style=style)(
            *(Div(style=item_style)(_) for _ in contents)
        )
    )

dtl = details_ft(
        *(Pre(_) for _ in ('She', 'got', 'diamonds')), 
        summary='What Lucy get?')
display(dtl)
brt_cli(dtl);
```

``` html
<details open class="pale"><summary>What Lucy get?</summary>  <div class="contents" style="display: flex; flex-direction: column;">
    <div>
<pre>She</pre>    </div>
    <div>
<pre>got</pre>    </div>
    <div>
<pre>diamonds</pre>    </div>
  </div>
</details>
```

<details open class="pale"><summary>What Lucy get?</summary>  <div class="contents" style="display: flex; flex-direction: column;">
    <div>
<pre>She</pre>    </div>
    <div>
<pre>got</pre>    </div>
    <div>
<pre>diamonds</pre>    </div>
  </div>
</details>
<brd-mark id="a4227c1b47483e13743506a9786b8aaf"></brd-mark>

``` python
bridge.logger.show()
```

<div id='brd-logger_2-1764771735' class='brd-logger' style='width: 100%; max-height: 200px;'></div>
<brd-mark id="bca051957-dd9636d9-395456de-30d33f14"></brd-mark>

As there only one instance of a logger running, use `logger.show()` to
display the logger near a cell to see what‚Äôs going on.

``` python
<div id="output-99">Original</div>
```

<div id="output-99">Original</div>
&#10;<brd-mark id="bee6018d1-c00d2ba2-8f45b6e8-25f19f58"></brd-mark>

``` python
bridge.commander.swap('#output-99', '<div>Swapped!</div>', swapStyle='innerHTML')
```

We can also use HTMX API through Bridge (documented in
[16_bridge_plugins.ipynb](16_bridge_plugins.ipynb)).

But we‚Äôll see a more convenient way with Bridget, without peppering the
notebook of IPython Javascript display objects.

``` python
# fbridge(Div('Hey, Foo!'), display_id='ultra-cool-display-id')
Div('Hey, Foo!')
```

<div>Hey, Bar!</div>
&#10;<brd-mark id="b19bb1220-2ed4d515-97c612e0-ac834264"></brd-mark>

``` python
# bridge(Div('Hey, Bar!'), display_id=did, update=True)
dh = bridge.nbhooks.brdd.dh
brt_cli(Div('Hey, Bar!'), display_id=dh)
```

Use `display_id` and
[`update`](https://civvic.github.io/bridget/nb_hooks.html#update) kwargs
to modify or update an existing output cell.

# Bridget plugin

> A specialization of
> [`Bridge`](https://civvic.github.io/bridget/bridge.html#bridge) that
> connects HTMX with FastHTML in notebooks.

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridget.py#L242"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_bridget

>  get_bridget (app=None, logger:NBLogger|None=None, show_logger:bool=False,
>                   lnks:dict[str,FT]|None=None,
>                   esms:dict[str,str|Path]|None=None,
>                   plugins:Sequence[BridgePlugin]|None=None,
>                   kwplugins:dict[str,str]|None=None, wait:int=0,
>                   summary:bool=False, factory:Callable[...,Any]|None=None,
>                   timeout:float=10, sleep:float=0.2, n:int=10,
>                   show:Callable[[bool],None]|None=None, **kwargs)

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>app</td>
<td>NoneType</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>logger</td>
<td>NBLogger | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>show_logger</td>
<td>bool</td>
<td>False</td>
<td></td>
</tr>
<tr>
<td>lnks</td>
<td>dict[str, FT] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>esms</td>
<td>dict[str, str | Path] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>plugins</td>
<td>Sequence[BridgePlugin] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>kwplugins</td>
<td>dict[str, str] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>wait</td>
<td>int</td>
<td>0</td>
<td></td>
</tr>
<tr>
<td>summary</td>
<td>bool</td>
<td>False</td>
<td></td>
</tr>
<tr>
<td>factory</td>
<td>Callable[‚Ä¶, Any] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>timeout</td>
<td>float</td>
<td>10</td>
<td></td>
</tr>
<tr>
<td>sleep</td>
<td>float</td>
<td>0.2</td>
<td></td>
</tr>
<tr>
<td>n</td>
<td>int</td>
<td>10</td>
<td></td>
</tr>
<tr>
<td>show</td>
<td>Callable[[bool], None] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>kwargs</td>
<td>VAR_KEYWORD</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>Bridget</strong></td>
<td></td>
<td><strong>type: ignore</strong></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridget.py#L199"
target="_blank" style="float:right; font-size:smaller">source</a>

### Bridget

>  Bridget (app:fasthtml.core.FastHTML|None=None, *args, **kwargs)

*Inherit from this to have all attr accesses in `self._xtra` passed down
to `self.default`*

Bridget is a specialized widget that: 1. Inherits from `BridgeBase` for
FastHTML/display functionality 2. Uses
[AnyWidget](https://anywidget.dev/) tooling-free, general widget
solution, for browser-kernel communication 3. Implements a singleton
pattern to ensure one instance per notebook

Attributes: - `_esm`: Path to bundled JavaScript module -
`request`/`response`: Traitlets for HTMX communication -
`htmx`/`htmx_sels`: Configuration for HTMX integration

The core part is using the widget‚Äôs bidirectional communication to
replace HTMX‚Äôs HTTP transport: 1. Browser: HTMX makes requests thinking
it‚Äôs talking to a server 2. Widget: Captures these requests via
traitlets 3. Kernel: Processes requests using FastHTML routing 4.
Widget: Returns responses that HTMX understands

## Bridget JavaScript Implementation [bridget.js](bridget.js)

Bridget‚Äôs JavaScript code provides the browser-side implementation
that: 1. Intercepts HTMX AJAX requests (SSE, WS in the future) 2. Routes
them through the widget‚Äôs communication channel 3. Processes responses
back to HTMX 4. Manages HTMX initialization in notebook output cells

### Some details

#### Request Flow

1.  HTMX makes an AJAX request
2.  [xhook](https://github.com/jpillora/xhook/tree/main) intercepts it
    via `on_request`
3.  Request is serialized and sent to kernel via traitlets
4.  Kernel processes request and sends response
5.  Response is processed by `response_changed`
6.  HTMX receives response and updates DOM

#### HTMX Integration

1.  `BridgetObserver` watches for new notebook output cells
2.  New cells are processed with `htmx.process()`
3.  HTMX attributes become active
4.  AJAX requests are intercepted and routed through widget

Note that Bridget JS is backend agnostic. We‚Äôre using FastHTML here
because its the best for my quest of replacing ipywidgets as the main
form of interactivity in a notebook, but it could be any other backend
libarary.

# get_app

> Helper function to initialize the root-level app, bridget, and route.

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridget.py#L251"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_app

>  get_app (hooks=False, nb=False, cfg:Mapping|None=None,
>               logger:NBLogger|None=None, show_logger:bool=False,
>               lnks:dict[str,FT]|None=None, esms:dict[str,str|Path]|None=None,
>               plugins:Sequence[BridgePlugin]|None=None,
>               kwplugins:dict[str,str]|None=None, wait:int=0,
>               summary:bool=False, factory:Callable[...,Any]|None=None,
>               timeout:float=10, sleep:float=0.2, n:int=10,
>               show:Callable[[bool],None]|None=None, **kwargs)

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>hooks</td>
<td>bool</td>
<td>False</td>
<td></td>
</tr>
<tr>
<td>nb</td>
<td>bool</td>
<td>False</td>
<td></td>
</tr>
<tr>
<td>cfg</td>
<td>Mapping | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>logger</td>
<td>NBLogger | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>show_logger</td>
<td>bool</td>
<td>False</td>
<td></td>
</tr>
<tr>
<td>lnks</td>
<td>dict[str, FT] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>esms</td>
<td>dict[str, str | Path] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>plugins</td>
<td>Sequence[BridgePlugin] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>kwplugins</td>
<td>dict[str, str] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>wait</td>
<td>int</td>
<td>0</td>
<td></td>
</tr>
<tr>
<td>summary</td>
<td>bool</td>
<td>False</td>
<td></td>
</tr>
<tr>
<td>factory</td>
<td>Callable[‚Ä¶, Any] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>timeout</td>
<td>float</td>
<td>10</td>
<td></td>
</tr>
<tr>
<td>sleep</td>
<td>float</td>
<td>0.2</td>
<td></td>
</tr>
<tr>
<td>n</td>
<td>int</td>
<td>10</td>
<td></td>
</tr>
<tr>
<td>show</td>
<td>Callable[[bool], None] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>kwargs</td>
<td>VAR_KEYWORD</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>tuple[FastHTML, Bridget, MethodType]</strong></td>
<td></td>
<td><strong>type: ignore</strong></td>
</tr>
</tbody>
</table>

``` python
app, brt, rt = get_app(show_logger=True)
test_is(brt.app, app)
```

<div id='brd-logger_3-1764771735' class='brd-logger' style='width: 100%; max-height: 200px;'></div>
<brd-mark id="b82cbb022-7ce7730e-3c1204c4-6ef803a1"></brd-mark>

Let‚Äôs see Bridget in action.

``` python
def counter():
    n = 0
    @rt('/inc')
    def increment():
        nonlocal n
        n += 1
        return f"{n}"
    return Div()(
        Button(hx_get='/inc', hx_target='find span', hx_swap='textContent')(
            'Count: ', Span(f"{n}")))

counter()
```

``` html
<div>
<button hx-get="/inc" hx-swap="textContent" hx-target="find span">Count: <span>0</span></button></div>
```

``` python
# req = { 
#     "headers": { "HX-Request": "true", "HX-Current-URL": "vscode-webview://1ql27b0grt14rkuj26idbt9ktekivp44iu2s8pgfndvblm2j3iep/index.html?id=3d1cf833-fbc2-442d-885b-05f7dee12052&origin=1e95bb6a-280d-4f6e-8090-7f55f54cbfbd&swVersion=4&extensionId=&platform=electron&vscode-resource-base-authority=vscode-resource.vscode-cdn.net&parentOrigin=vscode-file%3A%2F%2Fvscode-app&purpose=notebookRenderer" }, 
#     "headerNames": { "hx-request": "HX-Request", "hx-current-url": "HX-Current-URL" }, 
#     "status": 0, "method": "GET", "url": "/inc", "async": True, "timeout": 0, "withCredentials": False, 
#     "body": None, 
#     "req_id": "652540cd-1ebe-4983-8701-88074dfe6328" }
```

``` python
# bridge._message_hdlr(None, {'ctx': 'bridget', 'kind': 'request', 'request': req}, None)
```

``` python
def random_hsl(saturation=50, lightness=90):
    hue = random.randint(0, 360)
    return f"hsl({hue} {saturation}% {lightness}%)"

def counter(n=0):
    @rt('/inc')
    def increment(n:int):
        return Button(f"Count: {n+1}", value=f"{n+1}", name='n', 
            hx_post='/inc', hx_swap='outerHTML', 
            style=f"background-color:{random_hsl()}; font-weight: bold")
    return increment(n-1)

counter()
```

``` html
<button value="0" name="n" hx-post="/inc" hx-swap="outerHTML" style="background-color:hsl(204 50% 90%); font-weight: bold">Count: 0</button>
```

``` python
@rt("/test")
def get():
    return Buttons()


html = Div()(
    H2('HTMX Test'),
    Div('Swapped DOM elements are styled instantly when they arrive.'),
    Buttons(),
)

# brt(html); # or simply, if bridge_cfg.auto_show is True:
html
```

``` html
<div>
  <h2>HTMX Test</h2>
  <div>Swapped DOM elements are styled instantly when they arrive.</div>
<button garlic hx-get="/test" hx-select="button[vampire]" hx-swap="afterend">
    <style>
    me { margin: 4px; padding: 10px 30px; min-width: 80px; background: hsl(264 80% 47%); border-bottom: 0.5rem solid hsl(264 80% 20%); }
    me { color: antiquewhite; font-size: 14pt; font-variant: all-small-caps; font-weight: bold; }
    me:hover { background: hsl(264 80% 60%); }
    me span.icon { font-size:16pt; }
</style>
garlic <span class="icon">üßÑ</span>
</button>
<button vampire hx-get="/test" hx-select="button[garlic]" hx-swap="afterend">
    <style>
    me { margin: 4px; padding: 10px 30px; min-width: 80px; background: hsl(150 80% 47%); border-bottom: 0.5rem solid hsl(264 80% 20%); }
    me { color: antiquewhite; font-size: 14pt; font-variant: all-small-caps; font-weight: bold; }
    me:hover { background: hsl(150 80% 60%); }
    me span.icon { font-size:16pt; }
</style>
vampire <span class="icon">üßõ</span>
</button>
</div>
```

An example from [gnat](https://github.com/gnat)‚Äôs
[css-scope-inline](https://github.com/gnat/css-scope-inline). Click the
buttons.

See [40_details_json.ipynb](40_details_json.ipynb) for a lazy JSON
browser.

<div>

> **Why are my output cells un-styled and/or inactive?**
>
> Because all changes made with Bridge/Bridget/FastHTML/HTMX are
> **transient**.

</div>

Let‚Äôs talk about what‚Äôs happening under the hood:

We‚Äôre modifying the DOM - the HTML structure in your browser - at
runtime. This is **not** a notebook editor; it‚Äôs a runtime tool. For
anything to work, you need to execute the cells.

Here‚Äôs the thing: a notebook is just **JSON**. Ultimately, output cells
are just HTML (derived from any IPython displayable object),
environments like VSCode won‚Äôt render them until display time.

When you open a notebook, tjhe front-end usually takes a lazy approach
(VSCode/Cursor more than others): - It renders existing outputs from the
JSON (including JavaScript) - But it won‚Äôt execute any cells
automatically - Even ipywidgets get special (and sometimes quirky)
treatment

Think of the notebook‚Äôs JSON as a snapshot from when you ran the cells.
Any DOM changes we make don‚Äôt get saved back to this JSON.

This means: 1. Bridge needs explicit initialization to load its JS/CSS
2. On load, saved notebooks will execute the JavaScript/HTML put there
by cell runs 3. Kernel-side code won‚Äôt run until you execute the cells

Could we make Bridget modify the actual notebook outputs? Technically,
yes, maybe. But given the labyrinthine complexity of the Jupyter
ecosystem (and the mountains of JavaScript involved), I get a headache
just thinking about it. Some mountains are better left unclimbed! üòÖ

# Simple widget

``` python
class BWidget(T.HasTraits, RouteProvider):
    bridget: Bridget = None  # type: ignore
    _mounted = False
    def __ft__(self): ...
    def _ipython_display_(self):
        brt = get_bridget()
        if bridge_cfg.auto_mount and not self._mounted: brt.mount(self, show=False)
        brt(self);
```

``` python
class BValue(BWidget):
    value=T.CInt(0).tag(sync=True)
    _updating = False
    
    def wrapper_id(self): return self.ar.name().replace(':', '_')

    @contextmanager
    def _update_ctx(self):
        self._updating = True
        yield
        self._updating = False

    @T.observe('value')
    def on_value(self, _):
        if self.bridget and not self._updating:
            self.bridget.bridge.commander.swap(f"#{self.wrapper_id()}", to_xml(self.__ft__()), swapStyle='innerHTML')

    @ar.post('/value')  # type: ignore
    def changed(self, value:int):
        with self._update_ctx(): self.value = value
        return str(value)
```

``` python
@dataclasses.dataclass
class BIntSlider(BValue):
    min:int=0; max:int=100; step:int=1; readout:bool=True; readout_format:str='d'
    
    def __ft__(self):
        if bridge_cfg.auto_mount and not self._mounted: get_bridget().mount(self, show=False)
        return Div(id=self.wrapper_id(), cls='bridget slider')(
            Label(_for='value')('Scale'), _n,
            Input(type='range', name='value', min=self.min, max=self.max, step=self.step, value=self.value,
                # hx_post=f"{self.ar.to()}{self.ar.to('changed')}", hx_trigger='input changed', 
                hx_post=self.ar.to('changed'), hx_trigger='input changed', 
                hx_target='next text', hx_swap='textContent'),
            Text(id='spanscale', style='inline')(self.value), _n
        )

app.routes.clear()

bridge_cfg.auto_mount = True

rp = BIntSlider()
rp
```

<div id="BIntSlider_BIntSlider_1-1764771735" class="bridget slider">
<label for="value">Scale</label>
  <input type="range" name="value" max="100" step="1" hx-post="/BIntSlider/BIntSlider_1-1764771735/value" hx-trigger="input changed" hx-swap="textContent" hx-target="next text">
<text id="spanscale" style="inline">0</text>
</div>
&#10;<brd-mark id="c0c8a3c073e580b183c452529904098c"></brd-mark>

``` python
rp.value = 77
```

``` python
sld2 = BIntSlider(step=2)
sld2
```

<div id="BIntSlider_BIntSlider_2-1764771735" class="bridget slider">
<label for="value">Scale</label>
  <input type="range" name="value" max="100" step="2" hx-post="/BIntSlider/BIntSlider_2-1764771735/value" hx-trigger="input changed" hx-swap="textContent" hx-target="next text">
<text id="spanscale" style="inline">0</text>
</div>
&#10;<brd-mark id="9c0c00adbf5745d30e23162c6a1be863"></brd-mark>

``` python
with bridge_cfg(auto_mount=True):
    sld3 = BIntSlider()
    sld4 = BIntSlider()
    # brt.mount(sld3, show=False)
    # brt.mount(sld4, show=False)
    T.link((sld3, 'value'), (sld4, 'value'))

(box := Div(style='display: flex; gap: 1em;')(sld3, sld4))
```

``` html
<div style="display: flex; gap: 1em;">
  <div id="BIntSlider_BIntSlider_3-1764771735" class="bridget slider">
<label for="value">Scale</label>
    <input type="range" name="value" max="100" step="1" hx-post="/BIntSlider/BIntSlider_3-1764771735/value" hx-trigger="input changed" hx-swap="textContent" hx-target="next text">
<text id="spanscale" style="inline">0</text>
  </div>
  <div id="BIntSlider_BIntSlider_4-1764771735" class="bridget slider">
<label for="value">Scale</label>
    <input type="range" name="value" max="100" step="1" hx-post="/BIntSlider/BIntSlider_4-1764771735/value" hx-trigger="input changed" hx-swap="textContent" hx-target="next text">
<text id="spanscale" style="inline">0</text>
  </div>
</div>
```

``` python
sld3.value = 22
test_eq(sld4.value, 22)
```

# Hydrate (TBD)

> Can we edit `.ipynb`s directly to capture actual output without
> `nbformat` or editing the JSON in disk?

``` python
# def hydrate(bridget=True, app: FastHTML | None=None, appkw:dict[str, Any]={}, **kwargs): 
#     app, bridge, rt = get_app(True, app, appkw=appkw, **kwargs)
#     bridget = Bridget(bridge) if bridget else None
#     return app, bridge, rt, bridget

# hydrate()
```

# What about WebSockets and SSE Support?

While HTMX supports WebSockets and Server-Sent Events (SSE) through
extensions([1](https://htmx.org/docs/#web-sockets-sse)), this
proof-of-concept focuses only on AJAX functionality for several reasons:

1.  **Core Functionality**: HTMX is primarily an AJAX framework - WS and
    SSE support are add-ons with simpler
    implementations([2](https://htmx.org/docs/#extensions))

2.  **Proof of Concept**: For demonstrating the viability of using HTMX
    in notebooks, AJAX support is sufficient

3.  **Future Extension**: Adding WS/SSE support would be straightforward
    since:

    - The notebook Comm layer already uses WebSockets
    - HTMX‚Äôs extension system is
      well-documented([3](https://htmx.org/docs/#creating-extensions))
    - The transport layer replacement pattern is already established
      with AJAX

------------------------------------------------------------------------

<!-- # Colophon -->
