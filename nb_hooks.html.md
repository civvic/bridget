# Notebook/IPython hooks


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

<!-- # Prologue -->

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/nb_hooks.py#L49"
target="_blank" style="float:right; font-size:smaller">source</a>

### cellspec_from

>  cellspec_from (s)

``` python
nburi, cellid = cellspec_from('/a/b/d#Y114sZmlsZQ==')
nburi, cellid
```

    ('/a/b/d', 'Y114sZmlsZQ==')

VSCode cell id format.

# NB update

``` python
__nb__ = NB()
```

``` python
nb = NB()
nb.update(cell_id='abc', source='print(1)')  # type: ignore
test_eq(nb[0].source, 'print(1)')
```

``` python
def _update_cell(cell_id, source=None, exec_result=None):
    upd = {'execution_count': exec_result.execution_count} if exec_result else {}
    if source is not None: upd['source'] = source
    __nb__.update(cell_id, **upd, outputs=_get_outputs(exec_result))  # type: ignore
```

# CellExecInfo

> IPython cell execution info and \_\_nb\_\_ updater.

Simple IPython event callback that captures cell id and source code of
last run cell.

**NOTE**: in this notebook, \_\_nb\_\_ is *NOT* a valid notebook state
yet. It doesnâ€™t reflect markdown cells or deleted cells or cells order.
For a valid, updated in real-time, `nbformat` compliant notebook state
([`NB`](https://civvic.github.io/bridget/nb.html#nb)), see
[21_nb_state.ipynb](21_nb_state.ipynb).

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/nb_hooks.py#L135"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_csi

>  get_csi (start=False)

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/nb_hooks.py#L132"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_lastinfo

>  get_lastinfo ()

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/nb_hooks.py#L131"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_info

>  get_info ()

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/nb_hooks.py#L78"
target="_blank" style="float:right; font-size:smaller">source</a>

### CellExecInfo

>  CellExecInfo (start=False)

*Initialize self. See help(type(self)) for accurate signature.*

``` python
try: csi.stop()  # type: ignore
except Exception: pass

csi = get_csi(True)
test_eq(__cellinfo__, {})
test_eq(__lastcellinfo__, None)
```

``` python
show(DetailsJSON(__cellinfo__))
test_eq(__cellinfo__.source[:29], "show(DetailsJSON(__cellinfo__")
show(DetailsJSON(__nb__[0]))
17
```

<style>details ul { list-style-type:none; list-style-position: outside; padding-inline-start: 22px; margin: 0; } details .string { color: #24837b; } details .string::before { content: "'"; } details .string::after { content: "'"; } details .number { color: #ad8301; } details .true { color: blue; } details .false { color: red; } details .null { color: gray; } span.n { color: darkgrey; } </style>
<details open><summary>summary
</summary>  <ul>
    <li>
<span><span class="n">source</span>: <span class="v string">show(DetailsJSON(__cellinfo__))
test_eq(__cellinfo__.source[:29], &quot;show(DetailsJSON(__cellinfo__&quot;)
show(DetailsJSON(__nb__[0]))
17</span></span>    </li>
    <li>
<span><span class="n">cell_id</span>: <span class="v string">X35sZmlsZQ==</span></span>    </li>
<details><summary>exec_result
</summary>      <ul>
        <li>
<span><span class="n">result</span>: <span class="v null">None</span></span>        </li>
      </ul>
</details>  </ul>
</details>

<style>details ul { list-style-type:none; list-style-position: outside; padding-inline-start: 22px; margin: 0; } details .string { color: #24837b; } details .string::before { content: "'"; } details .string::after { content: "'"; } details .number { color: #ad8301; } details .true { color: blue; } details .false { color: red; } details .null { color: gray; } span.n { color: darkgrey; } </style>
<details open><summary>summary
</summary>  <ul>
    <li>
<span><span class="n">idx</span>: <span class="v number">0</span></span>    </li>
    <li>
<span><span class="n">source</span>: <span class="v string">show(DetailsJSON(__cellinfo__))
test_eq(__cellinfo__.source[:29], &quot;show(DetailsJSON(__cellinfo__&quot;)
show(DetailsJSON(__nb__[0]))
17</span></span>    </li>
    <li>
<span><span class="n">id</span>: <span class="v string">X35sZmlsZQ==</span></span>    </li>
    <li>
<span><span class="n">cell_type</span>: <span class="v string">code</span></span>    </li>
<details><summary>outputs
</summary>      <ul></ul>
</details>  </ul>
</details>

    17

``` python
show(DetailsJSON(__lastcellinfo__, openall=True))
show(__nb__[__lastcellinfo__.cell_id])
```

<style>details ul { list-style-type:none; list-style-position: outside; padding-inline-start: 22px; margin: 0; } details .string { color: #24837b; } details .string::before { content: "'"; } details .string::after { content: "'"; } details .number { color: #ad8301; } details .true { color: blue; } details .false { color: red; } details .null { color: gray; } span.n { color: darkgrey; } </style>
<details open><summary>summary
</summary>  <ul>
    <li>
<span><span class="n">source</span>: <span class="v string">show(DetailsJSON(__cellinfo__))
test_eq(__cellinfo__.source[:29], &quot;show(DetailsJSON(__cellinfo__&quot;)
show(DetailsJSON(__nb__[0]))
17</span></span>    </li>
    <li>
<span><span class="n">cell_id</span>: <span class="v string">X35sZmlsZQ==</span></span>    </li>
<details open><summary>exec_result
</summary>      <ul>
        <li>
<span><span class="n">result</span>: <span class="v number">17</span></span>        </li>
        <li>
<span><span class="n">execution_count</span>: <span class="v number">22</span></span>        </li>
        <li>
<span><span class="n">error_before_exec</span>: <span class="v null">None</span></span>        </li>
        <li>
<span><span class="n">error_in_exec</span>: <span class="v null">None</span></span>        </li>
      </ul>
</details>  </ul>
</details>

<style>details ul { list-style-type:none; list-style-position: outside; padding-inline-start: 22px; margin: 0; } details .string { color: #24837b; } details .string::before { content: "'"; } details .string::after { content: "'"; } details .number { color: #ad8301; } details .true { color: blue; } details .false { color: red; } details .null { color: gray; } span.n { color: darkgrey; } </style>
<details open><summary>summary
</summary>  <ul>
    <li>
<span><span class="n">idx</span>: <span class="v number">0</span></span>    </li>
    <li>
<span><span class="n">source</span>: <span class="v string">show(DetailsJSON(__cellinfo__))
test_eq(__cellinfo__.source[:29], &quot;show(DetailsJSON(__cellinfo__&quot;)
show(DetailsJSON(__nb__[0]))
17</span></span>    </li>
    <li>
<span><span class="n">id</span>: <span class="v string">X35sZmlsZQ==</span></span>    </li>
    <li>
<span><span class="n">cell_type</span>: <span class="v string">code</span></span>    </li>
<details open><summary>outputs
</summary>      <ul>
<details open><summary>0
</summary>          <ul>
            <li>
<span><span class="n">output_type</span>: <span class="v string">execute_result</span></span>            </li>
            <li>
<span><span class="n">execution_count</span>: <span class="v number">22</span></span>            </li>
<details open><summary>data
</summary>              <ul>
                <li>
<span><span class="n">text/plain</span>: <span class="v string">17</span></span>                </li>
              </ul>
</details><details open><summary>metadata
</summary>              <ul></ul>
</details>          </ul>
</details>      </ul>
</details>    <li>
<span><span class="n">execution_count</span>: <span class="v number">22</span></span>    </li>
  </ul>
</details>

`__cellinfo__` stores information about **current** cell execution,
`interactiveshell.ExecutionInfo`. `__cellinfo__.exec_result` stores the
result of the cell execution, `interactiveshell.ExecutionResult`, only
valid **after** the cell run.

``` python
(ri := random.randint(0, sys.maxsize))
```

    540056390924159495

``` python
show(DetailsJSON(__cellinfo__))
show(DetailsJSON(__lastcellinfo__, openall=True))
show(__nb__[__lastcellinfo__.cell_id])
test_eq(__lastcellinfo__.source, "(ri := random.randint(0, sys.maxsize))")
```

<style>details ul { list-style-type:none; list-style-position: outside; padding-inline-start: 22px; margin: 0; } details .string { color: #24837b; } details .string::before { content: "'"; } details .string::after { content: "'"; } details .number { color: #ad8301; } details .true { color: blue; } details .false { color: red; } details .null { color: gray; } span.n { color: darkgrey; } </style>
<details open><summary>summary
</summary>  <ul>
    <li>
<span><span class="n">source</span>: <span class="v string">show(DetailsJSON(__cellinfo__))
show(DetailsJSON(__lastcellinfo__, openall=True))
show(__nb__[__lastcellinfo__.cell_id])
test_eq(__lastcelliâ€¦</span></span>    </li>
    <li>
<span><span class="n">cell_id</span>: <span class="v string">X42sZmlsZQ==</span></span>    </li>
<details><summary>exec_result
</summary>      <ul>
        <li>
<span><span class="n">result</span>: <span class="v null">None</span></span>        </li>
      </ul>
</details>  </ul>
</details>

<style>details ul { list-style-type:none; list-style-position: outside; padding-inline-start: 22px; margin: 0; } details .string { color: #24837b; } details .string::before { content: "'"; } details .string::after { content: "'"; } details .number { color: #ad8301; } details .true { color: blue; } details .false { color: red; } details .null { color: gray; } span.n { color: darkgrey; } </style>
<details open><summary>summary
</summary>  <ul>
    <li>
<span><span class="n">source</span>: <span class="v string">(ri := random.randint(0, sys.maxsize))</span></span>    </li>
    <li>
<span><span class="n">cell_id</span>: <span class="v string">X41sZmlsZQ==</span></span>    </li>
<details open><summary>exec_result
</summary>      <ul>
        <li>
<span><span class="n">result</span>: <span class="v number">540056390924159495</span></span>        </li>
        <li>
<span><span class="n">execution_count</span>: <span class="v number">24</span></span>        </li>
        <li>
<span><span class="n">error_before_exec</span>: <span class="v null">None</span></span>        </li>
        <li>
<span><span class="n">error_in_exec</span>: <span class="v null">None</span></span>        </li>
      </ul>
</details>  </ul>
</details>

<style>details ul { list-style-type:none; list-style-position: outside; padding-inline-start: 22px; margin: 0; } details .string { color: #24837b; } details .string::before { content: "'"; } details .string::after { content: "'"; } details .number { color: #ad8301; } details .true { color: blue; } details .false { color: red; } details .null { color: gray; } span.n { color: darkgrey; } </style>
<details open><summary>summary
</summary>  <ul>
    <li>
<span><span class="n">idx</span>: <span class="v number">2</span></span>    </li>
    <li>
<span><span class="n">source</span>: <span class="v string">(ri := random.randint(0, sys.maxsize))</span></span>    </li>
    <li>
<span><span class="n">id</span>: <span class="v string">X41sZmlsZQ==</span></span>    </li>
    <li>
<span><span class="n">cell_type</span>: <span class="v string">code</span></span>    </li>
<details open><summary>outputs
</summary>      <ul>
<details open><summary>0
</summary>          <ul>
            <li>
<span><span class="n">output_type</span>: <span class="v string">execute_result</span></span>            </li>
            <li>
<span><span class="n">execution_count</span>: <span class="v number">24</span></span>            </li>
<details open><summary>data
</summary>              <ul>
                <li>
<span><span class="n">text/plain</span>: <span class="v string">540056390924159495</span></span>                </li>
              </ul>
</details><details open><summary>metadata
</summary>              <ul></ul>
</details>          </ul>
</details>      </ul>
</details>    <li>
<span><span class="n">execution_count</span>: <span class="v number">24</span></span>    </li>
  </ul>
</details>

``` python
print(__cellinfo__.cell_id)
test_eq(__cellinfo__.source[:27], "print(__cellinfo__.cell_id)")
test_eq(In[-1][:27], "print(__cellinfo__.cell_id)")
(exe_cnt := len(In)-1)
```

    X43sZmlsZQ==

    26

``` python
print(_, __lastcellinfo__.exec_result.result)
test_eq(_, __lastcellinfo__.exec_result.result)
test_eq(__lastcellinfo__.exec_result.result, Out[exe_cnt])
```

    26 26

``` python
display('abc')
```

    'abc'

``` python
print(_, __lastcellinfo__.exec_result.result)
test_eq(None, __lastcellinfo__.exec_result.result)
```

    26 None

``` python
print('13')
23
```

    13

    23

``` python
print(_, __lastcellinfo__.exec_result.result)
test_eq(23, __lastcellinfo__.exec_result.result)
```

    23 23

``` python
csi.stop()
test_is(__cellinfo__, None)
test_is(__lastcellinfo__, None)
```

`__cellinfo__.source` corresponds to `In[-1]` or `_ih[-1]`.  
`__lastcellinfo__.exec_result.result` corresponds to `_` or
`Out[__lastcellinfo__.exec_result.execution_count]`.

<s>But we donâ€™t want the result of the last cell, we want the result of
the current cell. For that, keep reading.</s>

**Caveat**: the front-end is not required to send the cell id. See
[nbformat Cell
ids](https://nbformat.readthedocs.io/en/latest/format_description.html#cell-ids),
[run_cell](https://ipython.readthedocs.io/en/stable/api/generated/IPython.core.interactiveshell.html#IPython.core.interactiveshell.InteractiveShell.run_cell).  
`VSCode` reports nbformat of newly created notebook as 4.4, but it does
send the cell id, though not well formed.  
`nbclassic` does not set the cell ID even if the reported nbformat
version is 4.5. Bridget creates one in this case.

``` python
for c in __nb__.cells: display(c)
```

> code

``` json
{
  'idx': 0,
  'source': 'show(DetailsJSON(__cellinfo__))\ntest_eq(__cellinfo__.source[:29], "show(DetailsJSON(__cellinfo__")\nshow(DetailsJSON(__nb__[0]))\n17',
  'id': 'X35sZmlsZQ==',
  'cell_type': 'code',
  'outputs': [{'output_type': 'execute_result', 'execution_count': 22, 'data': {'text/plain': '17'}, 'metadata': {}}],
  'execution_count': 22
}
```

> code

``` json
{
  'idx': 1,
  'source': 'show(DetailsJSON(__lastcellinfo__, openall=True))\nshow(__nb__[__lastcellinfo__.cell_id])',
  'id': 'X36sZmlsZQ==',
  'cell_type': 'code',
  'outputs': [],
  'execution_count': 23
}
```

> code

``` json
{
  'idx': 2,
  'source': '(ri := random.randint(0, sys.maxsize))',
  'id': 'X41sZmlsZQ==',
  'cell_type': 'code',
  'outputs': [
    {
      'output_type': 'execute_result',
      'execution_count': 24,
      'data': {'text/plain': '540056390924159495'},
      'metadata': {}
    }
  ],
  'execution_count': 24
}
```

> code

``` json
{
  'idx': 3,
  'source': 'show(DetailsJSON(__cellinfo__))\nshow(DetailsJSON(__lastcellinfo__, openall=True))\nshow(__nb__[__lastcellinfo__.cell_id])\ntest_eq(__lastcellinfo__.source, "(ri := random.randint(0, sys.maxsize))")',
  'id': 'X42sZmlsZQ==',
  'cell_type': 'code',
  'outputs': [],
  'execution_count': 25
}
```

> code

``` json
{
  'idx': 4,
  'source': 'print(__cellinfo__.cell_id)\ntest_eq(__cellinfo__.source[:27], "print(__cellinfo__.cell_id)")\ntest_eq(In[-1][:27], "print(__cellinfo__.cell_id)")\n(exe_cnt := len(In)-1)',
  'id': 'X43sZmlsZQ==',
  'cell_type': 'code',
  'outputs': [{'output_type': 'execute_result', 'execution_count': 26, 'data': {'text/plain': '26'}, 'metadata': {}}],
  'execution_count': 26
}
```

> code

``` json
{
  'idx': 5,
  'source': 'print(_, __lastcellinfo__.exec_result.result)\ntest_eq(_, __lastcellinfo__.exec_result.result)\ntest_eq(__lastcellinfo__.exec_result.result, Out[exe_cnt])',
  'id': 'X44sZmlsZQ==',
  'cell_type': 'code',
  'outputs': [],
  'execution_count': 27
}
```

> code

``` json
{'idx': 6, 'source': "display('abc')", 'id': 'X45sZmlsZQ==', 'cell_type': 'code', 'outputs': [], 'execution_count': 28}
```

> code

``` json
{
  'idx': 7,
  'source': 'print(_, __lastcellinfo__.exec_result.result)\ntest_eq(None, __lastcellinfo__.exec_result.result)',
  'id': 'X46sZmlsZQ==',
  'cell_type': 'code',
  'outputs': [],
  'execution_count': 29
}
```

> code

``` json
{
  'idx': 8,
  'source': "print('13')\n23",
  'id': 'X50sZmlsZQ==',
  'cell_type': 'code',
  'outputs': [{'output_type': 'execute_result', 'execution_count': 30, 'data': {'text/plain': '23'}, 'metadata': {}}],
  'execution_count': 30
}
```

> code

``` json
{
  'idx': 9,
  'source': 'print(_, __lastcellinfo__.exec_result.result)\ntest_eq(23, __lastcellinfo__.exec_result.result)',
  'id': 'X51sZmlsZQ==',
  'cell_type': 'code',
  'outputs': [],
  'execution_count': 31
}
```

> code

``` json
{
  'idx': 10,
  'source': 'csi.stop()\ntest_is(__cellinfo__, None)\ntest_is(__lastcellinfo__, None)',
  'id': 'X52sZmlsZQ==',
  'cell_type': 'code',
  'outputs': []
}
```

# autoid (not used)

Note: `autoid` here is different from fasthtml `fh_cfg['auto_id']`
option. Here weâ€™re trying to automatically set the `id` attribute of the
wrapper element of a cell output in the front-end. If we can do so,
weâ€™ll be able to target especific cell outputs.

``` python
__autoid_scr = '''
// debugger;
me().attribute('id', 'output-{0}').classAdd('bridge');
setTimeout(el => {{ el.remove(); }}, 100, me('#{0}'))
'''
def autoid(idx=None):
    idx = idx or new_id()
    return Script(__autoid_scr.format(idx), id=idx), idx
```

``` python
scr, idx = autoid()
dhdl = DisplayHandle(idx)
dhdl.display(HTML('bbbb'+to_xml(scr)))
```

cccc<script id="bcb4f211e-336de341-ec353dce-3dc21ce3">
// debugger;
me().attribute('id', 'output-bcb4f211e-336de341-ec353dce-3dc21ce3').classAdd('bridge');
setTimeout(el => { el.remove(); }, 100, me('#bcb4f211e-336de341-ec353dce-3dc21ce3'))
</script>

Inspect â€œbbbbâ€ output of previous cell, the parent element should have
class â€œbridgeâ€ and id.

``` python
dhdl.update(HTML('cccc'+to_xml(scr)))
```

VSCode wipe out the element when updating the cell. We need to send
again the autoid.

## DisplayId

An attempt to provide a IPython display wrapper that automatically
handles the display ID to allow us to target especific cells. Not
working, for now itâ€™s essentially just IPython display.

``` python
class DisplayId(DisplayHandle):
    def __init__(self, display_id=None):
        super().__init__(display_id or new_id())
        self._contents = None
        self._sc = to_xml(autoid(self.display_id)[0]) if bridge_cfg.auto_id else ''

    def display(self, obj='', **kwargs):
        self._contents = str(obj)
        IDISPLAY(HTML(self._contents + self._sc), display_id=self.display_id, **kwargs)

    def update(self, obj='', **kwargs):
        kwargs['update'] = True
        self.display(obj, **kwargs)

    def contents(self): return self._contents
```

``` python
dhdl = DisplayId()
dhdl.display('dddd')
test_eq(dhdl.contents(), 'dddd')
```

``` python
dhdl.update('eeee')
test_eq(dhdl.contents(), 'eeee')
```

``` python
dhdl.update()
```

# Bridged: IPython display_pub hook

> `display_pub` hook for `display_id` and `brd-mark`  
> Tag cell outputs with bridge metadata to target them.

In particular, it will transform every [display
message](https://github.com/ipython/ipython/blob/6c8484878fd186dafaf344b8af467e646e91827d/IPython/core/display_functions.py#L85)
to
[transient](https://jupyter-client.readthedocs.io/en/stable/messaging.html#update-display-data)
if the message has a session metadata id (`brd_did`). It will set the
`display_id` of each output with that same `brd_id` value. For HTML
display objects, it also marks the DOM parent element in the front-end.
With this (session unique) tag, we can easily address specific outputs
from Python.

This will be handy to target specific cell outputs when we can capture
the notebook state down the road.

NOTE: `display_pub` hooks are [thread
dependent](https://github.com/ipython/ipykernel/blob/8322a7684b004ee95f07b2f86f61e28146a5996d/ipykernel/zmqshell.py#L75).
Here we assume we only set the hook from the main thread.

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/nb_hooks.py#L223"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_bridged

>  get_bridged (start=False)

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/nb_hooks.py#L160"
target="_blank" style="float:right; font-size:smaller">source</a>

### Bridged

>  Bridged (start=False)

*Augment display messages with bridge stuff.*

``` python
try: 
    get_csi().stop()
    brdd.stop()  # type: ignore
except Exception: pass

__nb__ = NB()  # type: ignore

bridge_cfg.auto_id = False
brdd = get_bridged(True)
```

### set display_id with display object metadata

``` json
{
    ...,
    'msg_type': 'display_data',
    'content': {
        'data': {
            'text/plain': '<IPython.core.display.HTML object>', 
            'text/html': "<div>I'm marked!... MAAARKED!!</div>"
        },
        'metadata': {'text/html': {'brd_did': 'b8b568b9a-c02e1576-c3a3c120-167cedda'}},
        'transient': {}
    },
    'metadata': {}
}

{
    ...,
    'msg_type': 'display_data',
    'content': {
        'data': {
            'text/plain': '<IPython.core.display.HTML object>',
            'text/html': '<div>I\'m marked!... MAAARKED!!</div><brd-mark id="b8b568b9a-c02e1576-c3a3c120-167cedda"></brd-mark>'
        },
        'metadata': {'text/html': {'brd_did': 'b8b568b9a-c02e1576-c3a3c120-167cedda'}},
        'transient': {'display_id': 'b8b568b9a-c02e1576-c3a3c120-167cedda'}
    },
    'metadata': {}
}
```

``` python
did = new_id()
print(f"{did=}")
display(HTML("<div>I'm marked!... MAAARKED!!</div>", metadata={'brd_did': did}))
info = __cellinfo__; cell1  = __nb__[info.cell_id]; cell1_copy = cell1.copy()
test_eq(cell1.dids, [did])  # NOTE: this is only valid after the `display(...)` call in above line
21
```

    did='b595555a9-c867f02c-47d4b361-005ec7c4'

<div>I'm doomed!... DOOOOOMED!!</div>
<brd-mark id="b595555a9-c867f02c-47d4b361-005ec7c4"></brd-mark>

    21

``` python
display(cell1_copy)
cell1
```

> code

``` json
{
  'idx': 0,
  'source': 'did = new_id()\nprint(f"{did=}")\ndisplay(HTML("<div>I\'m marked!... MAAARKED!!</div>", metadata={\'brd_did\': did}))\ninfo = __cellinfo__; cell1  = __nb__[info.cell_id]; cell1_copy = cell1.copy()\ntest_eq(cell1.dids, [did])  # NOTE: this is only valid after the `display(...)` call in above line\n21',
  'id': 'Y120sZmlsZQ==',
  'cell_type': 'code',
  'outputs': [
    {
      'output_type': 'display_data',
      'data': {
        'text/plain': '<IPython.core.display.HTML object>',
        'text/html': '<div>I\'m marked!... MAAARKED!!</div>\n<brd-mark id="b595555a9-c867f02c-47d4b361-005ec7c4"></brd-mark>'
      },
      'metadata': {'brd_did': 'b595555a9-c867f02c-47d4b361-005ec7c4'}
    }
  ]
}
```

> code

``` json
{
  'idx': 0,
  'source': 'did = new_id()\nprint(f"{did=}")\ndisplay(HTML("<div>I\'m marked!... MAAARKED!!</div>", metadata={\'brd_did\': did}))\ninfo = __cellinfo__; cell1  = __nb__[info.cell_id]; cell1_copy = cell1.copy()\ntest_eq(cell1.dids, [did])  # NOTE: this is only valid after the `display(...)` call in above line\n21',
  'id': 'Y120sZmlsZQ==',
  'cell_type': 'code',
  'outputs': [
    {
      'output_type': 'display_data',
      'data': {
        'text/plain': '<IPython.core.display.HTML object>',
        'text/html': '<div>I\'m marked!... MAAARKED!!</div>\n<brd-mark id="b595555a9-c867f02c-47d4b361-005ec7c4"></brd-mark>'
      },
      'metadata': {'brd_did': 'b595555a9-c867f02c-47d4b361-005ec7c4'}
    },
    {'output_type': 'execute_result', 'execution_count': 50, 'data': {'text/plain': '21'}, 'metadata': {}}
  ],
  'execution_count': 50
}
```

At cell runtime, current cell can be accesed as
`__nb__[__cellinfo__.cell_id]`; after cell execution, it can be accesed
as `__nb__[__lastcellinfo__.cell_id]`.

Note [`NBCell`](https://civvic.github.io/bridget/nb.html#nbcell)
instance lifecycle: - Before code execution: an instance is created with
`source` and `id` - After
[`display`](https://civvic.github.io/bridget/helpers.html#display)
statement: the instance is updated with `display_data` output - After
cell run: the instance is updated with `execute_result` output

``` python
test_is('<div>I\'m marked!... MAAARKED!!</div>' in cell1.outputs[0]['data']['text/html'], True)
dh = brdd.dhs[-1]
test_eq(dh.display_id, did)
```

For convenience,
[`Bridged`](https://civvic.github.io/bridget/nb_hooks.html#bridged)
stores in `dhs` the last display handles used.

``` json
{
    ...,
    'msg_type': 'update_display_data',
    'content': {
        'data': {
            'text/plain': '<IPython.core.display.HTML object>', 
            'text/html': "<div>I'm doomed!... DOOOOOMED!!</div>"},
        'metadata': {},
        'transient': {'display_id': 'b5c00d851-9da4a95e-36473c24-3d04534d'}
    },
    'metadata': {}
}

{
    ...,
    'msg_type': 'update_display_data',
    'content': {
        'data': {
            'text/plain': '<IPython.core.display.HTML object>',
            'text/html': '<div>I\'m doomed!... DOOOOOMED!!</div><brd-mark id="b5c00d851-9da4a95e-36473c24-3d04534d"></brd-mark>'
        },
        'metadata': {},
        'transient': {'display_id': 'b5c00d851-9da4a95e-36473c24-3d04534d'}
    },
    'metadata': {}
}
```

``` python
dh.update(HTML("<div>I'm doomed!... DOOOOOMED!!</div>"))
cell2 = __nb__[__cellinfo__.cell_id]
test_is(hasattr(cell2, 'did'), False)
htmls = vals_at(cell1, 'outputs.*.data.text/html', True)
test_is(any('MAAARKED' in v for v in htmls), False)
test_is(any('DOOOOOMED' in v for v in htmls), True)
```

``` python
display(cell1)
cell2
```

> code

``` json
{
  'idx': 0,
  'source': 'did = new_id()\nprint(f"{did=}")\ndisplay(HTML("<div>I\'m marked!... MAAARKED!!</div>", metadata={\'brd_did\': did}))\ninfo = __cellinfo__; cell1  = __nb__[info.cell_id]; cell1_copy = cell1.copy()\ntest_eq(cell1.dids, [did])  # NOTE: this is only valid after the `display(...)` call in above line\n21',
  'id': 'Y120sZmlsZQ==',
  'cell_type': 'code',
  'outputs': [
    {
      'output_type': 'display_data',
      'data': {
        'text/plain': '<IPython.core.display.HTML object>',
        'text/html': '<div>I\'m doomed!... DOOOOOMED!!</div>\n<brd-mark id="b595555a9-c867f02c-47d4b361-005ec7c4"></brd-mark>'
      },
      'metadata': {'brd_did': 'b595555a9-c867f02c-47d4b361-005ec7c4'}
    },
    {'output_type': 'execute_result', 'execution_count': 50, 'data': {'text/plain': '21'}, 'metadata': {}}
  ],
  'execution_count': 50
}
```

> code

``` json
{
  'idx': 3,
  'source': 'dh.update(HTML("<div>I\'m doomed!... DOOOOOMED!!</div>"))\ncell2 = __nb__[__cellinfo__.cell_id]\ntest_is(hasattr(cell2, \'did\'), False)\nhtmls = vals_at(cell1, \'outputs.*.data.text/html\', True)\ntest_is(any(\'MAAARKED\' in v for v in htmls), False)\ntest_is(any(\'DOOOOOMED\' in v for v in htmls), True)',
  'id': 'Y126sZmlsZQ==',
  'cell_type': 'code',
  'outputs': [],
  'execution_count': 53
}
```

## set display_id with display call metadata

> i.e., `display(..., display_id=True)` or
> `display(..., display_id="...")`

``` python
dh = display(HTML("<div>I'm marked!... MAAARKED!!</div>"), display_id=True)
cell = __nb__[__cellinfo__.cell_id]
test_eq(at(cell, 'outputs.0.metadata.brd_did'), brdd.dh.display_id)  # type: ignore
cell
```

<div>I'm doomed!... DOOOOOMED!!</div>
<brd-mark id="e2ffaa8dc80ef2623bc8eb433633f96a"></brd-mark>

> code

``` json
{
  'idx': 5,
  'source': 'dh = display(HTML("<div>I\'m marked!... MAAARKED!!</div>"), display_id=True)\ncell = __nb__[__cellinfo__.cell_id]\ntest_eq(at(cell, \'outputs.0.metadata.brd_did\'), brdd.dh.display_id)  # type: ignore\ncell',
  'id': 'Y132sZmlsZQ==',
  'cell_type': 'code',
  'outputs': [
    {
      'output_type': 'display_data',
      'data': {
        'text/plain': '<IPython.core.display.HTML object>',
        'text/html': '<div>I\'m marked!... MAAARKED!!</div>\n<brd-mark id="e2ffaa8dc80ef2623bc8eb433633f96a"></brd-mark>'
      },
      'metadata': {'brd_did': 'e2ffaa8dc80ef2623bc8eb433633f96a'}
    }
  ]
}
```

``` json
{
    ...,
    'msg_type': 'display_data',
    'content': {
        'data': {
            'text/plain': '<IPython.core.display.HTML object>', 
            'text/html': "<div>I'm marked!... MAAARKED!!</div>"
        },
        'metadata': {},
        'transient': {'display_id': '2307db4acc4fda0ba305ffdda518748a'}
    },
    'metadata': {}
}

{
    ...,
    'msg_type': 'display_data',
.    'content': {
        'data': {
            'text/plain': '<IPython.core.display.HTML object>',
            'text/html': '<div>I\'m marked!... MAAARKED!!</div><brd-mark id="2307db4acc4fda0ba305ffdda518748a"></brd-mark>'
        },
        'metadata': {'brd_did': '2307db4acc4fda0ba305ffdda518748a'},
        'transient': {'display_id': '2307db4acc4fda0ba305ffdda518748a'}
    },
    'metadata': {}
}
```

``` python
brdd.dh.update(HTML("<div>I'm doomed!... DOOOOOMED!!</div>"))  # type: ignore
cell
```

> code

``` json
{
  'idx': 5,
  'source': 'dh = display(HTML("<div>I\'m marked!... MAAARKED!!</div>"), display_id=True)\ncell = __nb__[__cellinfo__.cell_id]\ntest_eq(at(cell, \'outputs.0.metadata.brd_did\'), brdd.dh.display_id)  # type: ignore\ncell',
  'id': 'Y132sZmlsZQ==',
  'cell_type': 'code',
  'outputs': [
    {
      'output_type': 'display_data',
      'data': {
        'text/plain': '<IPython.core.display.HTML object>',
        'text/html': '<div>I\'m doomed!... DOOOOOMED!!</div>\n<brd-mark id="e2ffaa8dc80ef2623bc8eb433633f96a"></brd-mark>'
      },
      'metadata': {'brd_did': 'e2ffaa8dc80ef2623bc8eb433633f96a'}
    },
    {
      'output_type': 'execute_result',
      'execution_count': 55,
      'data': {
        'text/plain': '{\'idx\': 5,\n \'source\': \'dh = display(HTML("<div>I\\\'m marked!... MAAARKED!!</div>"), display_id=True)\\ncell = __nb__[__cellinfo__.cell_id]\\ntest_eq(at(cell, \\\'outputs.0.metadata.brd_did\\\'), brdd.dh.display_id)  # type: ignore\\ncell\',\n \'id\': \'Y132sZmlsZQ==\',\n \'cell_type\': \'code\',\n \'outputs\': [{\'output_type\': \'display_data\',\n   \'data\': {\'text/plain\': \'<IPython.core.display.HTML object>\',\n    \'text/html\': \'<div>I\\\'m marked!... MAAARKED!!</div>\\n<brd-mark id="e2ffaa8dc80ef2623bc8eb433633f96a"></brd-mark>\'},\n   \'metadata\': {\'brd_did\': \'e2ffaa8dc80ef2623bc8eb433633f96a\'}}]}',
        'text/html': '<style>details ul { list-style-type:none; list-style-position: outside; padding-inline-start: 22px; margin: 0; } details .string { color: #24837b; } details .string::before { content: "\'"; } details .string::after { content: "\'"; } details .number { color: #ad8301; } details .true { color: blue; } details .false { color: red; } details .null { color: gray; } span.n { color: darkgrey; } </style>\n<details open><summary>NBCell@5\n</summary>  <ul>\n    <li>\n<span><span class="n">idx</span>: <span class="v number">5</span></span>    </li>\n    <li>\n<span><span class="n">source</span>: <span class="v string">dh = display(HTML(&quot;&lt;div&gt;I&#x27;m marked!... MAAARKED!!&lt;/div&gt;&quot;), display_id=True)\ncell = __nb__[__cellinfo__.cell_id]\ntest_eq(at(cell, &#x27;outputs.0.â€¦</span></span>    </li>\n    <li>\n<span><span class="n">id</span>: <span class="v string">Y132sZmlsZQ==</span></span>    </li>\n    <li>\n<span><span class="n">cell_type</span>: <span class="v string">code</span></span>    </li>\n<details open><summary>outputs\n</summary>      <ul>\n<details open><summary>0\n</summary>          <ul>\n            <li>\n<span><span class="n">output_type</span>: <span class="v string">display_data</span></span>            </li>\n<details open><summary>data\n</summary>              <ul>\n                <li>\n<span><span class="n">text/plain</span>: <span class="v string">&lt;IPython.core.display.HTML object&gt;</span></span>                </li>\n                <li>\n<span><span class="n">text/html</span>: <span class="v string">&lt;div&gt;I&#x27;m marked!... MAAARKED!!&lt;/div&gt;\n&lt;brd-mark id=&quot;e2ffaa8dc80ef2623bc8eb433633f96a&quot;&gt;&lt;/brd-mark&gt;</span></span>                </li>\n              </ul>\n</details>            <li>\n<span><span class="n">metadata</span>: <span class="v ">{&#x27;brd_did&#x27;: &#x27;e2ffaa8dc80ef2623bc8eb433633f96a&#x27;}</span></span>            </li>\n          </ul>\n</details>      </ul>\n</details>  </ul>\n</details>',
        'text/markdown': '> code\n\n```json\n{\n  \'idx\': 5,\n  \'source\': \'dh = display(HTML("<div>I\\\'m marked!... MAAARKED!!</div>"), display_id=True)\\ncell = __nb__[__cellinfo__.cell_id]\\ntest_eq(at(cell, \\\'outputs.0.metadata.brd_did\\\'), brdd.dh.display_id)  # type: ignore\\ncell\',\n  \'id\': \'Y132sZmlsZQ==\',\n  \'cell_type\': \'code\',\n  \'outputs\': [\n    {\n      \'output_type\': \'display_data\',\n      \'data\': {\n        \'text/plain\': \'<IPython.core.display.HTML object>\',\n        \'text/html\': \'<div>I\\\'m marked!... MAAARKED!!</div>\\n<brd-mark id="e2ffaa8dc80ef2623bc8eb433633f96a"></brd-mark>\'\n      },\n      \'metadata\': {\'brd_did\': \'e2ffaa8dc80ef2623bc8eb433633f96a\'}\n    }\n  ]\n}\n```'
      },
      'metadata': {}
    }
  ],
  'execution_count': 55
}
```

``` json
{
    ...,
    'msg_type': 'update_display_data',
    'content': {
        'data': {'text/plain': '<IPython.core.display.HTML object>', 'text/html': "<div>I'm doomed!... DOOOOOMED!!</div>"},
        'metadata': {},
        'transient': {'display_id': 'c3d21633d341d2463f13ef40730e8c4a'}
    },
    'metadata': {}
}

{
    ...,
    'msg_type': 'update_display_data',
    'content': {
        'data': {
            'text/plain': '<IPython.core.display.HTML object>',
            'text/html': '<div>I\'m doomed!... DOOOOOMED!!</div><brd-mark id="c3d21633d341d2463f13ef40730e8c4a"></brd-mark>'
        },
        'metadata': {},
        'transient': {'display_id': 'c3d21633d341d2463f13ef40730e8c4a'}
    },
    'metadata': {}
}
```

``` python
display('aaaa', display_id=new_id());
```

bbbb
<brd-mark id="bdd494422-ccb3bff5-e902c0e7-5824bedb"></brd-mark>

``` python
brdd.dh.update(HTML("bbbb"))  # type: ignore
```

``` python
display('cccc', metadata={'bridge': {'brd_did': new_id()}})
```

dddd
<brd-mark id="b03100cf8-3046a219-bf66d619-8a2def0d"></brd-mark>

``` python
brdd.dh.update(HTML("dddd"))  # type: ignore
```

``` python
display('eeee', metadata={'test/plain': {'brd_did': new_id()}})
test_eq(__nb__[__cellinfo__.cell_id].outputs[0].data['text/plain'], "'eeee'")
```

ffff

``` python
brdd.dh.update(Markdown("ffff"))  # type: ignore
test_eq(__nb__[__cellinfo__.cell_id].outputs, [])
```

## Multi objects display

``` python
dh = display(
    HTML("<div>Multi 1</div>"), 
    HTML("<div>Multi 2</div>"), 
    display_id=True)
```

<div>Multi 1</div>
<brd-mark id="6ff9be5be58ae578558d4b803e5a6b9e"></brd-mark>

<div>Multi 3</div>
<brd-mark id="6ff9be5be58ae578558d4b803e5a6b9e"></brd-mark>

``` python
(cell := __nb__[__lastcellinfo__.cell_id])
```

> code

``` json
{
  'idx': 13,
  'source': 'dh = display(\n    HTML("<div>Multi 1</div>"), \n    HTML("<div>Multi 2</div>"), \n    display_id=True)',
  'id': 'Y150sZmlsZQ==',
  'cell_type': 'code',
  'outputs': [
    {
      'output_type': 'display_data',
      'data': {
        'text/plain': '<IPython.core.display.HTML object>',
        'text/html': '<div>Multi 1</div>\n<brd-mark id="6ff9be5be58ae578558d4b803e5a6b9e"></brd-mark>'
      },
      'metadata': {'brd_did': '6ff9be5be58ae578558d4b803e5a6b9e'}
    },
    {
      'output_type': 'display_data',
      'data': {
        'text/plain': '<IPython.core.display.HTML object>',
        'text/html': '<div>Multi 2</div>\n<brd-mark id="6ff9be5be58ae578558d4b803e5a6b9e"></brd-mark>'
      },
      'metadata': {'brd_did': '6ff9be5be58ae578558d4b803e5a6b9e'}
    }
  ],
  'execution_count': 63
}
```

``` python
if dh: dh.update(HTML("<div>Multi 3</div>"))
cell
```

> code

``` json
{
  'idx': 13,
  'source': 'dh = display(\n    HTML("<div>Multi 1</div>"), \n    HTML("<div>Multi 2</div>"), \n    display_id=True)',
  'id': 'Y150sZmlsZQ==',
  'cell_type': 'code',
  'outputs': [
    {
      'output_type': 'display_data',
      'data': {
        'text/plain': '<IPython.core.display.HTML object>',
        'text/html': '<div>Multi 1</div>\n<brd-mark id="6ff9be5be58ae578558d4b803e5a6b9e"></brd-mark>'
      },
      'metadata': {'brd_did': '6ff9be5be58ae578558d4b803e5a6b9e'}
    },
    {
      'output_type': 'display_data',
      'data': {
        'text/plain': '<IPython.core.display.HTML object>',
        'text/html': '<div>Multi 3</div>\n<brd-mark id="6ff9be5be58ae578558d4b803e5a6b9e"></brd-mark>'
      },
      'metadata': {'brd_did': '6ff9be5be58ae578558d4b803e5a6b9e'}
    }
  ],
  'execution_count': 63
}
```

When using transient display messages with the
[`display`](https://civvic.github.io/bridget/helpers.html#display)
function, multi objects display is ill-defined.

IPython
[`display`](https://civvic.github.io/bridget/helpers.html#display)
assign the same `display_id` to each object. The front-end however will
handle it differently.

`VSCode` displays all objects but only consider transient the last
one.  
`Lab`/`Notebook` repeats the last object as many times as the number of
objects sent.

``` python
display(
    HTML("<div>Multi 1</div>", metadata={'brd_did': (did1 := new_id())}), 
    HTML("<div>Multi 2</div>", metadata={'brd_did': (did2 := new_id())})
)
```

<div>Multi 1</div>
<brd-mark id="b3108dcf1-3bb81d84-7701973c-1f835c55"></brd-mark>

<div>Multi 4</div>
<brd-mark id="bcb98a9f4-21647978-7d4fd474-0206a74a"></brd-mark>

``` python
cell = __nb__[__lastcellinfo__.cell_id]
test_eq(cell.dids, [did1, did2])
```

``` python
dh1, dh2 = brdd.dhs[-2], brdd.dhs[-1]
test_eq(dh1.display_id, did1)
test_eq(dh2.display_id, did2)
dh1.update(HTML("<div>Multi 3</div>"))
time.sleep(0.01)
dh2.update(HTML("<div>Multi 4</div>"))
```

We can sidestep the issue by using specific Bridge metadata.

## skip

``` python
display(Markdown("Skipped"), metadata={'bridge': {'skip': True}})
display("Me too", JSON({"And me": True}), metadata=skip())
```

Skipped

    'Me too'

    <IPython.core.display.JSON object>

``` python
__nb__[__lastcellinfo__.cell_id]
```

> code

``` json
{
  'idx': 19,
  'source': 'display(Markdown("Skipped"), metadata={\'bridge\': {\'skip\': True}})\ndisplay("Me too", JSON({"And me": True}), metadata=skip())',
  'id': 'Y162sZmlsZQ==',
  'cell_type': 'code',
  'outputs': [
    {
      'output_type': 'display_data',
      'data': {'text/plain': '<IPython.core.display.Markdown object>', 'text/markdown': 'Skipped'},
      'metadata': {'bridge': {'skip': True}}
    },
    {'output_type': 'display_data', 'data': {'text/plain': "'Me too'"}, 'metadata': {'bridge': {'skip': True}}},
    {
      'output_type': 'display_data',
      'data': {'text/plain': '<IPython.core.display.JSON object>', 'application/json': {'And me': True}},
      'metadata': {'application/json': {'expanded': False, 'root': 'root'}, 'bridge': {'skip': True}}
    }
  ],
  'execution_count': 69
}
```

Skip tagging all display objects.

``` python
display(
    HTML("Skipped", metadata={'skip':True, 'brd_did':(did1 := new_id())}),
    HTML("Not me", metadata={'brd_did':(did2 := new_id())}),
)
```

Skipped

Not me
<brd-mark id="b55581abb-bb1b69e3-6f11a7e8-f4d20014"></brd-mark>

``` python
cell = __nb__[__lastcellinfo__.cell_id]
test_eq(cell.dids, [did2])
cell
```

> code

``` json
{
  'idx': 21,
  'source': 'display(\n    HTML("Skipped", metadata={\'skip\':True, \'brd_did\':(did1 := new_id())}),\n    HTML("Not me", metadata={\'brd_did\':(did2 := new_id())}),\n)',
  'id': 'Y165sZmlsZQ==',
  'cell_type': 'code',
  'outputs': [
    {
      'output_type': 'display_data',
      'data': {'text/plain': '<IPython.core.display.HTML object>', 'text/html': 'Skipped'},
      'metadata': {'text/html': {'skip': True, 'brd_did': 'b19bbdaeb-1ae6ed40-ce525c18-23d81243'}}
    },
    {
      'output_type': 'display_data',
      'data': {
        'text/plain': '<IPython.core.display.HTML object>',
        'text/html': 'Not me\n<brd-mark id="b55581abb-bb1b69e3-6f11a7e8-f4d20014"></brd-mark>'
      },
      'metadata': {'brd_did': 'b55581abb-bb1b69e3-6f11a7e8-f4d20014'}
    }
  ],
  'execution_count': 71
}
```

Skip specific display object.

## bridge_cfg.auto_id

if `bridge_cfg.auto_id` is True, thereâ€™s no need to use bridge metadata.
Every supported
[`display`](https://civvic.github.io/bridget/helpers.html#display)ed
object (see `_BRDD_MIMES`) will receive an auto-generated display id.

Caveat: be aware that VSCode limits the number of transient display ids
(1000 last time I checked); not Jupyter, I believe.

``` python
bridge_cfg.auto_id = True

display(HTML("<div>I'm auto-id'd--</div>"))
```

<div>--as shown above.</div>
<brd-mark id="bcc5680ab-5ba9a878-3c3d84a8-f9f86946"></brd-mark>

``` python
brdd.dhs[-1].update(HTML("<div>--as shown above.</div>"))
```

``` python
display(Markdown(f"## did\n???"))
```

    <IPython.core.display.JSON object>

``` python
dh = brdd.dhs[-1]
dh.update(HTML(f"<b>did</b>: {dh.display_id}"))
```

``` python
dh.update(JSON({'did': dh.display_id}))
```

``` python
dhs = []
for i in range(5): 
    display(f'{i=}')
    dhs.append(brdd.dhs[-1])
```

    'i+1=1'

    'i+1=2'

    'i+1=3'

    'i+1=4'

    'i+1=5'

``` python
for i in range(5): 
    dhs[i].update(f'{i+1=}')
```

``` python
brdd.dhs.clear()
brdd.stop()
csi.stop()
bridge_cfg.auto_id = False
```

------------------------------------------------------------------------

``` python
def show_msgs(brdd: Bridged):
    for msg in brdd.msgs.copy():
        d = msg.copy()
        # d['parent_header'] = {'...': '...'}
        # d['header'] = {'...': '...'}
        del d['parent_header'], d['header'], d['tracker'], d['msg_id']
        if not d['metadata']: del d['metadata']
        try: del d['content']['data']['text/plain']
        except: pass
        if h := d['content']['data'].get('text/html'): d['content']['data']['text/html'] = shorten(h, 'r', 120)
        cprint(d)

if DEBUG(): show_msgs(brdd)
```

``` python
for c in __nb__.cells: display(c)
```

# OutputCapture

Bridget goal is to control (at least) all HTML output. Bridge can now
set metadata of any display message, those that go through display_pub.
Bridge captures all
[`display`](https://civvic.github.io/bridget/helpers.html#display),
direct or FastHTML bridge.  
But thereâ€™s other way to produce output that doesnâ€™t follow the
display_pub path: auto display of cellâ€™s final expression. That goes
through another code path, display_hook.  
Here Bridget leverage IPythonâ€™s own capture mechanism to intercept cell
results and redirect to display, a path that Bridge already control.

Bridge just captures cell outputs, not stdout/err (yet)

``` python
def _transform(lines):
    "Input transformer function"
    cpt = get_capturer()
    if not lines or cpt._capturing or cpt._debugging: return lines
    if DEBUG(): cpt._lines.append(lines)
    if lines[0].startswith('import debugpy'):
        cpt._debugging = True
        return lines
    elif lines[0].startswith('import debugpy;debugpy.listen('): return lines
    elif lines[0].startswith('import debugpy\ndebugpy.debug_this_thread()'): return lines
    elif lines[0].startswith('def __jupyter_exec_background__()'): return lines
    elif lines[0].startswith('import builtins') and lines[1].startswith('import ipykernel'): return lines
    elif lines[0].startswith('import os as _VSCODE_os') and lines[1].startswith('_VSCODE_fileList ='): return lines
    return ['get_capturer()(%r)\n' % ''.join(lines)]
_transform.has_side_effects = False


class OutputCapture:
    shell: InteractiveShell
    def __init__(self):
        super().__init__()
        self._active, self.shell = False, get_ipython()  # type: ignore
        if DEBUG(): self._captures = deque(maxlen=100); self._lines = deque(maxlen=100)
        self._capturing, self._debugging, self.run_outputs = False, False, []
        self.displayhook = CapturingDisplayHook(shell=self.shell, outputs=self.run_outputs)
    @property
    def active(self): return self._active
    def start(self):
        if self._active: return
        self._active = True
        self.shell.user_ns['get_capturer'] = get_capturer
        if DEBUG(): self._captures = deque(maxlen=100)
        # shell.input_transformer_manager.line_transforms.append(_transform)
        self.shell.input_transformers_post.append(_transform)
    def stop(self):
        if not self._active: return
        self._active = False
        # try: shell.input_transformer_manager.line_transforms.remove(_transform)
        try: self.shell.input_transformers_post.remove(_transform)
        except (ValueError, NameError): pass
    def __del__(self): self.stop()

    @contextmanager
    def _capture(self):
        self.run_outputs.clear()
        try: 
            save_display_hook, sys.displayhook = sys.displayhook, self.displayhook
            self._capturing = True
            yield CapturedIO(stdout=None, stderr=None, outputs=self.run_outputs)
        finally: 
            self._capturing = False
            sys.displayhook = save_display_hook
    def __call__(self, cell):
        info: AD = self.shell.user_ns.get('__cellinfo__')  # type: ignore
        with self._capture() as io:
            self.shell.run_cell(cell, cell_id=info.cell_id)
        if DEBUG(): self._captures.append([cell, io._outputs.copy()])
        if io._outputs: 
            assert len(io._outputs) <= 1, "Only one output is supported"
            info.exec_result.result = io._outputs[-1]
            display(io.outputs[-1], metadata={'bridge': {'captured': True}})
    
__capturer__ = None
def get_capturer(start:bool=False):
    global __capturer__
    get_csi(True)
    if __capturer__ is None: __capturer__ = OutputCapture()
    if start: __capturer__.start()
    return __capturer__
```

``` python
get_csi().stop()
get_bridged().stop()
get_capturer().stop()

bridge_cfg.auto_id = True

__nb__ = NB()  # type: ignore

brdd = get_bridged(True)

cptr = get_capturer(True)
```

``` python
1+3
```

<div>I was 4, now I'm 44</div>

``` python
info = __lastcellinfo__
test_eq(__nb__[__lastcellinfo__.cell_id].outputs[0].data, {'text/plain': '4'})
test_eq(len(brdd.dhs), 1)
show(DetailsJSON(__lastcellinfo__, openall=True))
```

<style>details ul { list-style-type:none; list-style-position: outside; padding-inline-start: 22px; margin: 0; } details .string { color: #24837b; } details .string::before { content: "'"; } details .string::after { content: "'"; } details .number { color: #ad8301; } details .true { color: blue; } details .false { color: red; } details .null { color: gray; } span.n { color: darkgrey; } </style>
<details open><summary>summary
</summary>  <ul>
    <li>
<span><span class="n">source</span>: <span class="v string">1+3</span></span>    </li>
    <li>
<span><span class="n">cell_id</span>: <span class="v string">Y222sZmlsZQ==</span></span>    </li>
<details open><summary>exec_result
</summary>      <ul>
<details open><summary>result
</summary>          <ul>
<details open><summary>data
</summary>              <ul>
                <li>
<span><span class="n">text/plain</span>: <span class="v string">4</span></span>                </li>
              </ul>
</details><details open><summary>metadata
</summary>              <ul></ul>
</details>          </ul>
</details>        <li>
<span><span class="n">execution_count</span>: <span class="v number">85</span></span>        </li>
        <li>
<span><span class="n">error_before_exec</span>: <span class="v null">None</span></span>        </li>
        <li>
<span><span class="n">error_in_exec</span>: <span class="v null">None</span></span>        </li>
      </ul>
</details>  </ul>
</details>
<brd-mark id="bc4743314-1703b8af-012c6759-46fba1e2"></brd-mark>

`__cellinfo__.result` has a valid value only **after** the
`display(...)` call. The cell with `1+3` captures the output and then
displays it with `display(...)`. That occurs after the cell is executed.
So, `__cellinfo__.result` is `None` during the cell execution. Itâ€™s only
possible to get the output after the cell has run.

``` python
HTML('<div>asdf</div>')
```

<div>I was asdf, now I'm qwer</div>

``` python
if DEBUG(): 
    output_data = get_capturer()._captures[-1][1][0]['data']
    test_eq(output_data['text/plain'], '<IPython.core.display.HTML object>')
    html = output_data['text/html']
    test_eq(f'<brd-mark id="{brdd.dh.display_id}"' in html, True)  # type: ignore
test_eq(len(brdd.dhs), 3)
```

``` python
print(10)
17
```

    10

<div>I was 17, now I'm 177</div>

``` python
1/0
```

    ZeroDivisionError: division by zero
    [0;31m---------------------------------------------------------------------------[0m
    [0;31mZeroDivisionError[0m                         Traceback (most recent call last)
    Cell [0;32mIn[90], line 1[0m
    [0;32m----> 1[0m [38;5;241;43m1[39;49m[38;5;241;43m/[39;49m[38;5;241;43m0[39;49m

    [0;31mZeroDivisionError[0m: division by zero

``` python
get_bridged() .stop()
get_csi().stop()
get_capturer().stop()
```

``` python
brdd.dhs[0].update(HTML("<div>I was 4, now I'm 44</div>"))
```

``` python
brdd.dhs[2].update(HTML("<div>I was asdf, now I'm qwer</div>"))
```

``` python
brdd.dh.update(HTML("<div>I was 17, now I'm 177</div>"))  # type: ignore
```

------------------------------------------------------------------------

``` python
def show_captures():
    cc = get_capturer()._captures
    for c in cc:
        cprint(c)
        print('---------')

show_captures()
```

<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'1+3\n'</span>, <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'data'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'text/plain'</span>: <span style="color: #008000; text-decoration-color: #008000">'4'</span><span style="font-weight: bold">}</span>, <span style="color: #008000; text-decoration-color: #008000">'metadata'</span>: <span style="font-weight: bold">{}}]]</span>
</pre>

    ---------

<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">[</span>
    <span style="color: #008000; text-decoration-color: #008000">"info = __lastcellinfo__\ntest_eq(__nb__[__lastcellinfo__.cell_id].outputs[0].data, {'text/plain': '4'})\ntest_eq(len(brdd.dhs), </span>
<span style="color: #008000; text-decoration-color: #008000">1)\nshow(DetailsJSON(__lastcellinfo__, openall=True))\n"</span>,
    <span style="font-weight: bold">[]</span>
<span style="font-weight: bold">]</span>
</pre>

    ---------

<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">[</span>
    <span style="color: #008000; text-decoration-color: #008000">"HTML('&lt;div&gt;asdf&lt;/div&gt;')\n"</span><span style="color: #000000; text-decoration-color: #000000">,</span>
<span style="color: #000000; text-decoration-color: #000000">    </span><span style="color: #000000; text-decoration-color: #000000; font-weight: bold">[</span>
<span style="color: #000000; text-decoration-color: #000000">        </span><span style="color: #000000; text-decoration-color: #000000; font-weight: bold">{</span>
<span style="color: #000000; text-decoration-color: #000000">            </span><span style="color: #008000; text-decoration-color: #008000">'data'</span><span style="color: #000000; text-decoration-color: #000000">: </span><span style="color: #000000; text-decoration-color: #000000; font-weight: bold">{</span>
<span style="color: #000000; text-decoration-color: #000000">                </span><span style="color: #008000; text-decoration-color: #008000">'text/plain'</span><span style="color: #000000; text-decoration-color: #000000">: </span><span style="color: #008000; text-decoration-color: #008000">'&lt;IPython.core.display.HTML object&gt;'</span><span style="color: #000000; text-decoration-color: #000000">,</span>
<span style="color: #000000; text-decoration-color: #000000">                </span><span style="color: #008000; text-decoration-color: #008000">'text/html'</span><span style="color: #000000; text-decoration-color: #000000">: </span><span style="color: #008000; text-decoration-color: #008000">'&lt;div&gt;asdf&lt;/div&gt;\n&lt;brd-mark id="b3c829493-53426d78-6c9050ad-6e20e069"&gt;&lt;/brd-mark&gt;'</span>
            <span style="font-weight: bold">}</span>,
            <span style="color: #008000; text-decoration-color: #008000">'metadata'</span>: <span style="font-weight: bold">{}</span>
        <span style="font-weight: bold">}</span>
    <span style="font-weight: bold">]</span>
<span style="font-weight: bold">]</span>
</pre>

    ---------

<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">[</span>
    <span style="color: #008000; text-decoration-color: #008000">'if DEBUG(): \n    output_data = get_capturer()._captures[-1][1][0][\'data\']\n    test_eq(output_data[\'text/plain\'], </span>
<span style="color: #008000; text-decoration-color: #008000">\'&lt;IPython.core.display.HTML object&gt;\')\n    html = output_data[\'text/html\']\n    test_eq(f\'&lt;brd-mark id="{brdd.dh.display_id}"\' in </span>
<span style="color: #008000; text-decoration-color: #008000">html, True)  # type: ignore\ntest_eq(len(brdd.dhs), 3)\n'</span>,
    <span style="font-weight: bold">[]</span>
<span style="font-weight: bold">]</span>
</pre>

    ---------

<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'print(10)\n17\n'</span>, <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'data'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'text/plain'</span>: <span style="color: #008000; text-decoration-color: #008000">'17'</span><span style="font-weight: bold">}</span>, <span style="color: #008000; text-decoration-color: #008000">'metadata'</span>: <span style="font-weight: bold">{}}]]</span>
</pre>

    ---------

<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'1/0\n'</span>, <span style="font-weight: bold">[]]</span>
</pre>

    ---------

<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'get_bridged() .stop()\nget_csi().stop()\nget_capturer().stop()\n'</span>, <span style="font-weight: bold">[]]</span>
</pre>

    ---------

``` python
def show_lines():
    cc = get_capturer()._lines
    for c in cc:
        cprint(shorten(c, 'r', 140))
        print('---------')

show_lines()
```

``` python
if DEBUG(): show_msgs(brdd)  # type: ignore
```

<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span>
    <span style="color: #008000; text-decoration-color: #008000">'msg_type'</span>: <span style="color: #008000; text-decoration-color: #008000">'display_data'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'content'</span>: <span style="font-weight: bold">{</span>
        <span style="color: #008000; text-decoration-color: #008000">'data'</span>: <span style="font-weight: bold">{}</span>,
        <span style="color: #008000; text-decoration-color: #008000">'metadata'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'bridge'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'captured'</span>: <span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span><span style="font-weight: bold">}}</span>,
        <span style="color: #008000; text-decoration-color: #008000">'transient'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'display_id'</span>: <span style="color: #008000; text-decoration-color: #008000">'b34bd6418-582983a0-eaaadd4f-12e98d9e'</span><span style="font-weight: bold">}</span>
    <span style="font-weight: bold">}</span>
<span style="font-weight: bold">}</span>
</pre>

<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span>
    <span style="color: #008000; text-decoration-color: #008000">'msg_type'</span>: <span style="color: #008000; text-decoration-color: #008000">'display_data'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'content'</span>: <span style="font-weight: bold">{</span>
        <span style="color: #008000; text-decoration-color: #008000">'data'</span>: <span style="font-weight: bold">{</span>
            <span style="color: #008000; text-decoration-color: #008000">'text/html'</span>: <span style="color: #008000; text-decoration-color: #008000">'&lt;style&gt;details ul { list-style-type:none; list-style-position: outside; padding-inline-start: 22px; margin: 0; } </span>
<span style="color: #008000; text-decoration-color: #008000">detailsâ€¦'</span>
        <span style="font-weight: bold">}</span>,
        <span style="color: #008000; text-decoration-color: #008000">'metadata'</span>: <span style="font-weight: bold">{}</span>,
        <span style="color: #008000; text-decoration-color: #008000">'transient'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'display_id'</span>: <span style="color: #008000; text-decoration-color: #008000">'bc4743314-1703b8af-012c6759-46fba1e2'</span><span style="font-weight: bold">}</span>
    <span style="font-weight: bold">}</span>
<span style="font-weight: bold">}</span>
</pre>

<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span>
    <span style="color: #008000; text-decoration-color: #008000">'msg_type'</span>: <span style="color: #008000; text-decoration-color: #008000">'display_data'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'content'</span>: <span style="font-weight: bold">{</span>
        <span style="color: #008000; text-decoration-color: #008000">'data'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'text/html'</span>: <span style="color: #008000; text-decoration-color: #008000">'&lt;div&gt;asdf&lt;/div&gt;\n&lt;brd-mark id="b3c829493-53426d78-6c9050ad-6e20e069"&gt;&lt;/brd-mark&gt;'</span><span style="font-weight: bold">}</span>,
        <span style="color: #008000; text-decoration-color: #008000">'metadata'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'bridge'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'captured'</span>: <span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span><span style="font-weight: bold">}}</span>,
        <span style="color: #008000; text-decoration-color: #008000">'transient'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'display_id'</span>: <span style="color: #008000; text-decoration-color: #008000">'b3c829493-53426d78-6c9050ad-6e20e069'</span><span style="font-weight: bold">}</span>
    <span style="font-weight: bold">}</span>
<span style="font-weight: bold">}</span>
</pre>

<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span>
    <span style="color: #008000; text-decoration-color: #008000">'msg_type'</span>: <span style="color: #008000; text-decoration-color: #008000">'display_data'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'content'</span>: <span style="font-weight: bold">{</span>
        <span style="color: #008000; text-decoration-color: #008000">'data'</span>: <span style="font-weight: bold">{}</span>,
        <span style="color: #008000; text-decoration-color: #008000">'metadata'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'bridge'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'captured'</span>: <span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span><span style="font-weight: bold">}}</span>,
        <span style="color: #008000; text-decoration-color: #008000">'transient'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'display_id'</span>: <span style="color: #008000; text-decoration-color: #008000">'b4e7c9b47-1eeb4595-2b85a414-25b2e188'</span><span style="font-weight: bold">}</span>
    <span style="font-weight: bold">}</span>
<span style="font-weight: bold">}</span>
</pre>

# CaptureTransformer

> Output capture with AST hooks.

`OutputCapture` works correctly, but conflicts with the debugger abounds
as it alters the source code. Fortunately, IPython has another much more
powerful hook mechanism, `ast_transformers`, that is cleaner and more
flexible.

``` python
def _ast_process_result(result):
    if result is not None:
        if not (shell := get_ipython()): return result
        info = shell.user_ns['__cellinfo__']
        if result is not info: info.exec_result.result = result
        display(result, metadata={'bridge': {'captured': True}})
```

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/nb_hooks.py#L279"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_capturer

>  get_capturer (start=False)

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/nb_hooks.py#L231"
target="_blank" style="float:right; font-size:smaller">source</a>

### CaptureTransformer

>  CaptureTransformer (mode='direct')

\*A :class:`NodeVisitor` subclass that walks the abstract syntax tree
and allows modification of nodes.

The `NodeTransformer` will walk the AST and use the return value of the
visitor methods to replace or remove the old node. If the return value
of the visitor method is `None`, the node will be removed from its
location, otherwise it is replaced with the return value. The return
value may be the original node in which case no replacement takes place.

Here is an example transformer that rewrites all occurrences of name
lookups (`foo`) to `data['foo']`::

class RewriteName(NodeTransformer):

       def visit_Name(self, node):
           return Subscript(
               value=Name(id='data', ctx=Load()),
               slice=Constant(value=node.id),
               ctx=node.ctx
           )

Keep in mind that if the node youâ€™re operating on has child nodes you
must either transform the child nodes yourself or call the
:meth:`generic_visit` method for the node first.

For nodes that were part of a collection of statements (that applies to
all statement nodes), the visitor may also return a list of nodes rather
than just a single node.

Usually you use the transformer like this::

node = YourTransformer().visit(node)\*

``` python
get_csi().stop()
get_bridged().stop()
get_capturer().stop()

bridge_cfg.auto_id = True

__nb__ = NB()  # type: ignore

brdd = get_bridged()

cptr = get_capturer(True)
test_eq(get_ipython().ast_transformers, [cptr])  # type: ignore
```

``` python
node = cptr.visit_Module(ast.parse('''
x = 10
y = 20
x + y
'''))

test_eq(ast.unparse(node), 'x = 10\ny = 20\n_ast_process_result(x + y)')
```

``` python
x = 10
y = 20
x + y
```

    30

``` python
test_is(_ != 30, True)
# test_eq(__lastcellinfo__.exec_result.result, 30)
show(DetailsJSON(__lastcellinfo__, summary='__lastcellinfo__', openall=True))
__nb__[__lastcellinfo__.cell_id]
```

<style>details ul { list-style-type:none; list-style-position: outside; padding-inline-start: 22px; margin: 0; } details .string { color: #24837b; } details .string::before { content: "'"; } details .string::after { content: "'"; } details .number { color: #ad8301; } details .true { color: blue; } details .false { color: red; } details .null { color: gray; } span.n { color: darkgrey; } </style>
<details open><summary>__lastcellinfo__
</summary>  <ul>
    <li>
<span><span class="n">source</span>: <span class="v string">x = 10
y = 20
x + y</span></span>    </li>
    <li>
<span><span class="n">cell_id</span>: <span class="v string">Y251sZmlsZQ==</span></span>    </li>
<details open><summary>exec_result
</summary>      <ul>
        <li>
<span><span class="n">result</span>: <span class="v number">30</span></span>        </li>
        <li>
<span><span class="n">execution_count</span>: <span class="v number">102</span></span>        </li>
        <li>
<span><span class="n">error_before_exec</span>: <span class="v null">None</span></span>        </li>
        <li>
<span><span class="n">error_in_exec</span>: <span class="v null">None</span></span>        </li>
      </ul>
</details>  </ul>
</details>
<brd-mark id="be0a70540-1f149071-1e9bf543-8b240db0"></brd-mark>

> code

``` json
{
  'idx': 1,
  'source': 'x = 10\ny = 20\nx + y',
  'id': 'Y251sZmlsZQ==',
  'cell_type': 'code',
  'outputs': [
    {
      'output_type': 'display_data',
      'data': {'text/plain': '30'},
      'metadata': {'bridge': {'captured': True}, 'brd_did': 'be2adf707-956b7807-c1810422-23297835'}
    }
  ],
  'execution_count': 102
}
```

Note that `CaptureTranformer` changes the semantics of IPython code
execution because is effectively disabling the [Output caching
system](https://ipython.readthedocs.io/en/latest/interactive/reference.html#output-caching-system)
as itâ€™s intercepting all cell outputs. <s>If you have any use for
`_`|`_<n>`|`_oh`|`Out` variables, `CaptureTranformer` has the same
effect as setting `InteractiveShell.cache_size` to 0.</s>

During cell execution, IPython replaces `sys.displayhook` with a custom
`DisplayHook` instance responsible for displaying the result of the cell
execution (among many other things).
[`Bridget`](https://civvic.github.io/bridget/bridget.html#bridget) now
handles cell outputs (and does what `displayhook` did before to show the
cell result). The shell `displayhook` then always receives a result of
None. [`Bridget`](https://civvic.github.io/bridget/bridget.html#bridget)
must replicate some (not sure what to do about the
`shell.history_manager`) of the functionality of `displayhook` to ensure
that output cache variables are updated correctly (see
[\_\_call\_\_](https://github.com/ipython/ipython/blob/4d0c438d617e49b77d68cd98208f7b2d371a1381/IPython/core/displayhook.py#L269)).

``` python
class TestD:
    def _ipython_display_(self):
        # dhdl = DisplayId()
        # dhdl.display(self.text)
        IDISPLAY(HTML('from _ipython_display_'))

TestD()
```

from _ipython_display_
<brd-mark id="b91d17647-da0db986-c9ab9be4-fb83af67"></brd-mark>

``` python
__nb__[__lastcellinfo__.cell_id]
```

> code

``` json
{
  'idx': 4,
  'source': "class TestD:\n    def _ipython_display_(self):\n        # dhdl = DisplayId()\n        # dhdl.display(self.text)\n        IDISPLAY(HTML('from _ipython_display_'))\n\nTestD()",
  'id': 'Y255sZmlsZQ==',
  'cell_type': 'code',
  'outputs': [
    {
      'output_type': 'display_data',
      'data': {
        'text/plain': '<IPython.core.display.HTML object>',
        'text/html': 'from _ipython_display_\n<brd-mark id="b91d17647-da0db986-c9ab9be4-fb83af67"></brd-mark>'
      },
      'metadata': {'brd_did': 'b91d17647-da0db986-c9ab9be4-fb83af67'}
    }
  ],
  'execution_count': 105
}
```

``` python
bridge_cfg.auto_show = False
```

``` python
Div('Hey, Foo!')
```

``` html
<div>Hey, Foo!</div>
```

``` python
__nb__[__lastcellinfo__.cell_id]
```

> code

``` json
{
  'idx': 7,
  'source': "Div('Hey, Foo!')",
  'id': 'Y261sZmlsZQ==',
  'cell_type': 'code',
  'outputs': [
    {
      'output_type': 'display_data',
      'data': {'text/plain': "div(('Hey, Foo!',),{})", 'text/markdown': '```html\n<div>Hey, Foo!</div>\n\n```'},
      'metadata': {'bridge': {'captured': True}, 'brd_did': 'bb5b04995-eaac4b3d-83f7e6db-c103ca68'}
    },
    {
      'output_type': 'execute_result',
      'execution_count': 108,
      'data': {'text/plain': "div(('Hey, Foo!',),{})", 'text/markdown': '```html\n<div>Hey, Foo!</div>\n\n```'},
      'metadata': {}
    }
  ],
  'execution_count': 108
}
```

# stop_hooks

# get_nb_from_hooks

``` python
_BRDD_MIMES
```

    {'application/javascript',
     'application/json',
     'application/pdf',
     'image/jpeg',
     'image/png',
     'image/svg+xml',
     'text/html',
     'text/latex',
     'text/markdown',
     'text/plain'}

What does this module do?

- Receives IPythonâ€™s events to record cell info (what the kernel can
  possibly know before and after the cell run).
- Hooks into the display system to convert all calls into `transient`
  calls with a display_id connected to the cell_id.
- Transforms cell code with a custom AST transformer to redirect cell
  result to the display system.

This way, Bridget effectively knows what each cell output is (except
stdout/err for now) and how to reference and modify it using standard
IPython features.

Is this enough to make Bridget a functional notebook editor? Not really,
we need real-time updates of the notebook structure (the notebook state,
what would be saved to disk as .ipynb) to be able to navigate the
notebook.

That unfortunately requires to navigate the procellous waters of widgets
and extensions. Good olâ€™ IPython and Jupyter are not designed to give
the kernel knowledge about the notebook state in real time. We
pythonistas deluded ourselves into thinking Jupiter is all about us, but
a Jupyter notebook is really a JavaScript application that controls
everything, including the model and the view. The kernel is a second
class citizen that knows next to nothing about or even what is a
notebook.

Weâ€™re going to fix that next.

------------------------------------------------------------------------

<!-- # Colophon -->
