<project title="Bridget" summary="Notebook state + FastHTML + HTMX in Jupyter, no server required.">Bridget enables server-free interactive HTML components in Jupyter using FastHTML and HTMX. It replaces the HTTP transport layer with an anywidget-based bridge and provides real-time notebook introspection without saving .ipynb files.

**Core features:**
- HTMX/FastHTML work via widget communication instead of HTTP
- Live notebook state access (cells, outputs, metadata) without file I/O
- Extension-based architecture (VSCode/JupyterLab) feeds state to Python kernel

**Status:** Experimental, Python 3.12+, API unstable

**Installation:** `git clone + pnpm install + pip install -e .[dev]`

**Quick Start:** `from bridget.bridget import get_app; app, bridget, rt = get_app()`<docs><doc title="README" desc="Project overview"># Bridget



## Key Features

- **Serverless HTMX + FastHTML**: full FastHTML + HTMX functionality in
  Jupyter environments, with no HTTP server required.
- **Extended FastHTML routing system**: integrates seamlessly with
  Python methods.
- **Widget system (WIP)**: build UI components with minimal JavaScript.
- **Real-time notebook introspection**: capture the full notebook
  structure dynamically, without `.ipynb` files.
- **Environment-agnostic**: supports VSCode, JupyterLab, and other
  interfaces.

Bridget relies on companion extensions for JupyterLab/Notebook and
VSCode/Cursor. These capture the live notebook state and feed it
directly to Bridget‚Äôs Python kernel.

## Installation

As Bridget is in early development, it is not yet on PyPI. A development
installation requires NodeJS and the pnpm package manager.

Clone the repository, install JS dependencies with `pnpm`, then perform
an editable Python install. This builds the JS components and installs
the `nbinspect-lab` Jupyter extension automatically.

``` bash
# 1. Clone the repository
git clone https://github.com/civvic/bridget.git
cd bridget

# 2. Install JavaScript dependencies (JupyterLab extension)
pnpm install

# 3. Install Python package with all dependencies
pip install -e .[dev]
```

> Note: step 2 is only necessary if you are going to use Jupyter
> Lab/Notebook. For VSCode, simply install the extension. See below.

## VSCode Extension Installation

For VSCode and Cursor, install the nbinspect-vscode extension manually.
The .vsix file is inside packages/nbinspect-vscode.

To install: - Run the command Extensions: Install from VSIX‚Ä¶ - Or open
the Extensions view, click the ‚Äú‚Ä¶‚Äù menu, and select Install from VSIX‚Ä¶.

## Quick Start

A minimal stateful counter component:

``` python
from bridget.common import get_app
from fasthtml.components import Button

app, bridget, rt = get_app()  # Initialize Bridget and app

def counter(n=0):
    @rt('/inc')
    def increment(n:int):
        return Button(f"Count: {n+1}", value=f"{n+1}", name='n', hx_post='/inc', hx_swap='outerHTML')
    return increment(n-1)

counter()
```

For more detailed examples, review the notebooks in the `nbs/examples/`
directory.

## Core Concepts

### The Bridge

The [`Bridge`](https://civvic.github.io/bridget/bridge.html#bridge)
class ([14_bridge.ipynb](14_bridge.ipynb)) provides the low-level
communication layer between Python and JavaScript, replacing the HTTP
transport layer typically used by HTMX.

### Bridget and get_app()

The [`Bridget`](https://civvic.github.io/bridget/bridget.html#bridget)
class ([32_bridget.ipynb](32_bridget.ipynb)) and
[`get_app()`](https://civvic.github.io/bridget/bridget.html#get_app)
function provide the high-level API for creating interactive components.
This is your main entry point.

### Routing System

Bridget extends FastHTML‚Äôs routing system
([04_route_provider.ipynb](04_route_provider.ipynb)) to work with Python
methods and class instances, enabling stateful components.

### Plugin System

Bridget‚Äôs functionality can be extended through plugins
([16_bridge_plugins.ipynb](16_bridge_plugins.ipynb)), enabling modular
feature development.

### Notebook State

Access live notebook structure and content
([21_nb_state.ipynb](21_nb_state.ipynb)) without saving files, enabling
powerful introspection capabilities.

## Documentation Structure

### Core Components

- [00_common.ipynb](00_common.ipynb) - Common imports and utilities
- [01_helpers.ipynb](01_helpers.ipynb) - Helper functions and utilities
- [10_bridge_widget.ipynb](10_bridge_widget.ipynb) - BridgeWidget
  infrastructure
- [14_bridge.ipynb](14_bridge.ipynb) - Bridge class (low-level
  messaging)
- [32_bridget.ipynb](32_bridget.ipynb) - Bridget class and get_app()
  entry point

### FastHTML Integration

- [03_fasthtml_patching.ipynb](03_fasthtml_patching.ipynb) - FastHTML
  modifications for serverless operation
- [04_route_provider.ipynb](04_route_provider.ipynb) - Extended routing
  system

### Notebook State

- [07_nb.ipynb](07_nb.ipynb) - High-level notebook API
- [15_nb_hooks.ipynb](15_nb_hooks.ipynb) - Notebook event hooks
- [21_nb_state.ipynb](21_nb_state.ipynb) - Notebook state introspection

### Components and Widgets

- [40_details_json.ipynb](40_details_json.ipynb) - Lazy-loading JSON
  viewer
- [50_widget.ipynb](50_widget.ipynb) - Widget development guide

### Examples

- [examples/quickstart.ipynb](examples/quickstart.ipynb) - Quick start
  guide
- [examples/htmx_examples.ipynb](examples/htmx_examples.ipynb) - HTMX
  patterns

## Compatibility and Development

Bridget is developed with [nbdev](https://nbdev.fast.ai/) and requires
Python 3.12+. Core dependencies like `fasthtml` and `anywidget` are
installed automatically. It is regularly tested on macOS with VSCode,
Jupyter Notebook, and Jupyter Lab, and is expected to function in any
environment where `anywidget`/`ipywidgets` is supported.

## Project Status

Bridget is experimental and integrates Jupyter, FastHTML, and HTMX.

Its primary goal, inspired by Donald Knuth‚Äôs concept of Literate
Programming, is to create truly dynamic documents where any content
(including cell outputs) can be directly edited and interacted with in
place.

Current status: - ‚úÖ Core architecture for serverless HTMX and notebook
introspection is functional. - ‚úÖ Key HTMX patterns are supported and
demonstrated in the `nbs/examples/` notebooks. - ‚ö†Ô∏è The API is unstable
and subject to significant change. - ‚õî Not recommended for use in
production environments. - üìù Documentation and more complex examples
are in active development.</doc></docs><api><doc title="API Reference" desc="Complete API list"># bridget Module Documentation

## bridget.bridge

- `class ScriptsDetails`
    - `def __init__(self, scs, title, open)`
    - `def __ft__(self)`

- `class BCanvas`

- `class BLogger`
    - `def close_canvas(self)`
    - `def msg(self, msg, clear, ctx, **kwargs)`

- `class BridgeBoot`
    - `def __init__(self, logger, show_logger, **kwargs)`
    - `def close(self)`
    - `def update_logger_config(self, **kwargs)`
    - `def log(self, msg, clear)`
    - `def error(self, msg, clear)`
    - `def warn(self, msg, clear)`

- `def handle_message(o, *args, **kwargs)`
    if `o` has an attr named `ctx`, look for a handler with the form `on_{kind}` 
    passing the rest of `msg` and `args` to it. 
    If `forward`and `o` has an attr named with `forward_name`, call it with `o`, `msg` and `args`.

- `@FC.delegates(BridgeBoot, keep=True) class BridgeMessenger`
    - `def __init__(self, **kwargs)`
    - `def on_info(self, *args, **kwargs)`
        Handle 'info' messages from the front-end.

    - `def on_error(self, *args, **kwargs)`
        Handle 'error' messages from the front-end.

    - `def debug_enabled(self, ctx, enabled, **kwargs)`
        Switch debug logs.

    - `def msg(self, tracker, **kwargs)`
        Compose a message with tracking.


- `class BridgePlugin`
    - `def __init__(self, ctx, src, bridge)`
    - `def on_init(self, *args, **kwargs)`
    - `def log(self, msg, clear)`
    - `def error(self, msg, clear)`
    - `def warn(self, msg, clear)`

- `@FC.delegates(BridgeMessenger, keep=True) class Bridge`
    - `def __init__(self, *plugins, **kwargs)`
    - `@property def loader`
    - `def __getattr__(self, name)`
    - `def add_plugins(self, *plugins)`
    - `def on_info(self, *args, **kwargs)`
    - `@anywidget.experimental.command def get_prop(self, spec, buffers)`

- `class Loader`
    - `def __init__(self, lnks, esms)`
    - `def on_init(self, *args, **kwargs)`
    - `@property def loading`
    - `@overload def loaded(self, name)`
    - `def load(self, esms, reload, cache)`
    - `def load_links(self, lnks)`
    - `def aload(self, esms, reload, cache)`
    - `def aload_links(self, lnks)`
    - `def on_load(self, *args, **kwargs)`
    - `def on_loadLinks(self, *args, **kwargs)`

- `class HTMXPlugin`
    - `def setup(self)`
    - `def on_info(self, *args, **kwargs)`

## bridget.bridge_plugins

> Example Bridge plugins and their usage

- `class HTMXCommander`
    - `def swap(self, target, content)`

- `class HTMXCommanderPlugin`
    - `def on_inspect(self, *args, **kwargs)`
    - `def swap(self, target, content)`

- `class NBHooksPlugin`
    - `def __init__(self, *args, **kwargs)`
    - `def on_init(self, *args, **kwargs)`
    - `@property def dh`

## bridget.bridge_widget

> Basis of the bridge: bundling, blocking operations, and AnyWidget.

- `@FC.delegates(ft_html, keep=True) def ScriptV(code, **kwargs)`
    A Script w/ code or `vfile:` contents that doesn't escape its code

- `@FC.delegates(ft_html, keep=True) def StyleV(*c, **kwargs)`
    A Style w/ code or `vfile:` contents that doesn't escape its code

- `class SourceProvider`
    Object with a .source attribute (string or callable returning string)

    - `@property def source`

- `def anysource(*args)`
    Read and join text from files, vfiles or strings

- `class Bundle`
    Basic JS bundler class.

    - `def __init__(self, *sources, **cmd_kw)`
    - `@classmethod def default_outdir(cls)`
    - `@classmethod def transform(cls, src)`
    - `def __str__(self)`
    - `def __call__(self, *args, **kwargs)`
        Concatenate sources. This is the only point where the source is transformed

    - `@cached_property def bundled_sources(self)`
        Bundle the sources using `esbuild` or `copy`. Return sources and paths to the bundled files.

    - `def bundle_path_of(self, source)`
    - `@cached_property def source(self)`
    - `def join(self, *sources)`

- `def resolve_ESM(spec, base)`
    Resolve a JavaScript module specifier relative to `base` or `bundle_cfg.out_dir`.

- `def get_ESM(module_spec)`
    Contents of a JS module

- `def exp_backoff(base, max_value)`
    Exponential backoff generator of values until cumulative value is max_value, then yields 0 and stops.

- `def blocks(pred, timeout, sleep, n, show)`
    Block until `pred` is True, or at least `timeout` seconds have passed. Return `False` if timeout.

- `def ablocks(pred, timeout, sleep, n, show)`
    Return True when `pred` returns True, or False when at least `timeout` seconds have passed.

- `class BlockingMixin`
    Mixin for widgets that supports blocking custom messages with the front-end.

    - `def loaded(self)`
    - `def setup_init_on_msg(self, callback)`
        Helper to setup the blocking mechanism. Call it before super().__init__(...)

    - `@classmethod def create(cls, *args, **kwargs)`
    - `@classmethod def acreate(cls, *args, **kwargs)`
    - `@overload def send(self, msg, buffers)`
    - `def asend(self, msg, buffers)`
        Send `msg` to the front-end. Call will end after `timeout` seconds.
        NOTE: front-end can yet send back a result even if python timeout was triggered.


- `class BridgeWidget`
    - `def __init__(self, *args, **kwargs)`

- `class BridgeImport`
    - `def __init__(self, getter, **kwargs)`
    - `@anywidget.experimental.command def get_module(self, moduleName, buffers)`

## bridget.bridget

> HTMX + FastHTML - Server for Jupyter Notebooks

- `class ClientP`
    HTTP client interface supporting REST operations (get, post, delete)

    - `def get(self, url, **kwargs)`
    - `def post(self, url, **kwargs)`
    - `def delete(self, url, **kwargs)`
    - `def put(self, url, **kwargs)`
    - `def patch(self, url, **kwargs)`
    - `def options(self, url, **kwargs)`

- `def request2httpx_request(cli, http_request)`
    Convert bridget request dict to httpx Request object

- `class HasFT`
    Objects that can convert themselves to FastHTML FT components

    - `def __ft__(self)`

- `class HasHTML`
    Objects that can render themselves as HTML strings

    - `def __html__(self)`

- `def request2response(cli, http_request)`
    Execute bridget request and return httpx Response

- `def httpx_response_to_json(response)`
    Convert httpx Response to JSON dict with headers and content

- `class BridgetClient`
    A simple wrapper around `FastHTML` and `Client`.

    - `def setup(self, app)`
    - `def __call__(self, rt, method, req, **kwargs)`
        Display FastHTML components, routes or requests in notebook cells.

    - `def mount(self, prov, path, name, index, show)`

- `class Bridget`
    - `def __init__(self, app, *args, **kwargs)`
    - `def on_request(self, *args, **kwargs)`
        Handle incoming HTMX requests


## bridget.fasthtml_patching

> Patches and utilities for FastHTML notebook integration

- `class JupyUviB`
    Start and stop a Jupyter compatible uvicorn server with ASGI `app` on `port` with `log_level`

    - `def __init__(self, app, log_level, host, port, start, **kwargs)`

## bridget.helpers

> General utilities.

- `def DEBUG(iftrue, iffalse, k)`
    Returns `iftrue` if debug environment variable is set, otherwise `iffalse`

- `class BundleCfg`

- `class BridgeCfg`
    Core Bridget behavior settings. if `True`:  
    - `auto_show` (false): FastHTML objects display as HTML instead of markdown.  
    - `auto_mount` (false): components with routes are automatically mounted.  
    - `auto_id` (false): display elements get auto-generated IDs.  
    - `bundle_cfg` (BundleCfg): configuration for dynamic import of Bridget modules.  
    - `bootstrap` (false): load bridget.js on import.  
    - `current_did` (None): the ID of the current display cell.

    - `def for_module(self, module, dir)`
        Set up BridgeCfg for a specific module by adding its folder and `dir` folder to bundle search paths


- `def arun_command(command, cwd, **kwargs)`
    Async version of run_command using anyio

- `def run_command(command, cwd, **kwargs)`
    Execute shell command synchronously, returns (stdout, stderr)

- `def ms2str(ts)`
    format timestamp as in milliseconds to readable time hours:minutes:seconds:milliseconds

- `class Kounter`
    Counter that tracks occurrences of keys and returns incremented count

    - `def __init__(self)`
    - `def __call__(self, k)`

- `def simple_id()`
    Generate simple hex ID using random bytes

- `def id_gen()`
    Create ID generator function that produces unique session-based IDs

- `def patch_cached(cls, f, name)`
    Add cached method to class using functools.cache

- `def patch_cached_property(cls, f, name)`
    `cached_property` with `partial` support

- `class cached_property`
    Enhanced cached_property that preserves function attributes

    - `def __init__(self, func)`

- `def bridge_metadata(metadata, **kwargs)`
    Add or update 'bridge' key in metadata dict with kwargs

- `def skip(metadata, **kwargs)`
    Convenience function to add skip=True to bridge metadata

- `def compose_first(*funcs)`
    Create a function that composes all functions in `funcs`, passing remaining `*args` and 
    `**kwargs` to first function only. `order`: key function to sort funcs before composing

- `@FC.delegates(display, keep=True) def displaydh(*objs, **kwargs)`
    `display` with `display_id`

- `def Val(v)`
    Render value with appropriate CSS class based on type

- `def NameVal(k, v)`
    Render key-value pair with name and value styling

- `class DetailsJSON`
    Interactive collapsible JSON viewer with HTML details/summary structure

    - `def __init__(self, *args, **kwargs)`
    - `def __ft__(self, d, summary, lvl, open)`

- `class HTML`
    - `def __init__(self, data, url, filename, metadata, **kwargs)`

- `def in_vscode()`
    Check if the code is running in VSCode

- `def in_vscode_notebook()`
    Check if the code is running in VSCode

- `def find_active_widgets()`
    Find all active widget instances in memory

- `def get_kernel_widgets_comms()`
    Get all widget comms from the kernel.

- `def get_active_widgets_comms()`
    Get "official" list of widget comms

- `def cleanupbridget(glbs)`
    Cleanup bridget environment

## bridget.js_transform

> Transform ES6 imports to dynamic imports for browser ESM compatibility

- `class JSImportTransform`
    - `def __init__(self, import_name, comment_marker)`
    - `def __call__(self, code)`
        Transform JS code, converting imports to dynamic and renaming import function.


## bridget.logger

> Logging and message display components for notebooks

- `class Canvas`
    Base class for output display areas in notebooks

    - `def show(self, content, **kwargs)`
    - `def hide(self)`
    - `def add(self, content, **kwargs)`
    - `def clear(self, history)`

- `class DhCanvas`
    Canvas using IPython DisplayHandle for dynamic updates

    - `def __init__(self, height)`
    - `@property def dh`
    - `def show(self, content, **kwargs)`
    - `def hide(self)`
    - `def add(self, content, **kwargs)`
    - `def clear(self)`

- `class FCanvas`
    - `def __init__(self, height, elid, **kwargs)`
    - `@classmethod def new_elid(cls)`
    - `@classmethod def tmpl(cls, elid, height, content)`
    - `def displayed(self)`
    - `def show(self, content, **kwargs)`
    - `def hide(self)`
    - `def add(self, content, **kwargs)`
    - `def clear(self)`
    - `def close(self, msg)`

- `class NBLogger`
    Notebook loggers with show/hide/log capabilities

    - `@property def canvas`
    - `def close_canvas(self)`
    - `def show(self, msg, clear, **kwargs)`
    - `def msg(self, msg, clear, **kwargs)`
    - `def clear_log(self)`
    - `def active(self, flag, msg)`
    - `def log(self, msg, clear, **kwargs)`
    - `def error(self, msg, clear, **kwargs)`
    - `def warn(self, msg, clear, **kwargs)`
    - `def __init_subclass__(cls)`

- `class NoopLogger`
    Logger that discards all messages

    - `def __getattr__(self, name)`

- `class BasicLogger`
    Simple logger that displays messages in a scrollable div

    - `def __init__(self, msg, canvas, height, show, history, **kwargs)`
    - `@property def canvas`
    - `def close_canvas(self)`
    - `def show(self, msg, clear, **kwargs)`
    - `def msg(self, msg, clear, format, fmt, truncate, sep, **kwargs)`
    - `def clear_log(self)`
    - `def active(self, flag, msg)`
    - `def history(self)`

- `class FLogger`

## bridget.nb

> Notebook cells and outputs and helpers.

- `class NBCell`
    - `def __new__(cls, cell)`
    - `def __init__(self, cell)`
    - `def __ft__(self)`
    - `def copy(self)`
    - `@cached_property def directives_(self)`
    - `def has_directive(self, directive, *args)`
    - `@cached_property def hidden(self)`

- `class NBCellRaw`

- `class NBCellMarkdown`

- `class NBCellCode`
    - `def __init__(self, cell)`

- `class NBOutput`
    - `def __new__(cls, out)`
    - `def __init__(self, out)`

- `class NBOutputStream`

- `class NBOutputDisplayData`

- `class NBOutputExecuteResult`

- `class NBOutputError`

- `def by_type(cells, cell_type)`
    Return 'L' of indices of cells of type `cell_type`

- `def idx2cell(cells, cell_type)`
    Return mapping of indices to cells of type `cell_type`

- `def withOutputs(cells)`
    Return indices of cells with outputs

- `def idx2outputs(cells)`
    Return dict of indices to cells with outputs

- `def idx2dids(cells)`
    Return dict of indices to cells with transient outputs

- `@runtime_checkable class NBProvider`
    Objects that provide access to a notebook (NB) instance

    - `@property def nb`

- `@runtime_checkable class NBProcessor`
    Callable that transforms a notebook and returns the result

    - `def __call__(self, nb, *args, **kwargs)`

- `class NB`
    Bridget representation of notebook state

    - `def __init__(self, cells, **kwargs)`
    - `def setup(self, cells, **kwargs)`
    - `@classmethod def fromStateMessage(cls, message)`
    - `@classmethod def from_NB(cls, nb, cells, **kwargs)`
    - `def as_dict(self)`
    - `def __iter__(self)`
    - `@overload def __getitem__()`
    - `def by_type(self, cell_type)`
    - `@cached_property def codes(self)`
    - `@cached_property def mds(self)`
    - `def idx2cell(self, cell_type)`
    - `@cached_property def idx2code(self)`
    - `@cached_property def idx2md(self)`
    - `@cached_property def withOutputs(self)`
    - `@cached_property def idx2outputs(self)`
    - `@cached_property def idx2dids(self)`
    - `def by_directive(self, directive, *args)`
    - `@cached_property def hiddens(self)`
    - `@cache def cell_by_did(self, did)`
    - `@cache def select(self, k)`
    - `def process(cbs, slc, pred, **kwargs)`
        Process a subset `slc` of cells filtered by `pred` with `cbs` and `FuncCB` callbacks.

    - `def pipe(self, funcs, *args, **kwargs)`
    - `def apply_diffsMessage(self, diffs)`
    - `def find(self, what, where, op)`
    - `def found(self, what, where, op, cbs)`
    - `@property def source`
    - `@property def metadata`
    - `@property def outputs`

- `class IpynbOutput`

- `class IpynbCell`

- `class St2Ipynb`
    - `def __init__(self, in_vscode)`
    - `def encodes(self, x)`
    - `def decodes(self, x)`

- `class IpynbConvertCB`
    - `def __init__(self, in_vscode)`
    - `def before_iter(self, istat)`
    - `def on_iter(self, _, cell)`

- `@FC.patch def find(self, what, where, op)`
    Find cells matching `what` in `where` using `op`

## bridget.nb_hooks

> Pure IPython facilities to help us inspect, control, and modify cell outputs.

- `class CellExecInfo`
    - `def __init__(self, start)`
    - `@property def active`
    - `def start(self)`
    - `def stop(self)`
    - `def __del__(self)`
    - `def pre_run_cell(self, info)`
    - `def post_run_cell(self, result)`

- `class Bridged`
    Augment display messages with bridge stuff.

    - `def __init__(self, start)`
    - `@property def active`
    - `def start(self)`
    - `def stop(self)`
    - `def __del__(self)`
    - `@property def dh`
    - `def bridged(self, msg)`

- `class CaptureTransformer`
    - `def __init__(self, mode)`
    - `@property def active`
    - `def start(self)`
    - `def stop(self)`
    - `def __del__(self)`
    - `def visit_Module(self, node)`

## bridget.nb_state

> Programmatic access to notebook cells and outputs.

- `class NBStateFetcher`
    Bridge plugin that retrieves notebook state from the front-end

    - `def __init__(self)`
    - `@property def opts`
    - `def update(self, timeout, **kwargs)`
    - `def aupdate(self, timeout, **kwargs)`
    - `def on_init(self, *args, **kwargs)`
    - `def on_state_update(self, *args, **kwargs)`

- `@runtime_checkable class StateProvider`
    - `@property def state`

- `class NBState`
    - `def __init__(self, source, *bridge_args, **bridge_kw)`
    - `@overload def __getitem__()`
    - `@property def state`
    - `def this(self, idx)`

- `def this(idx)`
    Current cell if `idx` is None, or cell at `idx` from current cell upwards. Raises if not found.

## bridget.nbdev_rt

> Real time [nbdev](https://nbdev.fast.ai/).

- `class NBDev_rt`
    - `def on_state_update(self, *args, **kwargs)`

- `@FC.patch def nb_export(self, nbname, nb, lib_path, procs, name, mod_maker, debug, solo_nb)`
    Create module(s) from notebook state

## bridget.prompt

> Notebooks as prompts.

- `class Prompt`
    - `@staticmethod def export(*args, **kwargs)`

## bridget.routing

> Enables method-based routing in fasthtml by extending `APIRouter` capabilities.

- `class RouteProviderP`
    A provider of routes


- `class RouteProvider`
    Base class for objects that provide routes via an APIRouter


- `class MountPoint`
    Path and name of a mount point where a group of routes can be added

    - `def mount(self, path, name)`

- `def nested_name(f)`
    Get name of function `f` using '_' to join nested function names

- `class APIRouterC`
    - `def to_app(self, app)`
        Add routes to `app`

    - `def to(**kw)`
    - `def name(self, fn)`

- `class APIRouterD`
    - `def __init__(self, *args, **kwargs)`
    - `@overload def __call__(self, *args, **kwargs)`
    - `def __set_name__(self, owner, name)`
    - `def __get__(self, instance, owner)`
    - `def to_app(self, app)`
    - `def to(**kw)`
    - `def name(self, fn)`

- `class APIRoute`
    - `def __init__(self, path, methods, name, include_in_schema, body_wrap)`
    - `def __call__(self, func)`
    - `def __getattr__(self, name)`
    - `def __set_name__(self, owner, name)`

- `def add_routes(self, prov, mount, path, name, appcls)`
    Register provider routes
</doc></api><examples><doc title="Examples" desc="Usage patterns"><!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'unsafe-inline'; img-src data:; connect-src 'self'">
    <title>Page not found &middot; GitHub Pages</title>
    <style type="text/css" media="screen">
      body {
        background-color: #f1f1f1;
        margin: 0;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      }

      .container { margin: 50px auto 40px auto; width: 600px; text-align: center; }

      a { color: #4183c4; text-decoration: none; }
      a:hover { text-decoration: underline; }

      h1 { width: 800px; position:relative; left: -100px; letter-spacing: -1px; line-height: 60px; font-size: 60px; font-weight: 100; margin: 0px 0 50px 0; text-shadow: 0 1px 0 #fff; }
      p { color: rgba(0, 0, 0, 0.5); margin: 20px 0; line-height: 1.6; }

      ul { list-style: none; margin: 25px 0; padding: 0; }
      li { display: table-cell; font-weight: bold; width: 1%; }

      .logo { display: inline-block; margin-top: 35px; }
      .logo-img-2x { display: none; }
      @media
      only screen and (-webkit-min-device-pixel-ratio: 2),
      only screen and (   min--moz-device-pixel-ratio: 2),
      only screen and (     -o-min-device-pixel-ratio: 2/1),
      only screen and (        min-device-pixel-ratio: 2),
      only screen and (                min-resolution: 192dpi),
      only screen and (                min-resolution: 2dppx) {
        .logo-img-1x { display: none; }
        .logo-img-2x { display: inline-block; }
      }

      #suggestions {
        margin-top: 35px;
        color: #ccc;
      }
      #suggestions a {
        color: #666666;
        font-weight: 200;
        font-size: 14px;
        margin: 0 10px;
      }

    </style>
  </head>
  <body>

    <div class="container">

      <h1>404</h1>
      <p><strong>File not found</strong></p>

      <p>
        The site configured at this address does not
        contain the requested file.
      </p>

      <p>
        If this is your site, make sure that the filename case matches the URL
        as well as any file permissions.<br>
        For root URLs (like <code>http://example.com/</code>) you must provide an
        <code>index.html</code> file.
      </p>

      <p>
        <a href="https://help.github.com/pages/">Read the full documentation</a>
        for more information about using <strong>GitHub Pages</strong>.
      </p>

      <div id="suggestions">
        <a href="https://githubstatus.com">GitHub Status</a> &mdash;
        <a href="https://twitter.com/githubstatus">@githubstatus</a>
      </div>

      <a href="/" class="logo logo-img-1x">
      </a>

      <a href="/" class="logo logo-img-2x">
      </a>
    </div>
  </body>
</html></doc></examples><optional><doc title="Bridget" desc="Main API and `get_app()` entry point"># Bridget



## Why Bridget?

Jupyter notebooks serve two primary functions: 1.
**Exploratory/Educational**: Interactive computing and learning 2.
**Development**: Literate programming and package creation (via nbdev)

While code creation is well-served by various notebook environments
(Jupyter, VSCode, Marimo, etc.), the display and interaction
capabilities are often limited by IPython‚Äôs well-thought but basic and
aging display system. Modern development requires:

- Rich data visualization
- Interactive system integration
- Better control over output rendering

### The Front-end Challenge

Notebooks already run in browsers (or browser-like environments), giving
us access to powerful HTML/JavaScript capabilities. The front-end and
kernel are inherently connected, suggesting we shouldn‚Äôt need additional
communication layers.

However, the notebook ecosystem is fragmented: - Jupyter (nbclassic,
Notebook, Lab): ipywidgets - VSCode/Cursor: Extensions - Marimo: Custom
solutions - Google Colab: Proprietary package

This fragmentation forces users needing better display solutions to deal
with complex, environment-specific tooling.

### Enter FastHTML and HTMX

FastHTML provides an innovative approach to web apps, emphasizing
HTML-first development through HTMX. While Jupyter support isn‚Äôt its
core focus, FastHTML itself is developed using nbdev in notebooks.

Current FastHTML notebook integration: - Launches a separate Uvicorn
server - Connects HTMX via standard HTTP/AJAX - Works across most
notebook variants

This approach is general, clean and lightweight but involves spawning a
full HTTP server with: - Multi-user capabilities (unnecessary for
notebooks) - Async architecture (notebooks are sync) - Complex lifecycle
management - Production-level features (overkill for notebook use) -
IPython Javascript display object in each cell to trigger HTMX.

### The Bridget Solution

Bridget proposes using a widget-based approach that: 1. **Simplifies**:
Replaces HTTP server with direct widget communication 2.
**Generalizes**: Works across notebook environments via AnyWidget 3.
**Extends**: Enables creation of notebook-specific components 4.
**Integrates**: Provides Python API for HTMX functionality

This proof-of-concept shows how we can maintain FastHTML‚Äôs powerful
features while better adapting to the notebook environment‚Äôs unique
characteristics and constraints.

<div>

> **Note**
>
> Personal note: My interest here isn‚Äôt web apps, but notebook
> development.
>
> I like ipywidgets, or at least the intention. I‚Äôve written several and
> used them in many personal projects. However, they‚Äôre a challenging
> piece of software with complicated tooling. They inherit all the
> nightmarish complexity of the JavaScript ecosystem, where the tooling
> is more involved than the language itself. AnyWidget is a step in the
> right direction, liberating us Pythonistas from the JS ecosystem. But
> the notebook part, the Python part, remains an unsolved problem in my
> opinion.
>
> Of all solutions I‚Äôve explored for achieving full interactivity in
> notebooks, HTMX + FastHTML comes closest, feeling more natural and
> integrating better with the notebook environment.

</div>


``` python
bridge_cfg.auto_show = True
bridge_cfg.auto_id = True
```

These flags control automatic behaviors throughout this notebook. See
`01_helpers.ipynb` for full configuration options.

# Helpers

> Some convenience utils to work with FastHTML in Notebooks.

``` python
# nb = get_nb(show_logger=True, show_feedback=True, summary=True)
# bridge = get_bridge(plugins=[HTMXCommanderPlugin()], wait=5)
bridge = get_bridge(plugins=[HTMXCommanderPlugin(), NBHooksPlugin()], show_logger=True, summary=True, wait=5)
```

Bridget automatically loads required JavaScript libraries:

1.  HTMX
2.  FastHTML core scripts
3.  Awesome gnat‚Äôs Scope and Surreal scripts
4.  Bridge helpers

These are loaded by default when creating a Bridget app. You can
customize this by overriding defaults when creating the app (covered in
app creation section)

## ClientP

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridget.py#L68"
target="_blank" style="float:right; font-size:smaller">source</a>

### ClientP

>  ClientP (*args, **kwargs)

*HTTP client interface supporting REST operations (get, post, delete)*

## Bridget utils

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridget.py#L78"
target="_blank" style="float:right; font-size:smaller">source</a>

### request2httpx_request

>  request2httpx_request (cli:httpx.AsyncClient,
>                             http_request:dict[str,typing.Any])

*Convert bridget request dict to httpx Request object*

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridget.py#L105"
target="_blank" style="float:right; font-size:smaller">source</a>

### httpx_response_to_json

>  httpx_response_to_json (response:httpx.Response)

*Convert httpx Response to JSON dict with headers and content*

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridget.py#L97"
target="_blank" style="float:right; font-size:smaller">source</a>

### request2response

>  request2response (cli:httpx.AsyncClient, http_request)

*Execute bridget request and return httpx Response*

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridget.py#L90"
target="_blank" style="float:right; font-size:smaller">source</a>

### HasHTML

>  HasHTML (*args, **kwargs)

*Objects that can render themselves as HTML strings*

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridget.py#L87"
target="_blank" style="float:right; font-size:smaller">source</a>

### HasFT

>  HasFT (*args, **kwargs)

*Objects that can convert themselves to FastHTML FT components*

``` python
@FC.patch
def _ipython_display_(self: Response):
    # dhdl = DisplayId()
    # dhdl.display(self.text)
    IDISPLAY(HTML(self.text))
```

# BridgetClient

> A mixin class that wraps FastHTML and Client functionality for
> displaying and mounting components.

Display: - FT & objects with `__ft__` or `__html__` - Mappings in the
form of HTTP requests - URLs

Mount: - APIRouter or RouteProvider

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridget.py#L125"
target="_blank" style="float:right; font-size:smaller">source</a>

### BridgetClient

>  BridgetClient ()

*A simple wrapper around `FastHTML` and `Client`.*

`BridgeClient` is a mixin class that provides:

1.  **Client functionality**:
2.  **Display functionality**: Renders FastHTML objects and route
    responses in notebook cells
3.  **Component mounting**: Helper for mounting route providers

It serves as a mixin class for
[`Bridget`](https://civvic.github.io/bridget/bridget.html#bridget),
which provides the full HTMX integration.

The class handles different types of ‚Äúbridgeable‚Äù content: - FastHTML
objects (FT) - Objects with `__ft__` or `__html__` methods - Route
paths - Request mappings

``` python
brt_cli = BridgetClient().setup()
app, rt = brt_cli.app, brt_cli.app.route

brt_cli();
```

404 Not Found
<brd-mark id="884db9a043bea536b92afc911933b57f"></brd-mark>

``` python
@app.get("/")  # type: ignore
def home():
    # return "<strong>Config</strong>: " + str(bridge_cfg.as_dict())
    # return Span(Strong('Config'), ': ' + str(bridge_cfg.as_dict()))
    return DetailsJSON(bridge_cfg.as_dict(), summary='Bridget Config').__ft__()

brt_cli();
```

``` python
@rt("/hi")
def get():
    return 'Hi there'

http_request = {
    'upload': {},
    'headers': {
        'HX-Request': 'true',
        'HX-Current-URL': 'vscode-webview://1ql27b...er'
    },
    'headerNames': {'hx-request': 'HX-Request', 'hx-current-url': 'HX-Current-URL'},
    'status': 0,
    'method': 'GET',
    'url': '/hi',
    'async': True,
    'timeout': 0,
    'withCredentials': False,
    'body': None
}

response = brt_cli._response(http_request)
test_eq(response.status_code, 200)
test_eq(response.text, 'Hi there')

console.print_json(data=(json_resp := httpx_response_to_json(response)))
test_eq(json_resp['status'], 200)
test_eq(json_resp['data'], 'Hi there')
test_eq(json_resp['headers']['content-length'], '8')

response
```

<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span>
  <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">"headers"</span>: <span style="font-weight: bold">{</span>
    <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">"vary"</span>: <span style="color: #008000; text-decoration-color: #008000">"HX-Request, HX-History-Restore-Request"</span>,
    <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">"content-length"</span>: <span style="color: #008000; text-decoration-color: #008000">"8"</span>,
    <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">"content-type"</span>: <span style="color: #008000; text-decoration-color: #008000">"text/html; charset=utf-8"</span>,
    <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">"last-modified"</span>: <span style="color: #008000; text-decoration-color: #008000">"Wed, 03 Dec 2025 14:22:36 GMT"</span>,
    <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">"cache-control"</span>: <span style="color: #008000; text-decoration-color: #008000">"no-store, no-cache, must-revalidate"</span>
  <span style="font-weight: bold">}</span>,
  <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">"status"</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">200</span>,
  <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">"statusText"</span>: <span style="color: #008000; text-decoration-color: #008000">"OK"</span>,
  <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">"data"</span>: <span style="color: #008000; text-decoration-color: #008000">"Hi there"</span>,
  <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">"xml"</span>: <span style="color: #800080; text-decoration-color: #800080; font-style: italic">null</span>,
  <span style="color: #000080; text-decoration-color: #000080; font-weight: bold">"finalUrl"</span>: <span style="color: #008000; text-decoration-color: #008000">"http://nb/hi"</span>
<span style="font-weight: bold">}</span>
</pre>
&#10;<brd-mark id="b044f5250-b2e327cd-fd825ee6-76653548"></brd-mark>

Hi there
<brd-mark id="bd5610cbf-6392de39-4751bbca-b2861446"></brd-mark>

``` python
brt_cli(http_request);
```

Hi there
<brd-mark id="09003df5a195d6ab98c71c46b3d9af96"></brd-mark>

``` python
class Buttons:
    def __ft__(self):
        return (
            Button(garlic=True, hx_get='/test', hx_select='button[vampire]', hx_swap='afterend')(_n,
                Style(self._css_.format('hsl(264 80% 47%)', 'hsl(264 80% 60%)')),
                'garlic ', Span('üßÑ', cls='icon'),
            _n), _n,
            Button(vampire=True, hx_get='/test', hx_select='button[garlic]', hx_swap='afterend')(_n,
                Style(self._css_.format('hsl(150 80% 47%)', 'hsl(150 80% 60%)')), 
                'vampire ', Span('üßõ', cls='icon'),
            _n), _n,
        )
    _css_ = '''
    me {{ margin: 4px; padding: 10px 30px; min-width: 80px; background: {0}; border-bottom: 0.5rem solid hsl(264 80% 20%); }}
    me {{ color: antiquewhite; font-size: 14pt; font-variant: all-small-caps; font-weight: bold; }}
    me:hover {{ background: {1}; }}
    me span.icon {{ font-size:16pt; }}
'''
```

``` python
@rt("/test")
def get():
    return Buttons()

http_request = {
    'headers': {'hx-request': '1'},
    'method': 'GET',
    'url': 'http://nb/test',
}

r = brt_cli._response(http_request)
display(Markdown(f"```HTML\n{r.text}\n```"))
r
```

``` html
<button garlic hx-get="/test" hx-select="button[vampire]" hx-swap="afterend">
   <style>
    me { margin: 4px; padding: 10px 30px; min-width: 80px; background: hsl(264 80% 47%); border-bottom: 0.5rem solid hsl(264 80% 20%); }
    me { color: antiquewhite; font-size: 14pt; font-variant: all-small-caps; font-weight: bold; }
    me:hover { background: hsl(264 80% 60%); }
    me span.icon { font-size:16pt; }
</style>
garlic <span class="icon">üßÑ</span>
</button>
<button vampire hx-get="/test" hx-select="button[garlic]" hx-swap="afterend">
   <style>
    me { margin: 4px; padding: 10px 30px; min-width: 80px; background: hsl(150 80% 47%); border-bottom: 0.5rem solid hsl(264 80% 20%); }
    me { color: antiquewhite; font-size: 14pt; font-variant: all-small-caps; font-weight: bold; }
    me:hover { background: hsl(150 80% 60%); }
    me span.icon { font-size:16pt; }
</style>
vampire <span class="icon">üßõ</span>
</button>
```

<button garlic hx-get="/test" hx-select="button[vampire]" hx-swap="afterend">
   <style>
    me { margin: 4px; padding: 10px 30px; min-width: 80px; background: hsl(264 80% 47%); border-bottom: 0.5rem solid hsl(264 80% 20%); }
    me { color: antiquewhite; font-size: 14pt; font-variant: all-small-caps; font-weight: bold; }
    me:hover { background: hsl(264 80% 60%); }
    me span.icon { font-size:16pt; }
</style>
garlic <span class="icon">üßÑ</span>
</button>
<button vampire hx-get="/test" hx-select="button[garlic]" hx-swap="afterend">
   <style>
    me { margin: 4px; padding: 10px 30px; min-width: 80px; background: hsl(150 80% 47%); border-bottom: 0.5rem solid hsl(264 80% 20%); }
    me { color: antiquewhite; font-size: 14pt; font-variant: all-small-caps; font-weight: bold; }
    me:hover { background: hsl(150 80% 60%); }
    me span.icon { font-size:16pt; }
</style>
vampire <span class="icon">üßõ</span>
</button>
&#10;<brd-mark id="b0a771e5b-1e6a4043-16df5c52-d77f98bf"></brd-mark>

``` python
brt_cli('/test');
```

<button garlic hx-get="/test" hx-select="button[vampire]" hx-swap="afterend">
   <style>
    me { margin: 4px; padding: 10px 30px; min-width: 80px; background: hsl(264 80% 47%); border-bottom: 0.5rem solid hsl(264 80% 20%); }
    me { color: antiquewhite; font-size: 14pt; font-variant: all-small-caps; font-weight: bold; }
    me:hover { background: hsl(264 80% 60%); }
    me span.icon { font-size:16pt; }
</style>
garlic <span class="icon">üßÑ</span>
</button>
<button vampire hx-get="/test" hx-select="button[garlic]" hx-swap="afterend">
   <style>
    me { margin: 4px; padding: 10px 30px; min-width: 80px; background: hsl(150 80% 47%); border-bottom: 0.5rem solid hsl(264 80% 20%); }
    me { color: antiquewhite; font-size: 14pt; font-variant: all-small-caps; font-weight: bold; }
    me:hover { background: hsl(150 80% 60%); }
    me span.icon { font-size:16pt; }
</style>
vampire <span class="icon">üßõ</span>
</button>
&#10;<brd-mark id="7ded6d040d05938d238c4ea81c49fa2a"></brd-mark>

``` python
brt_cli(Buttons());
```

<button garlic hx-get="/test" hx-select="button[vampire]" hx-swap="afterend">
  <style>
    me { margin: 4px; padding: 10px 30px; min-width: 80px; background: hsl(264 80% 47%); border-bottom: 0.5rem solid hsl(264 80% 20%); }
    me { color: antiquewhite; font-size: 14pt; font-variant: all-small-caps; font-weight: bold; }
    me:hover { background: hsl(264 80% 60%); }
    me span.icon { font-size:16pt; }
</style>
garlic <span class="icon">üßÑ</span>
</button>
<button vampire hx-get="/test" hx-select="button[garlic]" hx-swap="afterend">
  <style>
    me { margin: 4px; padding: 10px 30px; min-width: 80px; background: hsl(150 80% 47%); border-bottom: 0.5rem solid hsl(264 80% 20%); }
    me { color: antiquewhite; font-size: 14pt; font-variant: all-small-caps; font-weight: bold; }
    me:hover { background: hsl(150 80% 60%); }
    me span.icon { font-size:16pt; }
</style>
vampire <span class="icon">üßõ</span>
</button>
&#10;<brd-mark id="f8508c42ac4e90e839dc9c2651e329fe"></brd-mark>

``` python
# css = Style(':root {--pico-font-size:90%,--pico-font-family: Pacifico, cursive;}')

@app.route("/page")
def get():
    return (Title("Hello World"), 
            Main(H1('Hello, World'), cls="container"))

r = brt_cli._response(req := {
    # 'headers': {'hx-request': '1'},
    'method': 'GET',
    'url': 'http://nb/page',
})
display(Markdown(f"```HTML\n{r.text}\n```"))
brt_cli('page');
```

``` html
 <!doctype html>
 <html>
   <head>
     <title>Hello World</title>
     <link rel="canonical" href="http://nb/page">
<script>
    function sendmsg() {
        window.parent.postMessage({height: document.documentElement.offsetHeight}, '*');
    }
    window.onload = function() {
        sendmsg();
        document.body.addEventListener('htmx:afterSettle',    sendmsg);
        document.body.addEventListener('htmx:wsAfterMessage', sendmsg);
    };</script>   </head>
   <body>
<main class="container">       <h1>Hello, World</h1>
</main>   </body>
 </html>
```

 <title>Hello World</title>
<main class="container">   <h1>Hello, World</h1>
</main>
<brd-mark id="d3bb254d1ac71f59ad66cfd7dcd023f2"></brd-mark>

``` python
dtl = Details(cls='pale', open=True)(
    Style('me details { border: 1px solid #aaa; padding: 0.5em 0.5em 0; } me summary { font-weight: bold; margin: -0.5em -0.5em 0; padding: 0.5em; } me pre { margin: 0; }'),
    Summary('What Lucy get?'),
    Div(cls='contents', style='display: flex; flex-direction: column;')(
        Pre('She'),
        Pre('got'),
        Pre('diamonds!')
    )
)
display(dtl)
brt_cli(dtl);
```

``` html
<details open class="pale">  <style>me details { border: 1px solid #aaa; padding: 0.5em 0.5em 0; } me summary { font-weight: bold; margin: -0.5em -0.5em 0; padding: 0.5em; } me pre { margin: 0; }</style>
<summary>What Lucy get?</summary>  <div class="contents" style="display: flex; flex-direction: column;">
<pre>She</pre><pre>got</pre><pre>diamonds!</pre>  </div>
</details>
```

<details open class="pale">  <style>me details { border: 1px solid #aaa; padding: 0.5em 0.5em 0; } me summary { font-weight: bold; margin: -0.5em -0.5em 0; padding: 0.5em; } me pre { margin: 0; }</style>
<summary>What Lucy get?</summary>  <div class="contents" style="display: flex; flex-direction: column;">
<pre>She</pre><pre>got</pre><pre>diamonds!</pre>  </div>
</details>
<brd-mark id="2eb4d13a81062a09d245a1edeb7a1810"></brd-mark>

``` python
def details_ft(
        *contents, 
        summary:str|None=None, 
        closed:bool=False, 
        direction:str='column', 
        height:str|None=None,
        contents_style:str='', item_style:str=''):
    style = f"display: flex; flex-direction: {direction};{height or ''}{contents_style or ''}"
    return Details(cls='pale', open=not closed)(
        Summary(summary),
        Div(cls='contents', style=style)(
            *(Div(style=item_style)(_) for _ in contents)
        )
    )

dtl = details_ft(
        *(Pre(_) for _ in ('She', 'got', 'diamonds')), 
        summary='What Lucy get?')
display(dtl)
brt_cli(dtl);
```

``` html
<details open class="pale"><summary>What Lucy get?</summary>  <div class="contents" style="display: flex; flex-direction: column;">
    <div>
<pre>She</pre>    </div>
    <div>
<pre>got</pre>    </div>
    <div>
<pre>diamonds</pre>    </div>
  </div>
</details>
```

<details open class="pale"><summary>What Lucy get?</summary>  <div class="contents" style="display: flex; flex-direction: column;">
    <div>
<pre>She</pre>    </div>
    <div>
<pre>got</pre>    </div>
    <div>
<pre>diamonds</pre>    </div>
  </div>
</details>
<brd-mark id="a4227c1b47483e13743506a9786b8aaf"></brd-mark>

``` python
bridge.logger.show()
```

<div id='brd-logger_2-1764771735' class='brd-logger' style='width: 100%; max-height: 200px;'></div>
<brd-mark id="bca051957-dd9636d9-395456de-30d33f14"></brd-mark>

As there only one instance of a logger running, use `logger.show()` to
display the logger near a cell to see what‚Äôs going on.

``` python
<div id="output-99">Original</div>
```

<div id="output-99">Original</div>
&#10;<brd-mark id="bee6018d1-c00d2ba2-8f45b6e8-25f19f58"></brd-mark>

``` python
bridge.commander.swap('#output-99', '<div>Swapped!</div>', swapStyle='innerHTML')
```

We can also use HTMX API through Bridge (documented in
[16_bridge_plugins.ipynb](16_bridge_plugins.ipynb)).

But we‚Äôll see a more convenient way with Bridget, without peppering the
notebook of IPython Javascript display objects.

``` python
# fbridge(Div('Hey, Foo!'), display_id='ultra-cool-display-id')
Div('Hey, Foo!')
```

<div>Hey, Bar!</div>
&#10;<brd-mark id="b19bb1220-2ed4d515-97c612e0-ac834264"></brd-mark>

``` python
# bridge(Div('Hey, Bar!'), display_id=did, update=True)
dh = bridge.nbhooks.brdd.dh
brt_cli(Div('Hey, Bar!'), display_id=dh)
```

Use `display_id` and
[`update`](https://civvic.github.io/bridget/nb_hooks.html#update) kwargs
to modify or update an existing output cell.

# Bridget plugin

> A specialization of
> [`Bridge`](https://civvic.github.io/bridget/bridge.html#bridge) that
> connects HTMX with FastHTML in notebooks.

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridget.py#L242"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_bridget

>  get_bridget (app=None, logger:NBLogger|None=None, show_logger:bool=False,
>                   lnks:dict[str,FT]|None=None,
>                   esms:dict[str,str|Path]|None=None,
>                   plugins:Sequence[BridgePlugin]|None=None,
>                   kwplugins:dict[str,str]|None=None, wait:int=0,
>                   summary:bool=False, factory:Callable[...,Any]|None=None,
>                   timeout:float=10, sleep:float=0.2, n:int=10,
>                   show:Callable[[bool],None]|None=None, **kwargs)

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>app</td>
<td>NoneType</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>logger</td>
<td>NBLogger | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>show_logger</td>
<td>bool</td>
<td>False</td>
<td></td>
</tr>
<tr>
<td>lnks</td>
<td>dict[str, FT] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>esms</td>
<td>dict[str, str | Path] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>plugins</td>
<td>Sequence[BridgePlugin] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>kwplugins</td>
<td>dict[str, str] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>wait</td>
<td>int</td>
<td>0</td>
<td></td>
</tr>
<tr>
<td>summary</td>
<td>bool</td>
<td>False</td>
<td></td>
</tr>
<tr>
<td>factory</td>
<td>Callable[‚Ä¶, Any] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>timeout</td>
<td>float</td>
<td>10</td>
<td></td>
</tr>
<tr>
<td>sleep</td>
<td>float</td>
<td>0.2</td>
<td></td>
</tr>
<tr>
<td>n</td>
<td>int</td>
<td>10</td>
<td></td>
</tr>
<tr>
<td>show</td>
<td>Callable[[bool], None] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>kwargs</td>
<td>VAR_KEYWORD</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>Bridget</strong></td>
<td></td>
<td><strong>type: ignore</strong></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridget.py#L199"
target="_blank" style="float:right; font-size:smaller">source</a>

### Bridget

>  Bridget (app:fasthtml.core.FastHTML|None=None, *args, **kwargs)

*Inherit from this to have all attr accesses in `self._xtra` passed down
to `self.default`*

Bridget is a specialized widget that: 1. Inherits from `BridgeBase` for
FastHTML/display functionality 2. Uses
[AnyWidget](https://anywidget.dev/) tooling-free, general widget
solution, for browser-kernel communication 3. Implements a singleton
pattern to ensure one instance per notebook

Attributes: - `_esm`: Path to bundled JavaScript module -
`request`/`response`: Traitlets for HTMX communication -
`htmx`/`htmx_sels`: Configuration for HTMX integration

The core part is using the widget‚Äôs bidirectional communication to
replace HTMX‚Äôs HTTP transport: 1. Browser: HTMX makes requests thinking
it‚Äôs talking to a server 2. Widget: Captures these requests via
traitlets 3. Kernel: Processes requests using FastHTML routing 4.
Widget: Returns responses that HTMX understands

## Bridget JavaScript Implementation [bridget.js](bridget.js)

Bridget‚Äôs JavaScript code provides the browser-side implementation
that: 1. Intercepts HTMX AJAX requests (SSE, WS in the future) 2. Routes
them through the widget‚Äôs communication channel 3. Processes responses
back to HTMX 4. Manages HTMX initialization in notebook output cells

### Some details

#### Request Flow

1.  HTMX makes an AJAX request
2.  [xhook](https://github.com/jpillora/xhook/tree/main) intercepts it
    via `on_request`
3.  Request is serialized and sent to kernel via traitlets
4.  Kernel processes request and sends response
5.  Response is processed by `response_changed`
6.  HTMX receives response and updates DOM

#### HTMX Integration

1.  `BridgetObserver` watches for new notebook output cells
2.  New cells are processed with `htmx.process()`
3.  HTMX attributes become active
4.  AJAX requests are intercepted and routed through widget

Note that Bridget JS is backend agnostic. We‚Äôre using FastHTML here
because its the best for my quest of replacing ipywidgets as the main
form of interactivity in a notebook, but it could be any other backend
libarary.

# get_app

> Helper function to initialize the root-level app, bridget, and route.

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridget.py#L251"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_app

>  get_app (hooks=False, nb=False, cfg:Mapping|None=None,
>               logger:NBLogger|None=None, show_logger:bool=False,
>               lnks:dict[str,FT]|None=None, esms:dict[str,str|Path]|None=None,
>               plugins:Sequence[BridgePlugin]|None=None,
>               kwplugins:dict[str,str]|None=None, wait:int=0,
>               summary:bool=False, factory:Callable[...,Any]|None=None,
>               timeout:float=10, sleep:float=0.2, n:int=10,
>               show:Callable[[bool],None]|None=None, **kwargs)

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>hooks</td>
<td>bool</td>
<td>False</td>
<td></td>
</tr>
<tr>
<td>nb</td>
<td>bool</td>
<td>False</td>
<td></td>
</tr>
<tr>
<td>cfg</td>
<td>Mapping | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>logger</td>
<td>NBLogger | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>show_logger</td>
<td>bool</td>
<td>False</td>
<td></td>
</tr>
<tr>
<td>lnks</td>
<td>dict[str, FT] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>esms</td>
<td>dict[str, str | Path] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>plugins</td>
<td>Sequence[BridgePlugin] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>kwplugins</td>
<td>dict[str, str] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>wait</td>
<td>int</td>
<td>0</td>
<td></td>
</tr>
<tr>
<td>summary</td>
<td>bool</td>
<td>False</td>
<td></td>
</tr>
<tr>
<td>factory</td>
<td>Callable[‚Ä¶, Any] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>timeout</td>
<td>float</td>
<td>10</td>
<td></td>
</tr>
<tr>
<td>sleep</td>
<td>float</td>
<td>0.2</td>
<td></td>
</tr>
<tr>
<td>n</td>
<td>int</td>
<td>10</td>
<td></td>
</tr>
<tr>
<td>show</td>
<td>Callable[[bool], None] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>kwargs</td>
<td>VAR_KEYWORD</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>tuple[FastHTML, Bridget, MethodType]</strong></td>
<td></td>
<td><strong>type: ignore</strong></td>
</tr>
</tbody>
</table>

``` python
app, brt, rt = get_app(show_logger=True)
test_is(brt.app, app)
```

<div id='brd-logger_3-1764771735' class='brd-logger' style='width: 100%; max-height: 200px;'></div>
<brd-mark id="b82cbb022-7ce7730e-3c1204c4-6ef803a1"></brd-mark>

Let‚Äôs see Bridget in action.

``` python
def counter():
    n = 0
    @rt('/inc')
    def increment():
        nonlocal n
        n += 1
        return f"{n}"
    return Div()(
        Button(hx_get='/inc', hx_target='find span', hx_swap='textContent')(
            'Count: ', Span(f"{n}")))

counter()
```

``` html
<div>
<button hx-get="/inc" hx-swap="textContent" hx-target="find span">Count: <span>0</span></button></div>
```

``` python
# req = { 
#     "headers": { "HX-Request": "true", "HX-Current-URL": "vscode-webview://1ql27b0grt14rkuj26idbt9ktekivp44iu2s8pgfndvblm2j3iep/index.html?id=3d1cf833-fbc2-442d-885b-05f7dee12052&origin=1e95bb6a-280d-4f6e-8090-7f55f54cbfbd&swVersion=4&extensionId=&platform=electron&vscode-resource-base-authority=vscode-resource.vscode-cdn.net&parentOrigin=vscode-file%3A%2F%2Fvscode-app&purpose=notebookRenderer" }, 
#     "headerNames": { "hx-request": "HX-Request", "hx-current-url": "HX-Current-URL" }, 
#     "status": 0, "method": "GET", "url": "/inc", "async": True, "timeout": 0, "withCredentials": False, 
#     "body": None, 
#     "req_id": "652540cd-1ebe-4983-8701-88074dfe6328" }
```

``` python
# bridge._message_hdlr(None, {'ctx': 'bridget', 'kind': 'request', 'request': req}, None)
```

``` python
def random_hsl(saturation=50, lightness=90):
    hue = random.randint(0, 360)
    return f"hsl({hue} {saturation}% {lightness}%)"

def counter(n=0):
    @rt('/inc')
    def increment(n:int):
        return Button(f"Count: {n+1}", value=f"{n+1}", name='n', 
            hx_post='/inc', hx_swap='outerHTML', 
            style=f"background-color:{random_hsl()}; font-weight: bold")
    return increment(n-1)

counter()
```

``` html
<button value="0" name="n" hx-post="/inc" hx-swap="outerHTML" style="background-color:hsl(204 50% 90%); font-weight: bold">Count: 0</button>
```

``` python
@rt("/test")
def get():
    return Buttons()


html = Div()(
    H2('HTMX Test'),
    Div('Swapped DOM elements are styled instantly when they arrive.'),
    Buttons(),
)

# brt(html); # or simply, if bridge_cfg.auto_show is True:
html
```

``` html
<div>
  <h2>HTMX Test</h2>
  <div>Swapped DOM elements are styled instantly when they arrive.</div>
<button garlic hx-get="/test" hx-select="button[vampire]" hx-swap="afterend">
    <style>
    me { margin: 4px; padding: 10px 30px; min-width: 80px; background: hsl(264 80% 47%); border-bottom: 0.5rem solid hsl(264 80% 20%); }
    me { color: antiquewhite; font-size: 14pt; font-variant: all-small-caps; font-weight: bold; }
    me:hover { background: hsl(264 80% 60%); }
    me span.icon { font-size:16pt; }
</style>
garlic <span class="icon">üßÑ</span>
</button>
<button vampire hx-get="/test" hx-select="button[garlic]" hx-swap="afterend">
    <style>
    me { margin: 4px; padding: 10px 30px; min-width: 80px; background: hsl(150 80% 47%); border-bottom: 0.5rem solid hsl(264 80% 20%); }
    me { color: antiquewhite; font-size: 14pt; font-variant: all-small-caps; font-weight: bold; }
    me:hover { background: hsl(150 80% 60%); }
    me span.icon { font-size:16pt; }
</style>
vampire <span class="icon">üßõ</span>
</button>
</div>
```

An example from [gnat](https://github.com/gnat)‚Äôs
[css-scope-inline](https://github.com/gnat/css-scope-inline). Click the
buttons.

See [40_details_json.ipynb](40_details_json.ipynb) for a lazy JSON
browser.

<div>

> **Why are my output cells un-styled and/or inactive?**
>
> Because all changes made with Bridge/Bridget/FastHTML/HTMX are
> **transient**.

</div>

Let‚Äôs talk about what‚Äôs happening under the hood:

We‚Äôre modifying the DOM - the HTML structure in your browser - at
runtime. This is **not** a notebook editor; it‚Äôs a runtime tool. For
anything to work, you need to execute the cells.

Here‚Äôs the thing: a notebook is just **JSON**. Ultimately, output cells
are just HTML (derived from any IPython displayable object),
environments like VSCode won‚Äôt render them until display time.

When you open a notebook, tjhe front-end usually takes a lazy approach
(VSCode/Cursor more than others): - It renders existing outputs from the
JSON (including JavaScript) - But it won‚Äôt execute any cells
automatically - Even ipywidgets get special (and sometimes quirky)
treatment

Think of the notebook‚Äôs JSON as a snapshot from when you ran the cells.
Any DOM changes we make don‚Äôt get saved back to this JSON.

This means: 1. Bridge needs explicit initialization to load its JS/CSS
2. On load, saved notebooks will execute the JavaScript/HTML put there
by cell runs 3. Kernel-side code won‚Äôt run until you execute the cells

Could we make Bridget modify the actual notebook outputs? Technically,
yes, maybe. But given the labyrinthine complexity of the Jupyter
ecosystem (and the mountains of JavaScript involved), I get a headache
just thinking about it. Some mountains are better left unclimbed! üòÖ

# Simple widget

``` python
class BWidget(T.HasTraits, RouteProvider):
    bridget: Bridget = None  # type: ignore
    _mounted = False
    def __ft__(self): ...
    def _ipython_display_(self):
        brt = get_bridget()
        if bridge_cfg.auto_mount and not self._mounted: brt.mount(self, show=False)
        brt(self);
```

``` python
class BValue(BWidget):
    value=T.CInt(0).tag(sync=True)
    _updating = False
    
    def wrapper_id(self): return self.ar.name().replace(':', '_')

    @contextmanager
    def _update_ctx(self):
        self._updating = True
        yield
        self._updating = False

    @T.observe('value')
    def on_value(self, _):
        if self.bridget and not self._updating:
            self.bridget.bridge.commander.swap(f"#{self.wrapper_id()}", to_xml(self.__ft__()), swapStyle='innerHTML')

    @ar.post('/value')  # type: ignore
    def changed(self, value:int):
        with self._update_ctx(): self.value = value
        return str(value)
```

``` python
@dataclasses.dataclass
class BIntSlider(BValue):
    min:int=0; max:int=100; step:int=1; readout:bool=True; readout_format:str='d'
    
    def __ft__(self):
        if bridge_cfg.auto_mount and not self._mounted: get_bridget().mount(self, show=False)
        return Div(id=self.wrapper_id(), cls='bridget slider')(
            Label(_for='value')('Scale'), _n,
            Input(type='range', name='value', min=self.min, max=self.max, step=self.step, value=self.value,
                # hx_post=f"{self.ar.to()}{self.ar.to('changed')}", hx_trigger='input changed', 
                hx_post=self.ar.to('changed'), hx_trigger='input changed', 
                hx_target='next text', hx_swap='textContent'),
            Text(id='spanscale', style='inline')(self.value), _n
        )

app.routes.clear()

bridge_cfg.auto_mount = True

rp = BIntSlider()
rp
```

<div id="BIntSlider_BIntSlider_1-1764771735" class="bridget slider">
<label for="value">Scale</label>
  <input type="range" name="value" max="100" step="1" hx-post="/BIntSlider/BIntSlider_1-1764771735/value" hx-trigger="input changed" hx-swap="textContent" hx-target="next text">
<text id="spanscale" style="inline">0</text>
</div>
&#10;<brd-mark id="c0c8a3c073e580b183c452529904098c"></brd-mark>

``` python
rp.value = 77
```

``` python
sld2 = BIntSlider(step=2)
sld2
```

<div id="BIntSlider_BIntSlider_2-1764771735" class="bridget slider">
<label for="value">Scale</label>
  <input type="range" name="value" max="100" step="2" hx-post="/BIntSlider/BIntSlider_2-1764771735/value" hx-trigger="input changed" hx-swap="textContent" hx-target="next text">
<text id="spanscale" style="inline">0</text>
</div>
&#10;<brd-mark id="9c0c00adbf5745d30e23162c6a1be863"></brd-mark>

``` python
with bridge_cfg(auto_mount=True):
    sld3 = BIntSlider()
    sld4 = BIntSlider()
    # brt.mount(sld3, show=False)
    # brt.mount(sld4, show=False)
    T.link((sld3, 'value'), (sld4, 'value'))

(box := Div(style='display: flex; gap: 1em;')(sld3, sld4))
```

``` html
<div style="display: flex; gap: 1em;">
  <div id="BIntSlider_BIntSlider_3-1764771735" class="bridget slider">
<label for="value">Scale</label>
    <input type="range" name="value" max="100" step="1" hx-post="/BIntSlider/BIntSlider_3-1764771735/value" hx-trigger="input changed" hx-swap="textContent" hx-target="next text">
<text id="spanscale" style="inline">0</text>
  </div>
  <div id="BIntSlider_BIntSlider_4-1764771735" class="bridget slider">
<label for="value">Scale</label>
    <input type="range" name="value" max="100" step="1" hx-post="/BIntSlider/BIntSlider_4-1764771735/value" hx-trigger="input changed" hx-swap="textContent" hx-target="next text">
<text id="spanscale" style="inline">0</text>
  </div>
</div>
```

``` python
sld3.value = 22
test_eq(sld4.value, 22)
```

# Hydrate (TBD)

> Can we edit `.ipynb`s directly to capture actual output without
> `nbformat` or editing the JSON in disk?

``` python
# def hydrate(bridget=True, app: FastHTML | None=None, appkw:dict[str, Any]={}, **kwargs): 
#     app, bridge, rt = get_app(True, app, appkw=appkw, **kwargs)
#     bridget = Bridget(bridge) if bridget else None
#     return app, bridge, rt, bridget

# hydrate()
```

# What about WebSockets and SSE Support?

While HTMX supports WebSockets and Server-Sent Events (SSE) through
extensions([1](https://htmx.org/docs/#web-sockets-sse)), this
proof-of-concept focuses only on AJAX functionality for several reasons:

1.  **Core Functionality**: HTMX is primarily an AJAX framework - WS and
    SSE support are add-ons with simpler
    implementations([2](https://htmx.org/docs/#extensions))

2.  **Proof of Concept**: For demonstrating the viability of using HTMX
    in notebooks, AJAX support is sufficient

3.  **Future Extension**: Adding WS/SSE support would be straightforward
    since:

    - The notebook Comm layer already uses WebSockets
    - HTMX‚Äôs extension system is
      well-documented([3](https://htmx.org/docs/#creating-extensions))
    - The transport layer replacement pattern is already established
      with AJAX

------------------------------------------------------------------------
</doc><doc title="Bridge" desc="Low-level transport layer"># Bridge helpers





------------------------------------------------------------------------

------------------------------------------------------------------------

# Helpers

> Internal utilities for JS/Python interop. Most users won‚Äôt need these
> directly.

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridge.py#L65"
target="_blank" style="float:right; font-size:smaller">source</a>

### notdebug

>  notdebug (jsstr:str)

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridge.py#L64"
target="_blank" style="float:right; font-size:smaller">source</a>

### debug

>  debug (jsstr:str)

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridge.py#L73"
target="_blank" style="float:right; font-size:smaller">source</a>

### to_js

>  to_js (*fts:fastcore.xml.FT|str)

``` python
a = Div(P('a'), P('aa'), id='a11')
b = P('b', Span('bb'))

test_eq(_to_js(a), ['div', [['p', ['a'], {}], ['p', ['aa'], {}]], {'id': 'a11'}])
test_eq(_to_js(b), ['p', ['b', ['span', ['bb'], {}]], {}])

test_eq(to_js(a, 'const a=`${"a"}`; console.log(a)', b), """[
  ['div', [['p', ['a'], {}], ['p', ['aa'], {}]], {'id': 'a11'}],
  'const a=`${"a"}`; console.log(a)',
  ['p', ['b', ['span', ['bb'], {}]], {}]
]""")
```

``` python
a = Script('const a=`${"a"}`; console.log(a)')
b = Script(src='https://unpkg.com/htmx.org@next/dist/htmx.js', type='module')

test_eq(repr(_to_js(a)), "['script', ['const a=`${\"a\"}`; console.log(a)'], {}]")

test_eq(to_js(a, b), """[
  ['script', ['const a=`${"a"}`; console.log(a)'], {}],
  ['script', [''], {'src': 'https://unpkg.com/htmx.org@next/dist/htmx.js', 'type': 'module'}]
]""")
```

Quick & dirty way to convert `FT` to HTML elements int the front-end
using `fasthtml-js` `$E`.  
Intended only for ‚Äúlinking‚Äù/head elements (with void or text content):
script, style, link, meta, etc. It‚Äôll surely fail with other elements.

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridge.py#L80"
target="_blank" style="float:right; font-size:smaller">source</a>

### ScriptsDetails

>  ScriptsDetails (scs, title='Loaded scripts', open=True)

*Initialize self. See help(type(self)) for accurate signature.*

# Bridge scripts

`HTMX` and other useful JS libraries.

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridge.py#L100"
target="_blank" style="float:right; font-size:smaller">source</a>

### show_scripts

>  show_scripts (**scs:fastcore.xml.FT)

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridge.py#L94"
target="_blank" style="float:right; font-size:smaller">source</a>

### bridge_scripts

>  bridge_scripts (htmx=True)

``` python
bridge_scripts()
```

    {'htmx': script(('',),{'src': 'https://unpkg.com/htmx.org@next/dist/htmx.js'}),
     'fasthtml_js': script((),{'src': 'https://cdn.jsdelivr.net/gh/answerdotai/fasthtml-js@1.0.12/fasthtml.js'}),
     'surreal': script((),{'src': 'https://cdn.jsdelivr.net/gh/answerdotai/surreal@main/surreal.js'}),
     'css_scope_inline': script((),{'src': 'https://cdn.jsdelivr.net/gh/gnat/css-scope-inline@main/script.js'})}

``` python
show_scripts(**bridge_scripts())
```

<details open><summary><b>Loaded scripts</b></summary><pre>&lt;script src=&quot;https://unpkg.com/htmx.org@next/dist/htmx.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;https://cdn.jsdelivr.net/gh/answerdotai/fasthtml-js@1.0.12/fasthtml.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;https://cdn.jsdelivr.net/gh/answerdotai/surreal@main/surreal.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;https://cdn.jsdelivr.net/gh/gnat/css-scope-inline@main/script.js&quot;&gt;&lt;/script&gt;</pre></details>

# BCanvas

> [`FCanvas`](https://civvic.github.io/bridget/logger.html#fcanvas)
> associated with a bridge.

Configure the bridge logging system to display log traces here in the
notebook, a convenience that alleviates the need to open the browser
console.

NOTE: BCanvas could be a
[`Bridge`](https://civvic.github.io/bridget/bridge.html#bridge) plugin,
but it‚Äôs a separate widget instead in order to use another comm
channels. (must check if we gain something by having different Comm
channels, in the end ZMQD
[uses](https://jupyter-server.readthedocs.io/en/latest/developers/websocket-protocols.html)
one websocket under the hood, I think)

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridge.py#L122"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_bcanvas

>  get_bcanvas (height:int=200, elid:str='', **kwargs)

``` python
cleanupwidgets('cnv')
__bcanvas__ = None

cnv = get_bcanvas(timeout=DEBUG(2, 2))                
# test_eq(cnv.loaded(), True)  # in Lab something weird is happening here
```

``` python
cnv.show()
```

<div id='brd-logger_1-1764771240' class='brd-logger' style='width: 100%; max-height: 200px;'></div>

``` python
cnv.add('Why Universe, why?<br>')
```

# BLogger

> [`FLogger`](https://civvic.github.io/bridget/logger.html#flogger)
> subclass used by Bridge.

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridge.py#L130"
target="_blank" style="float:right; font-size:smaller">source</a>

### BLogger

>  BLogger (msg=None, canvas:bridget.logger.Canvas|None=None,
>               height:int=200, show:bool=True, history:bool=True, **kwargs)

*Simple logger that displays messages in a scrollable div*

``` python
lgr = BLogger('BLogger initialized')
```

<div id='brd-logger_2-1764771240' class='brd-logger' style='width: 100%; max-height: 200px;'></div>

``` python
lgr.log('test')
```

``` python
lgr.error('test')
```

``` python
lgr.warn('test')
```

``` python
lgr.log('bbbb')
```

``` python
lgr.log('cccccc', True)
```

``` python
lgr.show()
```

<div id='brd-logger_3-1764771240' class='brd-logger' style='width: 100%; max-height: 200px;'></div>

``` python
lgr.log('ddddddddd')
```

Log directly.

# Bridge bootstrap

Progressive bridge construction: Boot ‚Üí Messenger ‚Üí Bridge (with
plugins). Each layer adds functionality. Use
[`get_bridge()`](https://civvic.github.io/bridget/bridge.html#get_bridge)
to get the full-featured bridge.

## BridgeBoot

> Simply setup the bridge and connect logging.

``` python
cleanupwidgets('brd')

brd = BridgeBoot.create(show_logger=True, timeout=DEBUG(2, 2), sleep=0.2)
test_eq(brd.loaded(), True)
```

<div id='brd-logger_4-1764771240' class='brd-logger' style='width: 100%; max-height: 200px;'></div>

Note `create` blocks, it waits for the widget to be loaded (or the
default timeout, see
[`BlockingMixin`](https://civvic.github.io/bridget/bridge_widget.html#blockingmixin)).

``` python
brd.error('Erred!')
```

``` python
brd.update_logger_config(color='darkgoldenrod')  # type: ignore
```

``` python
brd.log('my trea~~sssure')
```

`lgr` now that the bridge is opened reflects both frontend and kernel
log messages and uses the JS bridge logging functionality.

``` python
scr = Script('''
const { bridge } = await brdimport('./bridge.js');
bridge.logger.log('Hi from JS land');
''', type='module')
display(HTML(scr))
time.sleep(0.1)
clear_output()
```

Log from JS land.

``` python
@FC.delegates(BridgeBoot, keep=True)  # type: ignore
def get_bridge(logger:NBLogger|None=None, show_logger:bool=False, **kwargs) -> BridgeBoot:
    if not __brd__:
        timeout, sleep = kwargs.pop('timeout', 2), kwargs.pop('sleep', 0.2)
        brd = BridgeBoot.create(logger=logger, show_logger=show_logger, timeout=timeout, sleep=sleep, **kwargs)
        return brd
    assert __brd__ is not None
    brd:BridgeBoot = __brd__
    if logger: brd.logger = logger
    if show_logger: brd.logger.show()
    return brd
```

``` python
brd = get_bridge(show_logger=True)
test_is(get_bridge(), brd)
```

<div id='brd-logger_5-1764771240' class='brd-logger' style='width: 100%; max-height: 200px;'></div>

``` python
brd.close()
test_is(__brd__ is None, True)
```

`close()` disconnect the widget and remove the widget model from the JS
bridge, so it can no longer communicate with the Python side. Besides
that, it has no effect on `bcanvas`, or the modules imported with
[`brdimport`](https://civvic.github.io/bridget/bridge.html#brdimport).
Create a new bridge to reconnect.

We need to use AnyWidget to setup the JS bridge, a class. The python
side of the bridge should be created once per notebook, no sense to have
several bridges around.

Given the nearly impossibility of creating class singletons in Python
even with metaclasses, in previous refactorizations, I‚Äôve used
`SingletonConfigurable` a-la-`getipython`. It works very well but it
uglify the code.

Anyway, given we‚Äôre-all-adults-here, you should always use
[`get_bridge`](https://civvic.github.io/bridget/bridge.html#get_bridge)
to access the bridge instance.

``` python
brd = get_bridge(show_logger=True)
```

<div id='brd-logger_6-1764771240' class='brd-logger' style='width: 100%; max-height: 200px;'></div>

# Messages from the beyond

## handle_message

``` python
class _A:
    ctx_names={'A'}
    def __init__(self): self.forward = _B()
    def on_info(self, *args, **kwargs): 
        print('A', 'info', f"{args=}", f"{kwargs=}")
    def _msg_fwrdr(self, *args, ctx:str, kind:str, **kwargs):
        if ctx == 'B':
            handle_message(self.forward, *args, ctx=ctx, kind=kind, **kwargs)
        else:
            print(f"{ctx=} Not forwarded")

class _B:
    ctx_names={'B'}
    def on_info(self, *args, **kwargs):
        print('B', 'info', f"{args=}", f"{kwargs=}")

a = _A()
test_stdout(
    lambda: handle_message(a, 'hello', ctx='A', kind='info', info='initialized'), 
    "A info args=('hello',) kwargs={'info': 'initialized'}\nctx='A' Not forwarded")
test_stdout(
    lambda: handle_message(a, 'other', ctx='B', kind='info', info='forwarded'), 
    "B info args=('other',) kwargs={'info': 'forwarded'}")
```

## BridgeMessenger

> A bridge that can receive messages from JS land.

BridgeBoot just loads the JS bridge and setup logging. Here we set the
basis for more powerful messaging to and fro JS.

``` python
@FC.delegates(BridgeMessenger, keep=True)  # type: ignore
def get_bridge(logger:NBLogger|None=None, show_logger:bool=False, **kwargs):
    if not __brd__: 
        timeout, sleep = kwargs.pop('timeout', 3), kwargs.pop('sleep', 0.2)
        brd = BridgeMessenger.create(logger=logger, show_logger=show_logger, timeout=timeout, sleep=sleep, **kwargs)
        return brd
    assert __brd__ is not None
    brd = __brd__
    if logger: brd.logger = logger
    if not logger and show_logger: brd.logger.show()
    return brd
```

``` python
cleanupwidgets('brd')

brd = get_bridge(show_logger=True, timeout=DEBUG(2, 2))
```

<div id='brd-logger_7-1764771240' class='brd-logger' style='width: 100%; max-height: 200px;'></div>

``` python
brd.debug_enabled('loader', enabled=True)
```

``` python
brd.send(brd.msg(ctx='brd', cmd='echo', args='test'))
```

``` python
msg = dict(ctx='loader', cmd='load', args={'confetti': 'https://esm.sh/canvas-confetti@1.6'}, timeout=DEBUG(1))
brd.send(msg)
```

``` python
observer_loader = anysource('''
const { getObserverManager } = await brdimport('./observer.js');
console.log(getObserverManager)
''')

brd.send(dict(ctx='loader', cmd='load', args={'get_observer': observer_loader}, reload=True), timeout=DEBUG(1))
```

    ({'ctx': 'loader',
      'kind': 'load',
      'success': ['get_observer'],
      'failed': [],
      'msg_id': 'msg-8'},
     [])

``` python
src = '''
const res = await brdimport('https://a.com/b/c.js');
console.log(res)
'''

brd.send(dict(ctx='loader', cmd='load', args={'willfail': src}, reload=True), timeout=DEBUG(1))
```

    ({'ctx': 'loader',
      'kind': 'load',
      'success': [],
      'failed': [{'name': 'willfail',
        'error': 'Failed to fetch dynamically imported module: https://a.com/b/c.js'}],
      'msg_id': 'msg-9'},
     [])

[`anysource`](https://civvic.github.io/bridget/bridge_widget.html#anysource)
doesn‚Äôt transform its arguments. Use
[`bundled`](https://civvic.github.io/bridget/bridge_widget.html#bundled)
(i.e., `Bundle.__call__(..., transform=True)`, the default), instead.

You can disabled JS transform completely with
`bridge.cfg.bundle_cfg.rewrite_imports`.

``` python
src = bundled('''
import confetti from 'https://esm.sh/canvas-confetti@1.6';
console.log(confetti)
''')(transform=False)

brd.send(dict(ctx='loader', cmd='load', args={'load_confetti': src}), timeout=DEBUG(1))
```

    ({'ctx': 'loader',
      'kind': 'load',
      'success': ['load_confetti'],
      'failed': [],
      'msg_id': 'msg-10'},
     [])

Check the JS console network tab, we imported the `confetti` module
previously.

``` python
src = anysource('''
const { confetti } = await brdimport('https://esm.sh/canvas-confetti@1.6');
console.log(confetti)
''')

brd.send(dict(ctx='loader', cmd='load', args={'load_confetti': src}, reload=True), timeout=DEBUG(1))
```

    ({'ctx': 'loader',
      'kind': 'load',
      'success': ['load_confetti'],
      'failed': [],
      'msg_id': 'msg-11'},
     [])

[`brdimport`](https://civvic.github.io/bridget/bridge.html#brdimport)
doesn‚Äôt re-import `confetti` too.

Note the `reload` argument of the `send` method. `bridge` caches the
modules by name and URL, and we‚Äôre reusing `load_confetti` name.

Use `cache=False` if you don‚Äôt want `bridge` caching the module.

# Linking elements loader

> `script` (and other links) loader for notebooks.

`FastHTML` way of loading `head` elements is fine with standard web
apps, `head` links are evaluated in order (unless they have `async` or
`defer` attributes) if present in the HTML source.

In notebooks, we need to load those `head` elements dinamically in order
(in `head`, `body` or anywhere of the front-end page). And we want to
load `fasthtml.js` (and `htmx.js` because why not) as soon as possible,
so we can use them in the same cell to define our JS extensions.

Assuming we‚Äôve already loaded `fasthtml.js`, this is a possible
solution:

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridge.py#L280"
target="_blank" style="float:right; font-size:smaller">source</a>

### Links

>  Links (*fts:fastcore.xml.FT)

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridge.py#L286"
target="_blank" style="float:right; font-size:smaller">source</a>

### load_links

>  load_links (*fts:fastcore.xml.FT, feedback:str='')

``` python
brd.logger.show()
```

<div id='brd-logger_8-1764771240' class='brd-logger' style='width: 100%; max-height: 200px;'></div>

``` python
scr = Script(notdebug('''
const { bridge } = await brdimport('./bridge.js');
bridge.logger.log('silly script');
'''), id='silly-script', type='module')

load_links(scr)
```

``` python
load_links(scr)  # see console, script was not loaded twice
```

[`load_links`](https://civvic.github.io/bridget/bridge.html#load_links)
can be used to load any link element in the front-end in order (if
bridge is active). It will auto delete the script after links are loaded
if `feedback` is None so the link won‚Äôt be reflected in the `.ipynb`
file and loaded automatically on page open.

Unfortunately, in some Jupyter environments like VSCode, this only works
if the cell is visible in the screen and is run interactively, not with
`all below` or `all above`. VSCode only renders outputs that are
visible. For an alternative, see
[`Loader`](https://civvic.github.io/bridget/bridge.html#loader) below.

``` python
B('a')
```

``` html
<b>a</b>
```

# BridgePlugin

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridge.py#L292"
target="_blank" style="float:right; font-size:smaller">source</a>

### BridgePlugin

>  BridgePlugin (ctx:str='', src:str|pathlib.Path='', bridge=None)

*Inherit from this to have all attr accesses in `self._xtra` passed down
to `self.default`*

``` python
plg = BridgePlugin('test', 'a=10')
test_eq(plg.ctx_name, 'test')
test_eq(plg.ctx_names, {'test'})
test_eq(plg.src, 'a=10')
```

# Bridge

> BridgeWidget + plugins to extend Bridge functionality in Python and/or
> JavaScript.

[`BridgeWidget`](https://civvic.github.io/bridget/bridge_widget.html#bridgewidget)
contains the core functionality, logging and JS loading. All other stuff
in this project will be developed with plugins.

``` python
def get_bridge(*plugins:BridgePlugin, kwplugins:dict[str, str]|None=None, 
    logger:NBLogger|None=None, show_logger:bool=False, **kwargs):
    "Get the bridge, creating it if not found."
    if not __brd__: 
        timeout, sleep = kwargs.pop('timeout', 2), kwargs.pop('sleep', 0.2)
        brd = Bridge.create(*plugins, kwplugins=kwplugins, logger=logger, show_logger=show_logger, 
                            timeout=timeout, sleep=sleep, **kwargs)
        return brd
    assert __brd__ is not None
    brd = __brd__
    if logger: brd.logger = logger
    if not logger and show_logger: brd.logger.show()
    return brd
```

``` python
cleanupwidgets('brd')

brd = get_bridge(show_logger=True, timeout=DEBUG(2, 2))
test_eq(brd.plugins.keys(), set(('loader', 'htmx', 'fasthtmljs')))
```

<div id='brd-logger_9-1764771240' class='brd-logger' style='width: 100%; max-height: 200px;'></div>

``` python
brd.add_plugins(badp := BridgePlugin('badp', '''export default function badp(bridge) { a = 1/0 }'''))
blocks(lambda: badp.is_initialized != None, 1)
test_is(brd.badp.is_initialized, False)
```

# InspectPlugin

``` python
class InspectPlugin(BridgePlugin):
    src = '''
function inspect(msg) {
    const {ctx, kind} = msg;
    if (kind === 'echo') {
        bridge.logger.log('echo', msg);
        setTimeout(() => {
            bridge.model.send({ ctx: ctx, kind: 'echo', msg: msg, msg_id: msg?.msg_id })
        }, 100);
        return;
    }
    bridge.model.send({ ctx: 'inspect', kind: 'inspect', msg: msg, msg_id: msg?.msg_id })
}
export default function initializeInspect(bridge) {
    bridge.on('inspect', inspect);
    return () => bridge.off('inspect');
}
'''
    ctx_name = 'inspect'

    def on_inspect(self, *args, msg:Any, tracker:Any, **kwargs):
        self.log(f"{self.__class__.__name__} inspect: {msg=} {tracker=}")
```

``` python
brd.logger.show(clear=True)
```

<div id='brd-logger_10-1764771240' class='brd-logger' style='width: 100%; max-height: 200px;'></div>

``` python
brd.add_plugins(insp := InspectPlugin())
blocks(lambda: insp.is_initialized is not None, 3)
test_is('inspect' in brd.plugins, True)
```

`add_plugin` does not blocks. If needed, use
[`blocks`](https://civvic.github.io/bridget/bridge_widget.html#blocks)
or
[`blocking`](https://civvic.github.io/bridget/bridge_widget.html#blocking)
to ensure the plugin is loaded.

``` python
# content, _ = await insp.asend(msg := insp.msg(ctx='inspect', kind='echo', data={'a': 1}))  # asend not working in Lab
content, _ = insp.send(msg := insp.msg(ctx='inspect', kind='echo', data={'a': 1}), timeout=DEBUG(1))
test_eq(content, {'ctx': 'inspect', 'kind': 'echo', 'msg': msg, 'msg_id': msg['msg_id']})
```

``` python
content, _ = insp.send(msg := insp.msg({'tracker': 'test'}, ctx='inspect', kind='echo', data={'b': 2}), timeout=DEBUG(1))
test_eq(content, {'ctx': 'inspect', 'kind': 'echo', 'msg': msg, 'msg_id': msg['msg_id']})
```

``` python
insp.src = '''
const logger = bridge.logger.create({ ns: 'inspect', color: 'green' });
function inspect(msg) {
    const {ctx, kind} = msg;
    if (kind === 'echo') {
        logger.log('echo', msg);
        setTimeout(() => {
            bridge.model.send({ ctx: ctx, kind: 'echo', msg: msg, msg_id: msg?.msg_id })
        }, 100);
        return;
    }
    bridge.model.send({ ctx: 'inspect', kind: 'inspect', msg: msg, msg_id: msg?.msg_id })
}
export default async function initializeInspect(bridge) {
    bridge.on('inspect', inspect);
    return () => { bridge.off('inspect'); logger.close(); }
}
'''
```

``` python
brd.logger.show(clear=True)
```

<div id='brd-logger_11-1764771240' class='brd-logger' style='width: 100%; max-height: 200px;'></div>

``` python
brd.add_plugins(insp)
```

``` python
insp.log("Look Ma', now greeny!")
```

``` python
content, _ = insp.send(msg := insp.msg(ctx='inspect', kind='echo', data={'a': 1}), timeout=2)
test_eq(content, {'ctx': 'inspect', 'kind': 'echo', 'msg': msg, 'msg_id': msg['msg_id']})
```

We can re-load any plugin by calling `addPlugins` again. See above
`insp` now uses a new logger.

In the examples folder, there‚Äôs an
[inspect](./examples/inspect_plugin.ipynb) plugin more fully developed.

# Loader

> Convenience python-side plugin for loading scripts and ESMs.

``` python
brd.logger.show(clear=True)
```

<div id='brd-logger_12-1764771240' class='brd-logger' style='width: 100%; max-height: 200px;'></div>

``` python
loader = Loader(dict(
    test=Script('// debugger;\nconsole.log("test")', id='test-script'),
    test2=Script('// debugger;\nconsole.log(a)', id='test-script2')
))
brd.add_plugins(loader)
test_is(brd.loader.loading, True)
test_is(brd.loader, loader)
```

``` python
loader.load_links({
    'test3': Script('// debugger;\nbridge.logger.log("test3")', id='test-script3'),
    'test4': Script('// debugger;\nbridge.logger.log(a)', id='test-script4')
})
```

``` python
loader.load({'htmx1': '''
// debugger;
import htmx from "https://unpkg.com/htmx.org@next/dist/htmx.esm.js";
console.log(htmx);
''',
    'htmx2': '''
// debugger;
import htmx from "https://unpkg.com/htmx.org@next/dist/XXXX.esm.js";
console.log(htmx);
'''})
```

``` python
blocks(lambda: loader.loaded('htmx1'), 2, show=_show)  # needed when running all above/below cells

test_eq(loader.loaded().keys(), set(('test', 'test3', 'htmx1')))
```

    ._.

``` python
test_eq(brd.loader.loaded('htmx1'), True)
test_eq(brd.loader.loaded('nah'), False)
```

[`Loader`](https://civvic.github.io/bridget/bridge.html#loader) can be
used to execute any JS code (as an EcmaScript module). Note that unlike
IPython `Javacript`, there‚Äôs no output, the code won‚Äôt run on opening
the notebook until explicitly running the cell.

``` python
brd.logger.show()
```

<div id='brd-logger_13-1764771240' class='brd-logger' style='width: 100%; max-height: 200px;'></div>

``` python
display(HTML(
    '<button type="button" onclick="const canvas=document.getElementById(\'my-canvas\');\ncanvas.confetti({spread:70, particleCount:100, origin: { y: 1 }})">Fire!</button><br>'
    '<canvas id="my-canvas" width="1000px" height="200px"></canvas>'
))
time.sleep(0.5)
loader.load({'confetti': '''
import confetti from "https://esm.sh/canvas-confetti@1.6";

function randomInRange(min, max) {
  return Math.random() * (max - min) + min;
}

const canvas = document.getElementById('my-canvas');
canvas.confetti = canvas.confetti || confetti.create(canvas, { resize: true });
'''}, reload=True)
```

<button type="button" onclick="const canvas=document.getElementById('my-canvas');
canvas.confetti({spread:70, particleCount:100, origin: { y: 1 }})">Fire!</button><br><canvas id="my-canvas" width="1000px" height="200px"></canvas>

``` python
loader.load({'beep': '''
// debugger;
export function beep() {
    var snd = new Audio("data:audio/wav;base64,//uQRAAAAWMSLwUIYAAsYkXgoQwAEaYLWfkWgAI0wWs/ItAAAGDgYtAgAyN+QWaAAihwMWm4G8QQRDiMcCBcH3Cc+CDv/7xA4Tvh9Rz/y8QADBwMWgQAZG/ILNAARQ4GLTcDeIIIhxGOBAuD7hOfBB3/94gcJ3w+o5/5eIAIAAAVwWgQAVQ2ORaIQwEMAJiDg95G4nQL7mQVWI6GwRcfsZAcsKkJvxgxEjzFUgfHoSQ9Qq7KNwqHwuB13MA4a1q/DmBrHgPcmjiGoh//EwC5nGPEmS4RcfkVKOhJf+WOgoxJclFz3kgn//dBA+ya1GhurNn8zb//9NNutNuhz31f////9vt///z+IdAEAAAK4LQIAKobHItEIYCGAExBwe8jcToF9zIKrEdDYIuP2MgOWFSE34wYiR5iqQPj0JIeoVdlG4VD4XA67mAcNa1fhzA1jwHuTRxDUQ//iYBczjHiTJcIuPyKlHQkv/LHQUYkuSi57yQT//uggfZNajQ3Vmz+Zt//+mm3Wm3Q576v////+32///5/EOgAAADVghQAAAAA//uQZAUAB1WI0PZugAAAAAoQwAAAEk3nRd2qAAAAACiDgAAAAAAABCqEEQRLCgwpBGMlJkIz8jKhGvj4k6jzRnqasNKIeoh5gI7BJaC1A1AoNBjJgbyApVS4IDlZgDU5WUAxEKDNmmALHzZp0Fkz1FMTmGFl1FMEyodIavcCAUHDWrKAIA4aa2oCgILEBupZgHvAhEBcZ6joQBxS76AgccrFlczBvKLC0QI2cBoCFvfTDAo7eoOQInqDPBtvrDEZBNYN5xwNwxQRfw8ZQ5wQVLvO8OYU+mHvFLlDh05Mdg7BT6YrRPpCBznMB2r//xKJjyyOh+cImr2/4doscwD6neZjuZR4AgAABYAAAABy1xcdQtxYBYYZdifkUDgzzXaXn98Z0oi9ILU5mBjFANmRwlVJ3/6jYDAmxaiDG3/6xjQQCCKkRb/6kg/wW+kSJ5//rLobkLSiKmqP/0ikJuDaSaSf/6JiLYLEYnW/+kXg1WRVJL/9EmQ1YZIsv/6Qzwy5qk7/+tEU0nkls3/zIUMPKNX/6yZLf+kFgAfgGyLFAUwY//uQZAUABcd5UiNPVXAAAApAAAAAE0VZQKw9ISAAACgAAAAAVQIygIElVrFkBS+Jhi+EAuu+lKAkYUEIsmEAEoMeDmCETMvfSHTGkF5RWH7kz/ESHWPAq/kcCRhqBtMdokPdM7vil7RG98A2sc7zO6ZvTdM7pmOUAZTnJW+NXxqmd41dqJ6mLTXxrPpnV8avaIf5SvL7pndPvPpndJR9Kuu8fePvuiuhorgWjp7Mf/PRjxcFCPDkW31srioCExivv9lcwKEaHsf/7ow2Fl1T/9RkXgEhYElAoCLFtMArxwivDJJ+bR1HTKJdlEoTELCIqgEwVGSQ+hIm0NbK8WXcTEI0UPoa2NbG4y2K00JEWbZavJXkYaqo9CRHS55FcZTjKEk3NKoCYUnSQ0rWxrZbFKbKIhOKPZe1cJKzZSaQrIyULHDZmV5K4xySsDRKWOruanGtjLJXFEmwaIbDLX0hIPBUQPVFVkQkDoUNfSoDgQGKPekoxeGzA4DUvnn4bxzcZrtJyipKfPNy5w+9lnXwgqsiyHNeSVpemw4bWb9psYeq//uQZBoABQt4yMVxYAIAAAkQoAAAHvYpL5m6AAgAACXDAAAAD59jblTirQe9upFsmZbpMudy7Lz1X1DYsxOOSWpfPqNX2WqktK0DMvuGwlbNj44TleLPQ+Gsfb+GOWOKJoIrWb3cIMeeON6lz2umTqMXV8Mj30yWPpjoSa9ujK8SyeJP5y5mOW1D6hvLepeveEAEDo0mgCRClOEgANv3B9a6fikgUSu/DmAMATrGx7nng5p5iimPNZsfQLYB2sDLIkzRKZOHGAaUyDcpFBSLG9MCQALgAIgQs2YunOszLSAyQYPVC2YdGGeHD2dTdJk1pAHGAWDjnkcLKFymS3RQZTInzySoBwMG0QueC3gMsCEYxUqlrcxK6k1LQQcsmyYeQPdC2YfuGPASCBkcVMQQqpVJshui1tkXQJQV0OXGAZMXSOEEBRirXbVRQW7ugq7IM7rPWSZyDlM3IuNEkxzCOJ0ny2ThNkyRai1b6ev//3dzNGzNb//4uAvHT5sURcZCFcuKLhOFs8mLAAEAt4UWAAIABAAAAAB4qbHo0tIjVkUU//uQZAwABfSFz3ZqQAAAAAngwAAAE1HjMp2qAAAAACZDgAAAD5UkTE1UgZEUExqYynN1qZvqIOREEFmBcJQkwdxiFtw0qEOkGYfRDifBui9MQg4QAHAqWtAWHoCxu1Yf4VfWLPIM2mHDFsbQEVGwyqQoQcwnfHeIkNt9YnkiaS1oizycqJrx4KOQjahZxWbcZgztj2c49nKmkId44S71j0c8eV9yDK6uPRzx5X18eDvjvQ6yKo9ZSS6l//8elePK/Lf//IInrOF/FvDoADYAGBMGb7FtErm5MXMlmPAJQVgWta7Zx2go+8xJ0UiCb8LHHdftWyLJE0QIAIsI+UbXu67dZMjmgDGCGl1H+vpF4NSDckSIkk7Vd+sxEhBQMRU8j/12UIRhzSaUdQ+rQU5kGeFxm+hb1oh6pWWmv3uvmReDl0UnvtapVaIzo1jZbf/pD6ElLqSX+rUmOQNpJFa/r+sa4e/pBlAABoAAAAA3CUgShLdGIxsY7AUABPRrgCABdDuQ5GC7DqPQCgbbJUAoRSUj+NIEig0YfyWUho1VBBBA//uQZB4ABZx5zfMakeAAAAmwAAAAF5F3P0w9GtAAACfAAAAAwLhMDmAYWMgVEG1U0FIGCBgXBXAtfMH10000EEEEEECUBYln03TTTdNBDZopopYvrTTdNa325mImNg3TTPV9q3pmY0xoO6bv3r00y+IDGid/9aaaZTGMuj9mpu9Mpio1dXrr5HERTZSmqU36A3CumzN/9Robv/Xx4v9ijkSRSNLQhAWumap82WRSBUqXStV/YcS+XVLnSS+WLDroqArFkMEsAS+eWmrUzrO0oEmE40RlMZ5+ODIkAyKAGUwZ3mVKmcamcJnMW26MRPgUw6j+LkhyHGVGYjSUUKNpuJUQoOIAyDvEyG8S5yfK6dhZc0Tx1KI/gviKL6qvvFs1+bWtaz58uUNnryq6kt5RzOCkPWlVqVX2a/EEBUdU1KrXLf40GoiiFXK///qpoiDXrOgqDR38JB0bw7SoL+ZB9o1RCkQjQ2CBYZKd/+VJxZRRZlqSkKiws0WFxUyCwsKiMy7hUVFhIaCrNQsKkTIsLivwKKigsj8XYlwt/WKi2N4d//uQRCSAAjURNIHpMZBGYiaQPSYyAAABLAAAAAAAACWAAAAApUF/Mg+0aohSIRobBAsMlO//Kk4soosy1JSFRYWaLC4qZBYWFRGZdwqKiwkNBVmoWFSJkWFxX4FFRQWR+LsS4W/rFRb/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////VEFHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAU291bmRib3kuZGUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMjAwNGh0dHA6Ly93d3cuc291bmRib3kuZGUAAAAAAAAAACU=");  
    snd.play();
}
window.$beep = beep;
'''})
display(HTML('<button type="button" onclick="window.$beep()">Beep!</button>'))
```

<button type="button" onclick="window.$beep()">Beep!</button>

# HTMX plugin

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridge.py#L437"
target="_blank" style="float:right; font-size:smaller">source</a>

### HTMXPlugin

>  HTMXPlugin (ctx:str='', src:str|pathlib.Path='', bridge=None)

*Inherit from this to have all attr accesses in `self._xtra` passed down
to `self.default`*

``` python
brd.logger.show(clear=True)
```

<div id='brd-logger_14-1764771240' class='brd-logger' style='width: 100%; max-height: 200px;'></div>

``` python
brd.add_plugins(htmxp := HTMXPlugin())
blocks(lambda: htmxp.is_initialized is not None, 2, show=_show)  # needed when running all above/below cells
```

    ._.

    True

``` python
htmxp.setup()
```

# ObserverManager

> `MutationObserver` manager for `bridget`

``` python
bundled(observer_js)(debugger=DEBUG(), ts=True);
```

``` python
brd.logger.show(clear=True)
```

<div id='brd-logger_15-1764771240' class='brd-logger' style='width: 100%; max-height: 200px;'></div>

``` python
observer_scr = Script(bundled('''
import { getObserverManager } from './observer.js';
getObserverManager();
''')(), 
    type='module', id='brd-get-observer-manager')
```

``` python
loader.load_links({'get_observer': observer_scr})  # load_links is async
```

ObserverManager is a normal ES module, just import it. But for local
development in notebooks, or until we register it, we can use the
`loader` or whatever of the many methods we now have to load JS code..

``` python
loader.loaded()
```

    {'test': script(('// debugger;\nconsole.log("test")',),{'id': 'test-script'}),
     'test3': script(('// debugger;\nbridge.logger.log("test3")',),{'id': 'test-script3'}),
     'htmx1': None,
     'confetti': None,
     'beep': None,
     'get_observer': script(('\nconst {getObserverManager} = await brdimport("./observer.js");\ngetObserverManager();\n',),{'type': 'module', 'id': 'brd-get-observer-manager'})}

``` python
brd.logger.show()
```

<div id='brd-logger_16-1764771240' class='brd-logger' style='width: 100%; max-height: 200px;'></div>

``` python
brd.loader.brdimport('./observer.js')
blocks(lambda: loader.loaded('./observer.js'), 2, show=_show)  # needed when running all above/below cells
```

    ._.

    True

``` python
test_eq(loader.loaded('./observer.js'), True)
```

We can also use with Python the equivalent to ES5 relative import
declaration (don‚Äôt forget to
[`bundled`](https://civvic.github.io/bridget/bridge_widget.html#bundled)
your source or use
[`brdimport`](https://civvic.github.io/bridget/bridge.html#brdimport)
directly).

**Front-end**:

``` js
import { getObserverManager } from './observer.js';
const observer= getObserverManager();
```

**Kernel**:

``` python
get_bridge().loader.brdimport('./observer.js')
```

``` python
observer_plugin = anysource('''
export default async function initializeObserverPlugin(bridge) {
    const { getObserverManager } = await brdimport('./observer.js');
    return [null, { getObserverManager }]
}
''')
```

or:

``` python
brd.logger.show(clear=True)
```

<div id='brd-logger_17-1764771240' class='brd-logger' style='width: 100%; max-height: 200px;'></div>

``` python
brd.add_plugins(kwplugins={'observer':observer_plugin})
```

``` python
[*brd.plugins.keys()]
```

    ['loader', 'htmx', 'fasthtmljs', 'badp', 'inspect', 'observer']

We could also add observerManager as a plugin.

# brd-mark

> Bridge plugin that defines a custom element that adds data- attributes
> to its parent and remove itself. It also processes the parent with
> htmx.

``` python
brdmark_plugin = bundled(brdmark_js)()#(debugger=DEBUG(), ts=True)
```

We could load `brd_mark` directly, but as it depends on the bridge (for
logging), better to load it as a plugin.

``` python
brd.logger.show()
```

<div id='brd-logger_18-1764771240' class='brd-logger' style='width: 100%; max-height: 200px;'></div>

``` python
brd.add_plugins(kwplugins={'brd_mark':brdmark_plugin})
```

``` python
marker = 'aaaa<brd-mark id="marker-123">'
display(HTML(marker))
```

aaaa<brd-mark id="marker-123">

``` python
print('asdf\nwerwqert')
```

    asdf
    werwqert

``` python
display(HTML('<div class="bridge">aaaa</div><brd-mark id="marker-1234"></brd-mark>'))
display(HTML('<div class="bridge">bbbb</div><brd-mark id="marker-12345"></brd-mark>'))
```

<div class="bridge">aaaa</div><brd-mark id="marker-1234"></brd-mark>

<div class="bridge">bbbb</div><brd-mark id="marker-12345"></brd-mark>

``` python
HTML(Brd_Mark(id=new_id()))
```

<brd-mark id="b47fda80c-3decdde4-66c637a1-b4d7911a"></brd-mark>

# get_bridge

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridge.py#L486"
target="_blank" style="float:right; font-size:smaller">source</a>

### show_summary

>  show_summary (brd:__main__.Bridge)

``` python
brd.logger.show()
```

<div id='brd-logger_19-1764771240' class='brd-logger' style='width: 100%; max-height: 200px;'></div>

``` python
brd.loader.load_links({
    'surreal':bridge_scripts()['surreal'],
    'css_scope_inline':bridge_scripts()['css_scope_inline'],
    })
```

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridge.py#L499"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_bridge

>  get_bridge (logger:NBLogger|None=None, show_logger:bool=False,
>                  lnks:dict[str,FT]|None=None,
>                  esms:dict[str,str|Path]|None=None,
>                  plugins:Sequence[BridgePlugin]|None=None,
>                  kwplugins:dict[str,str]|None=None, wait:int=0,
>                  summary:bool=False, factory:Callable[...,Any]|None=None,
>                  timeout:float=10, sleep:float=0.2, n:int=10,
>                  show:Callable[[bool],None]|None=None, **kwargs)

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>logger</td>
<td>NBLogger | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>show_logger</td>
<td>bool</td>
<td>False</td>
<td></td>
</tr>
<tr>
<td>lnks</td>
<td>dict[str, FT] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>esms</td>
<td>dict[str, str | Path] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>plugins</td>
<td>Sequence<a href="#bridgeplugin">BridgePlugin</a> | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>kwplugins</td>
<td>dict[str, str] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>wait</td>
<td>int</td>
<td>0</td>
<td>seconds to wait for plugins/links/modules to load</td>
</tr>
<tr>
<td>summary</td>
<td>bool</td>
<td>False</td>
<td></td>
</tr>
<tr>
<td>factory</td>
<td>Callable[‚Ä¶, Any] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>timeout</td>
<td>float</td>
<td>10</td>
<td></td>
</tr>
<tr>
<td>sleep</td>
<td>float</td>
<td>0.2</td>
<td></td>
</tr>
<tr>
<td>n</td>
<td>int</td>
<td>10</td>
<td></td>
</tr>
<tr>
<td>show</td>
<td>Callable[[bool], None] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>kwargs</td>
<td>VAR_KEYWORD</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

``` python
nbdev.show_doc(get_bridge)
```

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridge.py#L499"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_bridge

>  get_bridge (logger:NBLogger|None=None, show_logger:bool=False,
>                  lnks:dict[str,FT]|None=None,
>                  esms:dict[str,str|Path]|None=None,
>                  plugins:Sequence[BridgePlugin]|None=None,
>                  kwplugins:dict[str,str]|None=None, wait:int=0,
>                  summary:bool=False, factory:Callable[...,Any]|None=None,
>                  timeout:float=10, sleep:float=0.2, n:int=10,
>                  show:Callable[[bool],None]|None=None, **kwargs)

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>logger</td>
<td>NBLogger | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>show_logger</td>
<td>bool</td>
<td>False</td>
<td></td>
</tr>
<tr>
<td>lnks</td>
<td>dict[str, FT] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>esms</td>
<td>dict[str, str | Path] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>plugins</td>
<td>Sequence<a href="#bridgeplugin">BridgePlugin</a> | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>kwplugins</td>
<td>dict[str, str] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>wait</td>
<td>int</td>
<td>0</td>
<td>seconds to wait for plugins/links/modules to load</td>
</tr>
<tr>
<td>summary</td>
<td>bool</td>
<td>False</td>
<td></td>
</tr>
<tr>
<td>factory</td>
<td>Callable[‚Ä¶, Any] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>timeout</td>
<td>float</td>
<td>10</td>
<td></td>
</tr>
<tr>
<td>sleep</td>
<td>float</td>
<td>0.2</td>
<td></td>
</tr>
<tr>
<td>n</td>
<td>int</td>
<td>10</td>
<td></td>
</tr>
<tr>
<td>show</td>
<td>Callable[[bool], None] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>kwargs</td>
<td>VAR_KEYWORD</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

``` python
test_is(get_bridge(show_logger=True), brd)
```

<div id='brd-logger_20-1764771240' class='brd-logger' style='width: 100%; max-height: 200px;'></div>

``` python
brd.close()
test_is(__brd__, None)
```

``` python
brd.logger.clear_log()

with bridge_cfg(bootstrap=True):
    brd = get_bridge(show_logger=True, wait=5, summary=True)
```

<div id='brd-logger_21-1764771240' class='brd-logger' style='width: 100%; max-height: 200px;'></div>

<details open><summary><b>Loaded scripts</b></summary><pre>loader
htmx
fasthtmljs
observer
brd_mark
&lt;script src=&quot;https://cdn.jsdelivr.net/gh/answerdotai/surreal@main/surreal.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;https://cdn.jsdelivr.net/gh/gnat/css-scope-inline@main/script.js&quot;&gt;&lt;/script&gt;</pre></details>

``` python
html = '''
<div>üí© üëª No style.</div>

<div>
    <style> /* Simple example. */
        me { margin: 20px; }
        me div { font-size: 5rem; }
    </style>
    <div>üëª</div>
</div>
'''

display(HTML(html))
```

<div>üí© üëª No style.</div>
&#10;<div>
    <style> /* Simple example. */
        me { margin: 20px; }
        me div { font-size: 5rem; }
    </style>
    <div>üëª</div>
</div>

Bridge automatically loads some JavaScript libraries:

1.  HTMX
2.  FastHTML core scripts
3.  Awesome gnat‚Äôs Scope and Surreal scripts

When importing `bridge`, if `bridge_cfg.bootstrap` is `True` or there is
an environment variable `BRIDGET_BOOTSTRAP` set to a true-ish value, it
will automatically create a bridge.

------------------------------------------------------------------------
</doc><doc title="BridgeWidget" desc="AnyWidget communication infrastructure"># Bridge widget helpers



This module provides low-level infrastructure for Bridget: - **JS
Bundling**: Concatenate and transform JavaScript sources - **Blocking
Operations**: Block Python execution while allowing UI interaction -
**AnyWidget Base**:
[`BridgeWidget`](https://civvic.github.io/bridget/bridge_widget.html#bridgewidget)
class for bidirectional messaging


# VFile System

Hacking around to get anywidget `vfile:` working in Script and Style.
Unfortunately, it‚Äôs not a public API. If useful, we could write a
similar util for Bridget.

NOTE: `%load_ext anywidget` must have been previously run for this to
work

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridge_widget.py#L60"
target="_blank" style="float:right; font-size:smaller">source</a>

### read_vfile

>  read_vfile (cts:str)

## vfile: Components

> **FastHTML** xtend `Script` and `Style` with `vfile:` support.

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridge_widget.py#L75"
target="_blank" style="float:right; font-size:smaller">source</a>

### StyleV

>  StyleV (*c, id=None, cls=None, title=None, style=None, attrmap=None,
>              valmap=None, ft_cls=None, **kwargs)

*A Style w/ code or `vfile:` contents that doesn‚Äôt escape its code*

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>c</td>
<td>VAR_POSITIONAL</td>
<td></td>
<td></td>
</tr>
<tr>
<td>id</td>
<td>NoneType</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>cls</td>
<td>NoneType</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>title</td>
<td>NoneType</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>style</td>
<td>NoneType</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>attrmap</td>
<td>NoneType</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>valmap</td>
<td>NoneType</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>ft_cls</td>
<td>NoneType</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>kwargs</td>
<td>VAR_KEYWORD</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>FT</strong></td>
<td></td>
<td><strong>type: ignore</strong></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridge_widget.py#L70"
target="_blank" style="float:right; font-size:smaller">source</a>

### ScriptV

>  ScriptV (code:str='', id=None, cls=None, title=None, style=None,
>               attrmap=None, valmap=None, ft_cls=None, **kwargs)

*A Script w/ code or `vfile:` contents that doesn‚Äôt escape its code*

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>code</td>
<td>str</td>
<td></td>
<td></td>
</tr>
<tr>
<td>id</td>
<td>NoneType</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>cls</td>
<td>NoneType</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>title</td>
<td>NoneType</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>style</td>
<td>NoneType</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>attrmap</td>
<td>NoneType</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>valmap</td>
<td>NoneType</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>ft_cls</td>
<td>NoneType</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>kwargs</td>
<td>VAR_KEYWORD</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>FT</strong></td>
<td></td>
<td><strong>type: ignore</strong></td>
</tr>
</tbody>
</table>

## anysource

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridge_widget.py#L90"
target="_blank" style="float:right; font-size:smaller">source</a>

### anysource

>  anysource (*args:str|pathlib.Path|__main__.SourceProvider)

*Read and join text from files, vfiles or strings*

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridge_widget.py#L81"
target="_blank" style="float:right; font-size:smaller">source</a>

### SourceProvider

>  SourceProvider (*args, **kwargs)

*Object with a .source attribute (string or callable returning string)*

``` python
class Src:
    source = 'c'
test_eq(anysource('a', '', 'b', Src()), 'a\nb\nc')
```

# Bundling utilities

> Very basic JS bundler. Only concat and basic import transformation for
> now.

Two variants: async for use with `await`, sync for direct calls.  
The sync version uses `from_thread` to handle async operations.

``` python
async def bundled(*sources, debugger=False, command:str|None=None, **kwargs):
    "Concat javascript `sources`. Optionally, first run command."
    if command:
        try:
            _, stderr = await arun_command(command, **kwargs)
        except Exception as e:
            stderr = str(e)
        if stderr: raise RuntimeError(stderr)
    if debugger: return anysource('debugger;', *sources)
    return anysource(*sources)
```

``` python
test_eq(await bundled('a'), 'a')
with test_raises(FileNotFoundError):
    await bundled(Path('not_found.js'))
with test_raises(RuntimeError):
    await bundled(command='ls', cwd=Path('/not/found'))
test_eq(await bundled(command='ls', debugger=True), 'debugger;')
```

``` python
with tempfile.NamedTemporaryFile('w') as fp:
    fp.write('a')
    fp.seek(0)
    test_eq(await bundled(Path(fp.name)), 'a')
```

``` python
def bundled(*sources, debugger=False, command:str|None=None, **kwargs):
    "Concat javascript `sources`. Run `command` first if not None."
    async def _run(): return await arun_command(command, **kwargs)  # type: ignore
    if command:
        with from_thread.start_blocking_portal() as portal: 
            try: _, stderr = portal.call(_run)
            except Exception as e: stderr = str(e)
            if stderr: raise RuntimeError(stderr)
    if debugger: return anysource('debugger;', *sources)
    return anysource(*sources)
```

``` python
test_eq(bundled('a'), 'a')
with test_raises(FileNotFoundError):
    bundled(Path('not_found.js'))
with test_raises(RuntimeError):
    bundled(command='ls', cwd=Path('/not/found'))
test_eq(bundled(command='ls', debugger=True), 'debugger;')
```

``` python
with tempfile.NamedTemporaryFile('w') as fp:
    fp.write('a')
    fp.seek(0)
    test_eq(bundled(Path(fp.name)), 'a')
```

``` python
#  ./node_modules/.bin/esbuild --bundle --format=esm --outdir=bridget/js nbs/js/logger.js
```

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridge_widget.py#L148"
target="_blank" style="float:right; font-size:smaller">source</a>

### bundled

>  bundled (*sources:str|Path, bundle:bool=True, bundler:str='copy',
>               outdir:str|Path|None=None, command:str|None=None, **kwargs)

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>sources</td>
<td>str | Path</td>
<td></td>
<td>type: ignore</td>
</tr>
<tr>
<td>bundle</td>
<td>bool</td>
<td>True</td>
<td></td>
</tr>
<tr>
<td>bundler</td>
<td>str</td>
<td>copy</td>
<td></td>
</tr>
<tr>
<td>outdir</td>
<td>str | Path | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>command</td>
<td>str | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>kwargs</td>
<td>VAR_KEYWORD</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridge_widget.py#L95"
target="_blank" style="float:right; font-size:smaller">source</a>

### Bundle

>  Bundle (*sources:str|pathlib.Path, bundle:bool=True, bundler:str='copy',
>              outdir:str|pathlib.Path|None=None, command:str|None=None,
>              **cmd_kw)

*Basic JS bundler class.*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>sources</td>
<td>str | pathlib.Path</td>
<td></td>
<td>javascript source</td>
</tr>
<tr>
<td>bundle</td>
<td>bool</td>
<td>True</td>
<td>Bundle using <code>bundler</code> with sources as entry points</td>
</tr>
<tr>
<td>bundler</td>
<td>str</td>
<td>copy</td>
<td>Bundler type to use, one of ‚Äòesbuild‚Äô, ‚Äòcopy‚Äô</td>
</tr>
<tr>
<td>outdir</td>
<td>str | pathlib.Path | None</td>
<td>None</td>
<td>Output directory for bundled files</td>
</tr>
<tr>
<td>command</td>
<td>str | None</td>
<td>None</td>
<td>Run <code>command</code> first if not None</td>
</tr>
<tr>
<td>cmd_kw</td>
<td>VAR_KEYWORD</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

``` python
(f1 := Path('./js/b.js')).write_text('B');
```

``` python
bnd1 = bundled('a', f1, 'c')
test_eq(bnd1.sources, ('a', f1, 'c'))
test_eq(bnd1.bundled_sources, ('a', bnd1.outdir/ f1.name, 'c'))
test_eq(bnd1.source, 'a\nB\nc')
test_eq(bnd1(), 'a\nB\nc')
f2 = Path(bnd1.bundled_sources[1])

src = 'js/test.js'
bnd2 = bundled(Path(src))
test_eq(bnd2.bundled_sources[0], bundle_path('bridget')/src)
test_eq(bnd2.bundled_sources[0].read_text(), Path(src).read_text())  # type: ignore
f3 = Path(bnd2.bundled_sources[0])
test_eq(bnd2.bundle_path_of(src), f3)

prj_root = Path().resolve().parent
Path(src).resolve().relative_to(prj_root), f3.relative_to(prj_root)
```

    (Path('nbs/js/test.js'), Path('bridget/js/test.js'))

[`Bundle`](https://civvic.github.io/bridget/bridge_widget.html#bundle)(‚Ä¶),
or
[`bundled`](https://civvic.github.io/bridget/bridge_widget.html#bundled)(‚Ä¶),
works lazily, it simply create the bundle instance. It won‚Äôt move,
transform, or aggregate files until you explicitly call it (or retrieve
`source` or `bundled_sources`):

`bundled(..., bundle=True,bundler='copy').bundled_sources`, the default,
will just copy the sources to the outdir

``` python
with tempfile.NamedTemporaryFile('w', suffix='.js', dir='./js') as fp:
    (p := Path(fp.name)).write_text('asdfgh')
    bndl = bundled(p, bundler='esbuild')
    test_is('asdfgh' in bndl(), True)
    bndl.bundled_sources[0].unlink()  # type: ignore

bnd3 = bundled(f1, Path(src), bundler='esbuild')
test_eq(bnd3.bundled_sources, (bnd3.outdir/ f1.name, bundle_path('bridget')/src))
test_is(r'stripAnsi("\x1B[4mBridget\x1B[0m")' in bnd3(), True)
f3 = Path(bnd3.bundled_sources[1])

Path(src).resolve().relative_to(prj_root), f3.relative_to(prj_root)
```

    (Path('nbs/js/test.js'), Path('bridget/js/test.js'))

`bundled(..., bundle=True,bundler='esbuild').bundled_sources` will
bundle each Path in `sources` as entry point.

``` python
with test_raises(ValueError):
    bundled(Path('not_found.js'), bundler='esbuild')()
with test_raises(FileNotFoundError):
    bundled(bundler='esbuild', command='ls', cwd=Path('/not/found'))()
```

``` python
bnd4 = bundled('import {a,b,c} from "./js/d.js"')
test_eq(bnd4.source, 'import {a,b,c} from "./js/d.js"')

test_eq(bnd4(), 'const {a, b, c} = await brdimport("./js/d.js");')
```

Note that `source` and `__call__` are not the same.

`source` will simply concatenate all the bundled sources.

`__call__` can bundled additional sources (string or another
[`Bundle`](https://civvic.github.io/bridget/bridge_widget.html#bundle))
and will tranform the final source. This is what you should use as the
`_esm` of AnyWidgets.

``` python
test_eq(bundled(command='ls')(debugger=True), 'debugger;')

src = bundled()(debugger=True, ts=True)
print(src)
test_is('debugger;  // ' in src, True)

src = bundled('import a from "b"')(debugger=True)
test_eq(src, 'debugger;\nconst {default: a} = await brdimport("b");')
print(src)

src = bnd3('// a;', debugger=True)
cprint(src)
```

    debugger;  // 1764771018.388513
    debugger;
    const {default: a} = await brdimport("b");

<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">debugger;
<span style="color: #800080; text-decoration-color: #800080">//</span> a;
<span style="color: #800080; text-decoration-color: #800080">//</span> nbs/js/b.js
B;
&#10;<span style="color: #800080; text-decoration-color: #800080">//</span> nbs/js/test.js
debugger;
var stripAnsi = <span style="color: #800080; text-decoration-color: #800080; font-weight: bold">require_strip_ansi</span><span style="font-weight: bold">()</span>;
function <span style="color: #800080; text-decoration-color: #800080; font-weight: bold">test</span><span style="font-weight: bold">()</span> <span style="font-weight: bold">{</span>
  <span style="color: #800080; text-decoration-color: #800080; font-weight: bold">console.log</span><span style="font-weight: bold">(</span><span style="color: #008000; text-decoration-color: #008000">"test() called"</span><span style="font-weight: bold">)</span>;
  <span style="color: #800080; text-decoration-color: #800080; font-weight: bold">console.log</span><span style="font-weight: bold">(</span><span style="color: #800080; text-decoration-color: #800080; font-weight: bold">stripAnsi</span><span style="font-weight: bold">(</span><span style="color: #008000; text-decoration-color: #008000">"\x1B[4mBridget\x1B[0m"</span><span style="font-weight: bold">))</span>;
<span style="font-weight: bold">}</span>
var test_default = test;
export <span style="font-weight: bold">{</span>
  test_default as default
<span style="font-weight: bold">}</span>;
&#10;</pre>

``` python
for f in (f1, f2, f3): f.unlink(True)
```

> Resolve a JavaScript module specifier relative to a base path.

Given a string containing a module specifier like the ones used in JS
`import` declarations or `dynamic import()`, returns an absolute URL or
a local `Path` to an existing file.

[the HTML
spec](https://html.spec.whatwg.org/multipage/webappapis.html#resolve-a-module-specifier)  
[MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import#module_specifier_resolution)

``` python
show(DetailsJSON(bridge_cfg.as_dict(), summary='Bridget Config'))
```

<style>details ul { list-style-type:none; list-style-position: outside; padding-inline-start: 22px; margin: 0; } details .string { color: #24837b; } details .string::before { content: "'"; } details .string::after { content: "'"; } details .number { color: #ad8301; } details .true { color: blue; } details .false { color: red; } details .null { color: gray; } span.n { color: darkgrey; } </style>
<details open><summary>Bridget Config
</summary>  <ul>
    <li>
<span><span class="n">auto_show</span>: <span class="v false">False</span></span>    </li>
    <li>
<span><span class="n">auto_mount</span>: <span class="v false">False</span></span>    </li>
    <li>
<span><span class="n">auto_id</span>: <span class="v false">False</span></span>    </li>
    <li>
<span><span class="n">bundle_cfg</span>: <span class="v ">{&#x27;out_dir&#x27;: [Path(&#x27;/Users/vic/dev/repo/project/bridget/nbs/js&#x27;), Path(&#x27;/Users/vic/dev/repo/project/bridget/nbs&#x27;), Path(&#x27;/Users/vic/dev/repo/‚Ä¶</span></span>    </li>
    <li>
<span><span class="n">bootstrap</span>: <span class="v false">False</span></span>    </li>
    <li>
<span><span class="n">current_did</span>: <span class="v null">None</span></span>    </li>
  </ul>
</details>

``` python
cprint(bridge_cfg.bundle_cfg.out_dir)
```

``` python
if BUNDLE_PATH.resolve() not in (cfg := bridge_cfg.bundle_cfg).out_dir:
    cfg.update(out_dir=[BUNDLE_PATH, *cfg.out_dir])
cprint(bridge_cfg.bundle_cfg.out_dir)
```

By default, Bridget looks for JS files in: - the python bundle, if it
can be determined (use `bridge_cfg.for_module(...)`) -
`nbdev.config.get_config().lib_path` / ‚Äòjs‚Äô and
`nbdev.config.get_config().lib_path` / ‚Äòjs‚Äô, if found - `Path.cwd()` and
`Path.cwd()`/‚Äòjs‚Äô at time of call

More locations can be added by modifying the `out_dir` of the
`bundle_cfg` object.

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridge_widget.py#L167"
target="_blank" style="float:right; font-size:smaller">source</a>

### resolve_ESM

>  resolve_ESM (spec:str, base:str|pathlib.Path|None=None)

*Resolve a JavaScript module specifier relative to `base` or
`bundle_cfg.out_dir`.*

``` python
test_eq(resolve_ESM('./non-existent.js'), None)
test_eq(resolve_ESM('/non-existent.js'), None)
test_eq(resolve_ESM('./bridge.js'), Path('./js/bridge.js').resolve())
```

Test relative specifiers (these will depend on actual files existing)

``` python
test_eq(resolve_ESM('asdfretgs'), None)
test_eq(resolve_ESM('asdfretgs:wrwteryeyt'), None)

result = cast(ParseResult, resolve_ESM('https://unpkg.com/htmx.org@next/dist/htmx.js'))
test_eq(result.scheme, 'https')
test_eq(result.netloc, 'unpkg.com')

result = cast(ParseResult, resolve_ESM('data:text/javascript,export default 42;'))
test_eq(result.scheme, 'data')

test_eq(resolve_ESM('file:///path/to/x.js'), None)
test_eq(resolve_ESM('FILE:///observer.js', Path('./js')), Path('js/observer.js'))
```

``` python
# result = resolve_ESM('data:application/json,{"foo":42}', { type="json" })
# test_eq(result.scheme, 'data')
```

Absolute specifiers (URLs)

``` python
test_eq(resolve_ESM('lodash'), None)
test_eq(resolve_ESM('observer.js', Path('./js')), None)
```

Test bare specifiers (TBD, not yet supported)

Look up for JS files in well-known locations and return the contents

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridge_widget.py#L177"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_ESM

>  get_ESM (module_spec)

*Contents of a JS module*

``` python
test_eq(get_ESM('lodash'), None)
test_eq(get_ESM('./test.js'), Path('./js/test.js').read_text())
test_eq(get_ESM('https://a'), 'https://a')
```

``` python
with tempfile.NamedTemporaryFile('w', dir='./js') as fp:
    p = Path(fp.name)
    p.write_text('import {a} from "b"')
    n = f"/{p.relative_to(Path('./js').resolve())}"
    test_eq(get_ESM(n), 'const {a} = await brdimport("b");')
```

# BlockingWidget

## JS -\> Python

``` python
class Cons(anywidget.AnyWidget):
    _esm = '''
export default {
  async initialize({ model, experimental }) {
    model.on("msg:custom", async (cmd) => {
      const { kind, msg, timeout } = cmd;
      if (kind === 'brd-command') {
        let [res, buffers] = await experimental.invoke("_upper", msg, {signal: AbortSignal.timeout(timeout)});
        console.log(res);
      } else console.log(cmd);
    }); 
  },
};
'''
    @anywidget.experimental.command  # type: ignore
    def _upper(self, msg, buffers):
        # print(f'{msg=} {buffers=}')
        return msg.upper(), buffers
    
    def to_console(self, msg):
        self.send({'kind': 'brd-command', 'msg': msg, 'timeout': 5e3})
```

``` python
from bridget.helpers import find_active_widgets, get_kernel_widgets_comms, get_active_widgets_comms
```

``` python
ww = find_active_widgets()
ww
```

    []

``` python
w = Cons()
```

``` python
w.to_console('Hello, worlds!')
```

The (still) experimental `invoke` feature of `AnyWidget` allows for
blocking operations frontend-backend.  
We‚Äôll also need the other way around, but that‚Äôs is surprisingly more
involved.

## Python -\> JS

``` python
from matplotlib import pyplot as plt
import numpy as np
```

``` python
base = 1.5
fig = plt.figure()#figsize=(4, 2.67))
plt.plot(base + base**np.arange(10));
```

![](10_bridge_widget_files/figure-commonmark/cell-42-output-1.png)

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridge_widget.py#L184"
target="_blank" style="float:right; font-size:smaller">source</a>

### exp_backoff

>  exp_backoff (base:float=1.552, max_value:float=10.0)

*Exponential backoff generator of values until cumulative value is
max_value, then yields 0 and stops.*

``` python
list(itertools.takewhile(lambda t: t, exp_backoff()))
```

    [1.552, 2.408704, 3.7383086080000005, 2.3009873919999997]

``` python
list(itertools.takewhile(lambda t: t, exp_backoff(max_value=60)))
```

    [1.552,
     2.408704,
     3.7383086080000005,
     5.8018549596160005,
     9.004478897324033,
     13.9749512486469,
     21.68912433789999,
     1.8305779485130742]

``` python
list(itertools.takewhile(lambda t:t, exp_backoff(0.4, 3)))
```

    [0.4, 0.8, 1.2000000000000002, 0.5999999999999996]

``` python
list(itertools.takewhile(lambda t:t, exp_backoff(1*0.0776, 1)))
```

    [0.0776, 0.1552, 0.2328, 0.3104, 0.22399999999999998]

``` python
boff = iter(exp_backoff())
t, sum = 1, 0
while t:
    sum += (t := next(boff))
    print(f"t: {t:0.4f} sum: {sum:0.4f}")
```

    t: 1.5520 sum: 1.5520
    t: 2.4087 sum: 3.9607
    t: 3.7383 sum: 7.6990
    t: 2.3010 sum: 10.0000
    t: 0.0000 sum: 10.0000

``` python
tm = 5.0
boff = iter(exp_backoff(tm*0.1, tm))
t, sum = 1, 0
while t:
    sum += (t := next(boff))
    print(f"t: {t:0.4f} sum: {sum:0.4f}")
```

    t: 0.5000 sum: 0.5000
    t: 1.0000 sum: 1.5000
    t: 1.5000 sum: 3.0000
    t: 2.0000 sum: 5.0000
    t: 0.0000 sum: 5.0000

``` python
class BlockingMixin(W.Widget):
    "A mixin for widgets that supports blocking custom messages with the front-end."
    _cbs: CallbackDispatcher

    def on_msg(self, cb, remove=False):
        if not hasattr(self, '_cbs'): self._cbs = CallbackDispatcher()
        self._cbs.register_callback(cb, remove=remove)
        super().on_msg(cb, remove=remove)

    def send(self, msg, timeout: float|None=None, buffers=None, 
            sleep: float = 1/15, n: int = 10, show: Callable[[bool], None]|None = None
    ) -> tuple[Any|Empty, Any|Empty]|None:
        "Send `msg` to the front-end. If `timeout` seconds is not None, calling blocks."
        if timeout is None: 
            for cb in self._cbs.callbacks: super().on_msg(cb)
            return super().send(msg, buffers)
        for cb in self._cbs.callbacks: super().on_msg(cb, remove=True)
        res = self._send_msg(msg, buffers,timeout, sleep, n, show)
        # NOTE: restoring normal callbacks now implies that front-end can yet send back a result
        # even if python timeout was triggered.
        for cb in self._cbs.callbacks: super().on_msg(cb)
        return res
    
    async def asend(self, msg, timeout: float=5.0, buffers=None, 
            sleep: float = 1/15, n: int = 10, show: Callable[[bool], None]|None = None
    ) -> tuple[Any|Empty, Any|Empty]|None:
        "Send `msg` to the front-end. Call will end after `timeout` seconds if `timeout` is not None."
        for cb in self._cbs.callbacks: super().on_msg(cb, remove=True)
        res = await self._asend_msg(msg, buffers, timeout, sleep, n, show)
        for cb in self._cbs.callbacks: super().on_msg(cb)
        return res

    def _send_msg(self, msg, buffers=None, timeout: float = 5.0, 
            sleep: float = 1/15, n: int = 10, show: Callable[[bool], None]|None = None
    ) -> tuple[Any|Empty, Any|Empty]:
        "Send blocking `msg` to the front-end. Return response tuple (content, buffers), or (empty, empty) if `timeout`."
        boff = iter(exp_backoff(timeout*0.776, timeout))
        timeout, start_time = next(boff), time.time()
        result = None
        def _on_msg(_, msg, buffers):
            nonlocal result
            if result is None: result = (msg, buffers)
        super().on_msg(_on_msg)  # register transient callback
        try:
            super().send(msg, buffers)
            with ui_events() as ui_poll:
                while True:
                    if sleep: time.sleep(sleep)
                    ui_poll(n)
                    if (time.time() - start_time) > timeout:
                        timeout, start_time = next(boff), time.time()
                        if not timeout: result = (empty, empty)
                    if result is not None:
                        content, buffers = result
                        if content is empty: return (empty, empty)
                        self._cbs(self, content, buffers)
                        return content, buffers
                    if show: show(False)
        except Exception as e:
            if isinstance(e, RuntimeError): raise
            raise RuntimeError(f"Error during message processing: {str(e)}") from e
        finally:
            super().on_msg(_on_msg, True)  # unregister callback
            if show: show(True)

    async def _asend_msg(self, msg, buffers=None, timeout: float = 5.0, 
            sleep: float = 1/15, n: int = 10, show: Callable[[bool], None]|None = None
    ) -> tuple[Any|Empty, Any|Empty]:
        "Send async `msg` to the front-end. Return response tuple (content, buffers), or (empty, empty) if `timeout`."
        boff = iter(exp_backoff(timeout*0.776, timeout))
        timeout, start_time = next(boff), time.time()
        result = None
        def _on_msg(w, msg, buffers):
            nonlocal result
            if result is None: result = (msg, buffers)
        super().on_msg(_on_msg)
        try:
            super().send(msg, buffers)
            async with ui_events() as ui_poll:
                while True:
                    await ui_poll(10)
                    if (time.time() - start_time) > timeout:
                        timeout, start_time = next(boff), time.time()
                        if not timeout: result = (empty, empty)
                    if result is not None:
                        content, buffers = result
                        if content is empty: return (empty, empty)
                        self._cbs(self, content, buffers)
                        return (content, buffers)
                    if sleep: await anyio.sleep(sleep)
                    if show: show(False)
        except Exception as e:
            if isinstance(e, RuntimeError): raise
            raise RuntimeError(f"Error during message processing: {str(e)}") from e
        finally:
            super().on_msg(_on_msg, True)
            if show: show(True)
```

### blocks

> functions to block until a condition is met without blocking front-end
> interaction.

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridge_widget.py#L247"
target="_blank" style="float:right; font-size:smaller">source</a>

### blocking

>  blocking (timeout:float=1, sleep:float=0.2, n:int=10,
>                show:Optional[Callable[[bool],NoneType]]=None)

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridge_widget.py#L226"
target="_blank" style="float:right; font-size:smaller">source</a>

### ablocks

>  ablocks (pred:Callable[...,bool], timeout:float=1, sleep:float=0.2,
>               n:int=10, show:Optional[Callable[[bool],NoneType]]=None)

*Return True when `pred` returns True, or False when at least `timeout`
seconds have passed.*

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridge_widget.py#L204"
target="_blank" style="float:right; font-size:smaller">source</a>

### blocks

>  blocks (pred:Callable[...,bool], timeout:float=1, sleep:float=0.2,
>              n:int=10, show:Optional[Callable[[bool],NoneType]]=None)

*Block until `pred` is True, or at least `timeout` seconds have passed.
Return `False` if timeout.*

``` python
class Cnt:
    def __init__(self, n=10, sleep=0.0): self.n, self.sleep, self.cnt = n, sleep, 0
    def __call__(self):
        self.cnt += 1
        time.sleep(self.sleep)
        return self.cnt > self.n-1

blocks(cntr := Cnt(10), n=20, sleep=0.1, show=_show)
test_eq(cntr.cnt, 10)
```

    ._.

``` python
done = await ablocks(cntr := Cnt(10, 0.2), show=_show)
if done: test_eq(cntr.cnt, 10)
else: print('timeout')
```

    ._.
    timeout

``` python
with blocking(n=20, sleep=0.0, show=_show) as pred:
    cntr = Cnt(10)
    test_is(pred(cntr), True)
    test_eq(cntr.cnt, 10)
```

    ._.

``` python
with blocking(show=_show) as pred:
    cntr = Cnt(10, 0.2)
    done = pred(cntr)
    if done: test_eq(cntr.cnt, 10)
    else: print('timeout')
```

    ._.
    timeout

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridge_widget.py#L256"
target="_blank" style="float:right; font-size:smaller">source</a>

### BlockingMixin

>  BlockingMixin (**kwargs)

*Mixin for widgets that supports blocking custom messages with the
front-end.*

``` python
class BlockingWidget(anywidget.AnyWidget, BlockingMixin):
    _esm = anysource('// debugger;', '''
    export default { 
        async initialize({ model }) {
            function on_msg(msg) {
                console.log(`Received message:`, msg);
                if (!msg?.timeout) return model.send({ msg_id: msg.msg_id, response: 'no timeout' });
                (function loop(n) {
                    setTimeout(() => {
                        n += 100
                        if (n > msg.timeout*1000) {
                            console.log(`Sending response for msg_id:`, msg.msg_id);
                            model.send({ msg_id: msg.msg_id, response: 'done waiting', error: null });
                            return;
                        }
                        // console.log('.');
                        loop(n);
                    }, 100);
                })(0);
            }
            model.on("msg:custom", on_msg);
            setTimeout(() => {
                console.log(`Initialized.`);
                model.set('_loaded', true); model.save_changes();
            }, 1000);
        }
    };
    ''')

    def test_send(self, msg, buffers=None, *, timeout: float|None=None, 
            sleep: float = 1/15, n: int = 10, show: Callable[[bool], None]|None = None):
        self._start_time = time.time()
        print(f'Sending message {msg}...')
        res = self.send(msg, buffers, timeout=timeout, sleep=sleep, n=n, show=show)
        return None if res == (empty, empty) else res
    
    async def test_asend(self, msg, buffers=None, *, timeout: float=5.0, 
        sleep: float = 1/15, n: int = 10, show: Callable[[bool], None]|None = None
    ):
        self._start_time = time.time()
        print(f'Sending message {msg}...')
        res = await self.asend(msg, buffers, timeout=timeout, sleep=sleep, n=n, show=show)
        return None if res == (empty, empty) else res

    def __init__(self, *args, **kwargs):
        # self.setup_init_on_msg(self._handle_message)
        self.on_msg(self._handle_message)
        super().__init__(*args, **kwargs)
        print('Initializing...')

    def _handle_message(self, _, msg, buffers):
        e = time.time()
        self._last_message = e, msg
        print(f'\nelapsed: {e-self._start_time:.3f}s Received message: {msg}, buffers: {buffers}')
```

``` python
cleanupwidgets('w')

w = BlockingWidget()
test_eq(w.loaded(), False)
```

    Initializing...

``` python
idx = kounter('blocking')
print(idx)
w.test_send({'msg_id': idx})
```

    1
    Sending message {'msg_id': 1}...

``` python
cleanupwidgets('w')

w = BlockingWidget.create(show=_show, sleep=0.1)
print(f'loaded={w.loaded()}')
test_eq(w.loaded(), True)
```

    Initializing...
    ._.
    loaded=True

``` python
idx = kounter('blocking')
a = w.test_send({'msg_id': idx, 'timeout': 2}, timeout=1, show=_show)
print(f"{idx=} ->", f"Timeout {time.time()-w._start_time:3f}" if not a else f"{a=}")
test_is(a, None)
```

    Sending message {'msg_id': 2, 'timeout': 2}...
    ._.
    idx=2 -> Timeout 1.162399

``` python
idx = kounter('blocking')
a = w.test_send({'msg_id': idx, 'timeout': 2}, timeout=3, show=_show)
print(f"{idx=} ->", f"Timeout {time.time()-w._start_time:3f}" if not a else f"{a=}")
test_eq(a[0]['msg_id'], idx)  # type: ignore
```

    Sending message {'msg_id': 3, 'timeout': 2}...
    ._.
    idx=3 -> a=({'msg_id': 3, 'response': 'done waiting', 'error': None}, [])

``` python
# cell 95
idx = kounter('blocking')
# a = await w.test_asend({'msg_id': idx, 'timeout': 2}, timeout=1, show=_show)  # async send not working fine in Lab
a = w.test_send({'msg_id': idx, 'timeout': 2}, timeout=1, show=_show)
```

    Sending message {'msg_id': 4, 'timeout': 2}...
    ._.

``` python
print(f"{idx=} ->", f"Timeout {time.time()-w._start_time:3f}" if not a else f"{a=}")
test_is(a, None)
```

    idx=4 -> Timeout 2.071541

``` python
# cell 97

idx = kounter('blocking')
# a = await w.test_asend({'msg_id': idx, 'timeout': 2}, timeout=3, show=_show)  # async send not working fine in Lab
a = w.test_send({'msg_id': idx, 'timeout': 2}, timeout=3, show=_show)
```

    Sending message {'msg_id': 5, 'timeout': 2}...
    ._.

``` python
print(f"{idx=} ->", f"Timeout {time.time()-w._start_time:3f}" if not a else f"{a=}")
test_eq(a[0]['msg_id'], idx)  # type: ignore
```

    idx=5 -> a=({'msg_id': 5, 'response': 'done waiting', 'error': None}, [])

``` python
cleanupwidgets('w')
```

``` python
from bridget.helpers import find_active_widgets, get_kernel_widgets_comms, get_active_widgets_comms
```

``` python
ww = find_active_widgets()
ww
```

    [{'type': 'BlockingWidget',
      'model_id': 'f6e695c02332468c8fb9eebaa82b209b',
      'comm': False},
     {'type': 'Layout',
      'model_id': '73f02d3c1cf141d2a4729292217c4a32',
      'comm': False},
     {'type': 'BlockingWidget',
      'model_id': 'a7455c7f4ad04efa850f3a8cb964e6d6',
      'comm': False},
     {'type': 'Layout',
      'model_id': '4686dc666c0b464c8ef9047c0a97ea2d',
      'comm': False},
     {'type': 'Cons',
      'model_id': 'd024a861a43e4e6da226d96e6234c25d',
      'comm': False},
     {'type': 'Layout',
      'model_id': '925cf3052d664de8b9f9e2a8a70268de',
      'comm': False}]

``` python
import ipywidgets.widgets.widget
```

``` python
ipywidgets.widgets.widget._instances
```

    {}

``` python
[_.comm_id for _ in get_active_widgets_comms()]
```

    []

# BridgeWidget

> A widget that bundles its ESM source and (optionaly) blocks until
> loaded.

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridge_widget.py#L365"
target="_blank" style="float:right; font-size:smaller">source</a>

### BridgeWidget

>  BridgeWidget (*args, **kwargs)

*Main AnyWidget base class.*

# brdimport

> Widget to upload the
> [`brdimport`](https://civvic.github.io/bridget/bridge.html#brdimport)
> module to the front-end, the bare minimum we need to start bridging.

``` python
# cell 101
brdimport = BridgeImport()
# needed when running all cells if we want to ensure brdimport is in place
blocks(lambda: brdimport._loaded, 3, sleep=0.2, show=_show);
```

    ._.

``` python
if brdimport._loaded:
    test_is(__brdimport__ is not None, True)
    test_eq(brdimport._modules, ())
```

``` python
confetti_scr = Script('''
const res = await brdimport('https://esm.sh/canvas-confetti@1.6');
console.log(res);
''', type='module')
HTML(confetti_scr)
```

<script type="module">
const res = await brdimport('https://esm.sh/canvas-confetti@1.6');
console.log(res);
</script>

``` python
to = blocks(lambda: len(brdimport._modules) > 0, 5, sleep=0.2)
if not to: test_eq(brdimport._modules, ('https://esm.sh/canvas-confetti@1.6',))
```

``` python
non_existent_scr = Script('''
const res = await brdimport('https://a.com/b/c.js');
console.log(res)
''', type='module')
HTML(non_existent_scr)
```

<script type="module">
const res = await brdimport('https://a.com/b/c.js');
console.log(res)
</script>

``` python
test_eq(brdimport._modules, ('https://esm.sh/canvas-confetti@1.6',))
```

``` python
observer_scr = Script('''
const { getObserverManager } = await brdimport('./js/observer.js');
console.log(getObserverManager)
''', type='module')
HTML(observer_scr)
```

<script type="module">
const { getObserverManager } = await brdimport('./js/observer.js');
console.log(getObserverManager)
</script>

``` python
to = blocks(lambda: len(brdimport._modules) > 1, 5, sleep=0.2)
if not to: test_eq(set(brdimport._modules), set(('https://esm.sh/canvas-confetti@1.6', './js/observer.js')))
```

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/bridge_widget.py#L410"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_brdimport

>  get_brdimport ()

[`brdimport`](https://civvic.github.io/bridget/bridge.html#brdimport)
module is unconditionally loaded.

``` python
cleanupwidgets(__brdimport__)
```

``` python
from bridget.helpers import find_active_widgets, get_kernel_widgets_comms, get_active_widgets_comms
```

``` python
ww = find_active_widgets()
ww
```

    [{'type': 'BlockingWidget',
      'model_id': 'a7455c7f4ad04efa850f3a8cb964e6d6',
      'comm': False},
     {'type': 'Layout',
      'model_id': '4686dc666c0b464c8ef9047c0a97ea2d',
      'comm': False},
     {'type': 'BridgeImport',
      'model_id': '6b75a2537d514884862cb3519e495d6a',
      'comm': False},
     {'type': 'Layout',
      'model_id': 'eee943ecd57f453590f6eadf4ddaefbd',
      'comm': False},
     {'type': 'Cons',
      'model_id': 'd024a861a43e4e6da226d96e6234c25d',
      'comm': False},
     {'type': 'Layout',
      'model_id': '925cf3052d664de8b9f9e2a8a70268de',
      'comm': False}]

``` python
import ipywidgets.widgets.widget
```

``` python
ipywidgets.widgets.widget._instances
```

    {}

``` python
[_.comm_id for _ in get_active_widgets_comms()]
```

    []

------------------------------------------------------------------------</doc><doc title="Route Provider" desc="Extended routing for Python methods"># Routes provider




``` python
def get_app():
    return (app := nb_app()), TestClient(app, base_url='http://nb', headers={'hx-request': '1'}), app.route

app, cli, rt = get_app()
```

# patched

> Quick hack to monkey-patch a module function.

`FastHTML` only considers as of now (v.0.12.0) names of static (possibly
nested) functions. We‚Äôll need to temporarily patch
[`nested_name`](https://civvic.github.io/bridget/route_provider.html#nested_name)
to get name of methods (see
[`APIRouterD`](https://civvic.github.io/bridget/route_provider.html#apirouterd)
below).

# Methods as routes endpoints

> Understanding FastHTML‚Äôs routing system and extending it to support
> instance methods.

<div>

> **Note**
>
> In this docs I use widget/component interchangeably.

</div>

### Why Method-Based Routes in Notebooks?

FastHTML typically encourages defining components in separate modules.
While this works great for web applications, notebooks have different
workflows:

**Interactive Development**  
Notebooks are all about exploration and rapid prototyping. Everything
happens in cells - they‚Äôre our unit of work. Notebooks are more akin to
one page apps. When you‚Äôre quickly testing ideas or building one-time
components, creating separate modules can feel like unnecessary
overhead. Method-based routes let us define and test components right
where we need them, with scoping and encapsulation.

**State Management**  
When building widgets, we often need to maintain state. Instance methods
make this natural. While both modules and classes can handle state
effectively, sometimes one approach fits better than the other. It‚Äôs
nice to have options.

**Quick Iteration**  
The real advantage comes when you‚Äôre iterating on a component. You can
write code, test it, and modify it all in the same context. Make a
change, run the cell, see the results. No jumping between files or
reloading modules needed.

This approach may complement FastHTML‚Äôs module-based components by
providing another option for route management.

# Scoping

<div>

> **Note**
>
> All this discussion is for current FastHTML, v0.12.0 at the time of
> this writing. FastHTML is young and nervous, so things may change
> quickly and unexpectedly.

</div>

``` python
app, cli, rt = get_app()

def a(): return 'a'  # type: ignore
test_eq(type(a), FunctionType)
test_eq(str(a), f"<function a at 0x{id(a):x}>")

global_a = a


# @rt('/a', 'get')
# def a(): return 'a'

# or its nearly equivalent:
a = rt('/a', 'get')(a)

assert a is not global_a
test_eq(str(a), '/a')
test_eq(cli.get('/a').text, 'a')
test_eq(app.url_path_for('a'), '/a')
test_eq(a.to(), '/a')
test_eq(set(app.routes[-1].methods), {'GET', 'HEAD'})  # type: ignore


@rt('/a', 'post')
def a(x:int): return f'a {x}'

test_eq(cli.post('/a?x=5').text, 'a 5')
test_eq(set(app.routes[-1].methods), {'POST'})  # type: ignore
```

`FastHTML.route` decorator, or the common `rt` alias, creates a
Starlette `Route` with an endpoint based on a static function, function
`a` in this case. But it‚Äôs not function `a`, it‚Äôs a especial callable
wrapped over the function `a` to facilitate route introspection.

During route definition, `a` is removed from the scope it was defined
and can be used to create additional routes with other HTTP methods
(with caveats, `'post'` is a especial case).

``` python
def b():
    @rt('/b')
    def _b(): return 'b'
    return _b

innerb = b()
test_eq(cli.get('/b').text, 'b')
test_eq(str(innerb), '/b')
test_eq(app.url_path_for('b__b'), '/b')
test_eq(innerb.to(), '/b')
```

Recent FastHTML versions also supports nested functions on local scopes.

``` python
ar = APIRouter()

@ar('/c')
def c(): return 'c'

test_eq(str(c), '/c')
test_eq(ar.c.to(), '/c')
test_eq(ar.rt_funcs.c.to(), '/c')

ar.to_app(app)

test_eq(cli.get('/c').text, 'c')
test_eq(app.url_path_for('c'), '/c')
```

`APIRouter` is a convenient way of grouping routes.

### FastHTML‚Äôs Route Requirements

FastHTML‚Äôs routing system builds on Starlette‚Äôs, which accepts both
functions and methods as endpoints (besides ASGI classes). The only
requirement is being a
[callable](https://github.com/encode/starlette/blob/427a8dcf357597df27b2509b1ac436caf7708300/starlette/routing.py#L208):

``` python
endpoint: typing.Callable[..., typing.Any]
```

FastHTML follows FastAPI‚Äôs style of using decorators for route
definition. Route endpoints must be:  
1. Callables with a `__name__` (`__qualname__` as of v0.12.0) attribute
(for route identification)
[FastHTML.\_add_route](https://github.com/AnswerDotAI/fasthtml/blob/bff83a9bca000c38c91909809e2726a51418793f/fasthtml/core.py#L608)  
2. Have type annotations for all parameters (for request validation)

While this works for functions, it creates challenges with instance
methods:

1.  **Method Binding**: When using decorators at class level, methods
    are still unbound functions:
    - The decorator sees the function `get`, not the bound method
    - The `self` parameter won‚Äôt be properly valued
2.  **Type Annotations**: FastHTML expects all parameters to be
    annotated:
    - The implicit `self` parameter lacks annotation
    - This triggers warnings in FastHTML‚Äôs validation

`APIRouter` like `rt` only works wth static functions.

As a workaround we could use `partial` (or FastHTML own trick, a
lightweight stateful callable) to bind methods after instance creation.
As partials don‚Äôt have a `__name__` (`__qualname__` now) attribute, we
need to hack it manually:

``` python
class AClass:
    def get(self, a:str): return f'{self!r} {a!r}'

a = AClass()
# Manually create bound method and set name
(f := partial(a.get.__func__, a)).__qualname__ = 'get'  # type: ignore
rt('/give/me/{a}')(f)

cli.get('/give/me/b').text
```

    "<__main__.AClass object at 0x148080e60> 'b'"

This approach is verbose and error-prone, separates route definition
from method implementation, and makes code harder to maintain, besides
being cumbersome and ugly. We need something more in order to use
methods as endpoints with fastHTML. It¬¥s clearly time for some more
python dark magic here. But we‚Äôre in python-land where magic abounds.

We‚Äôll extend FastHTML‚Äôs routing capabilities by:  
- Creating an enhanced `APIRouter` class that support (and preserves)
method references  
- Supporting automatic method binding at instance creation  
- Enabling property-based routing for GET/POST/PUT/DELETE operations  
- Providing automatic route mounting and path generation

We aim for a more natural and maintainable syntax:

``` python
class Widget:
    ...
    @ar
    def value(self): 
        return self._value
```

We‚Äôll use the handy `APIRouter` to define routes providers.

<div>

> **Note**
>
> Most of this notebook was written before v0.12.0. In v0.9.1,
> `APIRouter` was defined but not used anywhere. I wasn‚Äôt sure Jeremy‚Äôs
> intention for the class, but it seemed appropiate using it here for
> our purposes.
>
> From v0.10.2 to v0.12.0, `APIRouter` has evolved considerably but the
> basic idea proposed here holds through.

</div>

First, some helpers to get the routes from a provider and its class
hierarchy.

``` python
def routes_from(o: object):
    "Yield all route descriptors (path,methods,name,include_in_schema,body_wrap) from class hierarchy in mro order"
    for base in (o if isinstance(o, type) else type(o)).mro()[:-1]:  
        if not isinstance(base, type) or not hasattr(base, 'ar'): continue
        yield from base.ar.routes

def add_routes(app: FastHTML, o):
    for f,p,m,n,*_ in routes_from(o):
        app.add_route(Route(p, f, methods=m, name=n))
```

`routes_from` returns the routes in MRO order. If we add the routes in
that order, Starlette will match them in that order too (NOTE: check
this is documented). As such, more specific endpoints have precedence
over more generic ones.

Starlette accepts happily methods as endpoints, but as we‚Äôve seen, not
current FastHTML versions (0.12.0 as of this writing). In FastHTML, we
need to use bound functions ‚Äì AKA methods‚Äì. And that is a bit more
involved than using `app.route` on static functions.

``` python
class A:
    ar = APIRouter()
    @ar('/a')
    def a(self): return 'a'

class B(A):
    ar = APIRouter()
    @ar('/b')
    def b(self): return 'b'

class C(B):
    ar = APIRouter()
    @ar('/c?v={v}')
    def c(self, v:int=0): return f'c {v}'

class D(A):
    ar = APIRouter()
    @ar('/d')
    def d(self): return 'd'

class E(B, D):
    ar = APIRouter()
    @ar('/a')
    def e(self): return 'e'


test_eq(C.mro()[:-1], [C, B, A])
test_eq(E.mro()[:-1], [E, B, D, A])

test_eq([_[1] for _ in list(routes_from(C))],  ['/c?v={v}', '/b', '/a'])
test_eq([_[1] for _ in list(routes_from(E))],  ['/a', '/b', '/d', '/a'])
```

``` python
app, cli, _ = get_app()
add_routes(app, C)

test_eq([_.path for _ in app.routes], ['/c?v={v}', '/b', '/a'])  # type: ignore

c_rt = app.routes[0]

match, _ = c_rt.matches({'type': 'http', 'path': '/c?v=3', 'method': 'GET'})
test_eq(match, Match.FULL)

match, _ = c_rt.matches({'type': 'http', 'path': '/c?v=7', 'method': 'PUT'})
test_eq(match, Match.PARTIAL)
```

``` python
app, cli, _ = get_app()
add_routes(app, E)

test_eq([_.path for _ in app.routes], ['/a', '/b', '/d', '/a'])  # type: ignore

e_rt = app.routes[0]

match, child_scope = e_rt.matches({'type': 'http', 'path': '/a', 'method': 'GET'})
test_eq(match, Match.FULL)
test_eq(child_scope['endpoint'], e_rt.endpoint)  # type: ignore
test_eq(e_rt.endpoint(''), 'e')  # type: ignore
```

# RouteProvider

> Any object with an `APIRouter` attribute can be a provider of routes.

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/routing.py#L55"
target="_blank" style="float:right; font-size:smaller">source</a>

### RouteProvider

>  RouteProvider ()

*Base class for objects that provide routes via an APIRouter*

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/routing.py#L50"
target="_blank" style="float:right; font-size:smaller">source</a>

### RouteProviderP

>  RouteProviderP (*args, **kwargs)

*A provider of routes*

# APIRouterD

> APIRouter as a descriptor

APIRouter for Method-Based Routes.

Extends `FastHTML`‚Äôs `APIRouter` to preserve method references while
enabling route registration.

<s>For reasons unclear to me, APIRouter wipes out the functions when
defining routes unlike normal `@rt` decorator.</s>

We need to keep the functions around in order for the class to get its
methods.

[`APIRouterD`](https://civvic.github.io/bridget/route_provider.html#apirouterd)
preserves the original method references while collecting routes. This
allows methods to work both as routes and methods, with proper instance
binding. Like FastHTML‚Äôs standard APIRouter, routes are stored but not
registered immediately, which lets us bind them to instances at mount
time. This delayed registration enables stateful components and works
naturally with Python properties and methods, maintaining compatibility
with all FastHTML‚Äôs routing features.

``` python
test_eq(_replace(''), '')
test_eq(_replace('a.b'), 'a_b')
test_eq(_replace('/', sep='/'), '')
test_eq(_replace('/a', sep='/'), 'a')
test_eq(_replace('/a/', sep='/'), 'a')
test_eq(_replace('/a/b', sep='/'), 'a_b')
```

``` python
def nested_name(f):
    "Get name of function/method `f` using rep to join nested function names"
    return _replace(f.__qualname__.replace('.<locals>.', '_'))
```

``` python
def f():
    def ff(): return 'ff'
    return ff

test_eq(nested_name(f), 'f')
test_eq(nested_name(f()), 'f_ff')

class A:
    def f(self):
        def ff(): return 'ff'
        return ff

test_eq(nested_name(A.f), 'A_f')
test_eq(nested_name(A.f(A())), 'A_f_ff')
```

``` python
class A:
    def f(self):
        def ff(): return 'ff'
        return ff


with _patched(fasthtml.core, 'nested_name', nested_name):
    test_eq(fasthtml.core.nested_name(A.f), 'A_f')
    test_eq(fasthtml.core.nested_name(A.f(A())), 'A_f_ff')
```

We monkey-patch temporarily the `core` module to change its
[`nested_name`](https://civvic.github.io/bridget/route_provider.html#nested_name)
function with ours.

I think the original intuition of Jeremy with APIRouter was correct: a
simple class that gather the routes arguments and defined the final
routes in to_app. But as it removed the functions from the definition
scope, it was not possible to inspect the routes with usual to() or
reverse lookup URLs.

Current version solves the issue and also adds to APIRouter a `rt_funcs`
property with the (non HTTP methods) routes.

## APIRouterC

[`fasthtml.core.nested_name`](https://www.fastht.ml/docs/api/core.html#nested_name)
only considers static (possibly nested) functions.

Current APIRouter (v0.12.0) has a minor issue in \_wrap_func, it uses
`__name__` for the name of the route instead of `__qualname__`. I could
patch it, but this subclass will do for now.

APIRouterC also has an alternative to rt_funcs, given the method name: -
APIRouterC.to(name, ‚Ä¶) return the full route path. -
APIRouterC.name(name) return the full route name (if name was provided
when adding the APIRouter). - <s>can use HTTP methods as method names
(though why?)</s>

## APIRouterD

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/routing.py#L165"
target="_blank" style="float:right; font-size:smaller">source</a>

### APIRouterD

>  APIRouterD (*args, **kwargs)

*Add routes to an app*

``` python
class A:
    ar = APIRouterD()

    def __init__(self, value:int=3): self.value = value

    @ar  # path /, name A_index
    def index(self):
        # int 0 is not a valid FastHTML return value
        return self.value if self.value != 0 else HTMLResponse('0')

    @ar  # or @ar.get or @ar.get('/a')
    def a(self): return f'a {self.value}'

    @ar.post('/a')
    def a_change(self, x:int): self.value = x; return f'new value {x}'

    @ar('/b')  # name A_b, , method [GET, POST]
    def b(self): return f'b {self.value}'

    @ar  
    @staticmethod
    def c(): return 'c'

    @ar
    @classmethod
    def d(cls): return f'd {cls.__name__}'

    @ar
    @property  # path /e, name A_e, method GET
    def e(self): return f'e {self.value}'  # type: ignore

    @ar
    @e.setter  # path /e, name A_e, method [POST, PUT]
    def e(self, x:int): self.value = x; return x  # type: ignore

    @ar  # path /e, name A_e, method DELETE
    @e.deleter
    def e(self): del self.value; return Response(status_code=204)

    @ar('/f')
    def get(self): return 'get'
```

``` python
a = A()
test_eq(a.b(), 'b 3')
test_is('bound' in str(a.a), True)

test_eq(A.ar.to('d'), '/d')
test_eq(A.ar.to('a', x=4), '/a?x=4')
```

``` python
app, cli, _ = get_app()

a = A()
a.ar.to_app(app)
```

``` python
app.routes
```

    [Route(path='/', name='index', methods=['GET', 'HEAD']),
     Route(path='/a', name='a', methods=['GET', 'HEAD']),
     Route(path='/a', name='a_change', methods=['POST']),
     Route(path='/b', name='b', methods=['GET', 'HEAD']),
     Route(path='/c', name='c', methods=['GET', 'HEAD']),
     Route(path='/d', name='d', methods=['GET', 'HEAD']),
     Route(path='/e', name='e', methods=['GET', 'HEAD']),
     Route(path='/e', name='e', methods=['POST', 'PUT']),
     Route(path='/e', name='e', methods=['DELETE']),
     Route(path='/f', name='get', methods=['GET', 'HEAD'])]

`a` is a normal instance of `A`.

`A.ar` is an instance of
[`APIRouterD`](https://civvic.github.io/bridget/route_provider.html#apirouterd),
a subclass of
[`APIRouterC`](https://civvic.github.io/bridget/route_provider.html#apirouterc).
It has basic route instrospection (`.to`, `.name`), but its really a
descriptor. Its main function is storing the routes precursors like
APIRouter does. Once the instance `a` is created, it assigns `a.ar` with
a normal APIRouterC. When `ar.to_app(app)` is called, the final route
endpoints are binded to the instance and installed.

Note that the APIRouter workflow setups the endpoints before calling
`to_app(app)`, endpoints are static functions. APIRouterC delays that
setup until the very last moment, when `to_app(app)` is called. This
lazy binding allows adding different routes in distinct scopes (see
`Adding routes to the app`,
[`add_routes()`](https://civvic.github.io/bridget/route_provider.html#add_routes)
and
[`mount()`](https://civvic.github.io/bridget/route_provider.html#mount)).

``` python
test_eq(cli.get('/').text, '3')

test_eq(cli.get('/a').text, 'a 3')

test_eq(cli.post('/a?x=5').text, 'new value 5')
test_eq(a.value, 5)

test_eq(cli.get('/b').text, 'b 5')
test_eq(cli.get('/c').text, 'c')
test_eq(cli.get('/d').text, 'd A')

test_eq(cli.get('/e').text, 'e 5')
test_eq(cli.post('/e?x=7').text, '7')
test_eq(a.value, 7)
test_eq(str(cli.delete('/e')), '<Response [204 No Content]>')

a.value = 0
test_eq(cli.get('/').text, '0')

test_eq(cli.get('/f').text, 'get')
```

``` python
test_eq(app.url_path_for('a'), '/a')
test_eq(app.url_path_for(a.ar.name('a')), '/a')

test_eq(str(a.ar.a), '/a')
test_eq(a.ar.a.to(), '/a')
test_eq(a.ar.to('a'), '/a')
test_eq(set([*filter(lambda r: r.path == '/a', app.routes)][0].methods), {'GET', 'HEAD'})  # type: ignore
```

Note that `ar` can also setup properties as routes. Use as above, or
simply once on the last descriptor function.

``` python
class A:
    ar = APIRouterD()

    def __init__(self, value:int=3): self.value = value

    @property
    def e(self): return f'e {self.value}'  # type: ignore

    @e.setter
    def e(self, x:int): self.value = x; return x  # type: ignore

    @ar
    @e.deleter
    def e(self): del self.value; return Response(status_code=204)


app, cli, _ = get_app()

a = A()
a.ar.to_app(app)

test_eq(cli.post('/e?x=3').text, '3')
test_eq(a.value, 3)
test_eq(str(cli.delete('/e')), '<Response [204 No Content]>')
```

``` python
test_eq(A.ar.to(), '')
test_eq(A.ar.to('e'), '/e')
with ExceptionExpected(AttributeError): A.ar.a
with ExceptionExpected(AttributeError): A.ar.rt_funcs.a

with ExceptionExpected(TypeError): A.ar.to_app(app)  # APIRouterD is not a valid APIRouter
```

Note that the
[`APIRouterD`](https://civvic.github.io/bridget/route_provider.html#apirouterd)
of the class, `A.ar` in the example above, is not an APIRouter, should
be used only for basic route inspection. The one on the instance,
`a.ar`, is the one which actually can register the routes and is, in
fact, a normal `APIRouter`.

An `APIRouterD route`is very alike `FastHTML.route` or `APIRouter`‚Äôs.
But as its underlying endpoint is a method/property, it has some
different behaviors:

## route names

``` python
app, cli, rt = get_app()

@rt('/a')
def a(): return 'a'

print(f"{'route from a ->':>20}", app.routes[-1])
test_eq(str(a), '/a')
test_eq(a.to(), app.url_path_for('a'))
test_eq(a.__routename__, 'a')

def b():
    @rt('/a')
    def c(): return 'c'
    return c

c = b()

print(f"{'route from c ->':>20}", app.routes[-1])
test_eq(str(c), '/a')
test_eq(c.to(), app.url_path_for('b_c'))
test_eq(c.__routename__, 'b_c')

class D:
    ar = APIRouterD('/D')
    @ar('/a')
    def d(self): return 'd'

d = D()
d.ar.to_app(app)

print(app.routes)

print(f"{'route from d.d ->':>20}", app.routes[-1])
test_eq(str(d.ar.d), '/D/a')
test_eq(d.ar.d.to(), app.url_path_for('d'))
test_eq(d.ar.d.__routename__, 'd')

test_eq(d.ar.to('d'), d.ar.rt_funcs.d.to())
test_eq(d.ar.name('d'), 'd')
```

         route from a -> Route(path='/a', name='a', methods=['GET', 'HEAD', 'POST'])
         route from c -> Route(path='/a', name='b_c', methods=['GET', 'HEAD', 'POST'])
    [Route(path='/a', name='a', methods=['GET', 'HEAD', 'POST']), Route(path='/a', name='b_c', methods=['GET', 'HEAD', 'POST']), Route(path='/D/a', name='d', methods=['GET', 'HEAD'])]
       route from d.d -> Route(path='/D/a', name='d', methods=['GET', 'HEAD'])

- route name is the method name, `D_a` in the example above, not `d`.
- default method is ‚Äòget‚Äô.
- **Route Introspection**: Methods don¬¥t get the `.to` attribute, like
  the wrappers used in routes. But those wrappers are, discoverable
  through `.ar` (e.g.¬†`d.ar.d.to()` or `d.ar.to('d')`).
- unlike `@rt/APIRouter`, it doesn‚Äôt wipe out (see \_add_route) the
  underlying function from the scope (class def) for obvious reasons‚Äì
  base methods would probably be ok, properties not. Python classes
  can‚Äôt have methods with the same name‚Äì dicts, you know.  
  If you want to handle different HTTP methods, you must use different
  func names or set them explcitly with the route arguments and modify
  the function to handle the distinct requests (args or explicit request
  arg).

<div>

> **Note**
>
> Last point is a design decission. We could use metaclasses like
> fastcore transforms to introduce methods overriden by HTTP methods and
> in theory \_mk_locfunc wrappers could function with methods (probably,
> not tested much). But I think a descriptor is already enough python
> dark magic for today :)

</div>

# Inheritance

As usual with OOP and classes, let‚Äôs say its complicated.

``` python
class A:
    ar = APIRouterD()
    _value:str = 'a'
    @ar
    def value(self): return self._value

class B(A):
    ar = APIRouterD()
    _value: int = 1
    @ar
    def value(self): return self._value


app, cli, _ = get_app()

(a := A()).ar.to_app(app)
(b := B()).ar.to_app(app)
print(app.routes)

test_eq(str(a.ar.value), '/value')
test_eq(str(b.ar.value), '/value')

test_eq(cli.get('/value').text, '1')  # a not accesible, overriden by b
```

    [Route(path='/value', name='value', methods=['GET', 'HEAD'])]

Basic inheritance, B.value() supercedes A.value().

To be able to access both objects, we need to use different routes for
each object using `prefix`.

``` python
class A:
    ar = APIRouterD('/A')
    _value:str = 'a'
    @ar
    def value(self): return self._value

class B(A):
    ar = APIRouterD('/B')
    _value: int = 1
    @ar
    def value(self): return self._value


app, cli, _ = get_app()

(a := A()).ar.to_app(app)
(b := B()).ar.to_app(app)
print(app.routes)

test_eq(str(b.ar.value), '/B/value')
test_eq(cli.get('/A/value').text, 'a')
test_eq(cli.get('/B/value').text, '1')
```

    [Route(path='/A/value', name='value', methods=['GET', 'HEAD']), Route(path='/B/value', name='value', methods=['GET', 'HEAD'])]

But we can easily complicate things by using e.g, abstracts or mixins.
Consider this contrived example.

``` python
class A_mixin:
    ar = APIRouterD()
    _value:int
    @ar
    def value(self): return self._value

class B(A_mixin):
    ar = APIRouterD()
    @ar.post
    def value(self, x:int): self._value = x

@dataclass
class C(B):
    ar = APIRouterD()
    _value:int = 1


app, cli, _ = get_app()

(b := B()).ar.to_app(app)
(c := C()).ar.to_app(app)
print(app.routes)

test_eq(b.ar.value.to(), '/value')  # but not accesible, overriden by c
test_eq(c.ar.value.to(), '/value')

# python fails
test_eq(c._value, 1)
with ExceptionExpected(TypeError): b.value()  # type: ignore
with ExceptionExpected(TypeError): c.value()  # type: ignore

# starlette has no problems
test_eq(cli.get('/value').text, '1')  # <-- equivalent to A.value(c)
test_eq(cli.post(c.ar.value.to(x=5)).text, '')  # <-- equivalent to B.value(c, x=5)
test_eq(c._value, 5)
```

    [Route(path='/value', name='value', methods=['POST']), Route(path='/value', name='value', methods=['GET', 'HEAD'])]

`b` is effectevely invisible to FastHTML Starlette.

Easy then, `prefix` each APIRouter like before.

``` python
class A_mixin:
    ar = APIRouterD('/A')
    _value:int
    @ar
    def value(self): return self._value

class B(A_mixin):
    ar = APIRouterD('/AB')
    @ar.post
    def value(self, x:int): self._value = x

@dataclass
class C(B):
    ar = APIRouterD('/ABC')
    _value:int = 1


app, cli, _ = get_app()

(b := B()).ar.to_app(app)
(c := C()).ar.to_app(app)
print(app.routes)

test_eq(b.ar.value.to(), '/AB/value')
test_eq(c.ar.value.to(), '/ABC/value')

test_eq(c._value, 1)
with ExceptionExpected(TypeError): b.value()  # type: ignore
with ExceptionExpected(TypeError): c.value()  # type: ignore

with ExceptionExpected(AttributeError): cli.get('/AB/value').text
test_eq(cli.post(b.ar.value.to(x=3)).text, '')
test_eq(b._value, 3)
test_eq(cli.get('/AB/value').text, '3')

test_eq(cli.get('/ABC/value').text, '1')  # <-- equivalent to A.value(c)
test_eq(cli.post(c.ar.value.to(x=5)).text, '')  # <-- equivalent to B.value(c, x=5)
test_eq(c._value, 5)
```

    [Route(path='/AB/value', name='value', methods=['POST']), Route(path='/AB/value', name='value', methods=['GET', 'HEAD']), Route(path='/ABC/value', name='value', methods=['POST']), Route(path='/ABC/value', name='value', methods=['GET', 'HEAD'])]

In normal use, you probably won‚Äôt have to worry about this. Nevertheless
you must be careful mixing inheritance and Starlette routing.

Method resolution in python follows
[MRO](https://docs.python.org/3/howto/mro.html#python-2-3-mro).
Starlette routes lay in a flattened space, a list (or list of lists if
sub-mounting). Unlike python, routes are matched in the order they are
added by path, path parmas **and** HTTP methods. Unlike Starlette,
FastHTML checks path and HTTP methods when adding routes, but the basic
look-up remains the same.

In the contrived example above, python call fails, but Starlette has no
problem finding the appropriate route because HTTP methds are different.
A Route endpoint is a function, unbounded or, if using APIRouterD,
bounded to the instance (of type C, not B or A, in the example).
FastHTML adds extended functionality such as typing and introspection.
The call works, but not in a pythonic way.

Without getting into
[Liskov](https://en.wikipedia.org/wiki/Liskov_substitution_principle)
and subtyping and the rest of OOP can of worms, think of APIRouterD as a
way of organize routes and encapsulate state, nothing more. In
Hypermedia systems, inheritance, classes, typing are ill defined
concepts if at all. There‚Äôs not such thing as a ‚Äúsubclass‚Äù of a
resource. Resources are uniquely idewntified with URIs, oprganized in
hypermedia networks obtained with hypermedia controls. Semantics or
behaviors are a thing of the server. The client only knows URIs.

So, stick with simple, flat scopes, and if you must, be very careful
defining routes when inheritance is involved.

# APIRoute

> Convenience shortcut to avoid defining explictly
> [`APIRouterD`](https://civvic.github.io/bridget/route_provider.html#apirouterd)
> class var `ar`.

It¬¥s annoying having to define explicitly an `ar` class var for each
class. Coould we have a similar shortcut like `rt` in normal FastHTML?

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/routing.py#L242"
target="_blank" style="float:right; font-size:smaller">source</a>

### APIRoute

>  APIRoute (path=None, methods=None, name=None, include_in_schema=True,
>                body_wrap=<function noop_body>)

*Initialize self. See help(type(self)) for accurate signature.*

``` python
ar = APIRoute
```

``` python
class TestAR:
    def __init__(self, a): self.a = a

    @APIRoute('/hi')
    @staticmethod
    def hi(): return f'hi there'

    @ar('/yoyo')
    def yoyo(self): 
        return f'a yoyo called {self.a}'

    @ar
    def foo(self): 
        return f'foo {self.a}'


t = TestAR('yo')
test_eq(t.yoyo(), 'a yoyo called yo')

app, cli, _ = get_app()
t.ar.to_app(app)  # type: ignore

test_eq(cli.get('/hi').text, 'hi there')
test_eq(cli.get('/yoyo').text, 'a yoyo called yo')
test_eq(cli.get('/foo').text, 'foo yo')

test_eq(t.ar.yoyo.to(), '/yoyo')  # type: ignore
```

If you don‚Äôt need to initialize APIRouterD (e.g.¬†`prefix`), or setup it
afterwards, or mind defining the
[`APIRouterD`](https://civvic.github.io/bridget/route_provider.html#apirouterd)
attribute explicitly, use
[`APIRoute`](https://civvic.github.io/bridget/route_provider.html#apiroute)
or the `ar` shortcut. It works fine if you don¬¥t mind type checking
false negatives.

If like me, you like static type checking at dev time but not stupid
wiggly reds <span style="color:red">~~~</span>, inherit from
[`RouteProvider`](https://civvic.github.io/bridget/route_provider.html#routeprovider).

``` python
class A(RouteProvider):
    _value:Any
    @ar
    def value(self): return self._value

class B(A):
    @ar.post
    def value(self, value:int|None=None):
        if value is not None: self._value = value
        return self._value

@dataclass
class C(B):
    _value:int = 3


app, cli, _ = get_app()

c = C()
c.ar.to_app(app)

test_eq(cli.get('/value').text, '3')
test_eq(cli.post('/value?value=7').text, '7')
test_eq(c.value(), 7)
```

# Adding routes to the app

> Convenience functions for registering routes from providers into
> FastHTML apps.

## FastHTML, Notebooks, Scope & State

> Current `APIRouter` incarnation has a complicated relationship with
> scope and state.

``` python
def noelmeter(n): return f"Ho {('ho '*n).strip()}!"

ar = APIRouter()
state = {'count': 1}

@ar("/ho")
def ho(req):
    return f"{noelmeter(state['count'])} {ar.ho.to()} {req.url_for('ho')}"
```

Note that `ho` access globals `state` and `ar`.

``` python
app,cli,_ = get_app()
ar.to_app(app)
print(app.routes)
```

    [Route(path='/ho', name='ho', methods=['GET', 'HEAD', 'POST'])]

``` python
test_eq(cli.get('/ho').text, 'Ho ho! /ho http://nb/ho')
test_eq(app.url_path_for('ho'), '/ho')
```

Now let¬¥s create another APIRouter with a separate state.

``` python
ar2 = APIRouter("/products")
state2 = {'count': 3}

@ar2("/ho")
def ho(req):
    return f"{noelmeter(state2['count'])} {ar2.ho.to()} {req.url_for('ho')}"

ar2.to_app(app)
print(app.routes)
```

    [Route(path='/ho', name='ho', methods=['GET', 'HEAD', 'POST']), Route(path='/products/ho', name='ho', methods=['GET', 'HEAD', 'POST'])]

We must use `prefix` to preserve `ar` routes when adding the new ones.

``` python
test_eq(cli.get('/ho').text, 'Ho ho! /ho http://nb/ho')
test_eq(cli.get('/products/ho').text, 'Ho ho ho ho! /products/ho http://nb/ho')  # <-- wrong

test_eq(app.url_path_for('ho'), '/ho')
```

Routes @ `/ho` and `/products/ho` got the same name so either app or req
can‚Äôt use reverse URL lookup to get the correct path of `ar2.ho`.

We may need to add `ar2` to another app because both `ar` and `ar2`
routes share names, and then install `app2` as a submount.

``` python
app.routes.clear()
ar.to_app(app)

ar2 = APIRouter()  # we can`t use prefix here

@ar2("/ho")
def ho(req):
    return f"{noelmeter(state2['count'])} {ar2.ho.to()} {req.url_for('ho')}"

app2,cli2,_ = get_app()
ar2.to_app(app2)

app.routes.append(Mount('/products', app2))
print(app.routes)
print(app.routes[-1].app.routes)  # type: ignore
```

    [Route(path='/ho', name='ho', methods=['GET', 'HEAD', 'POST']), Mount(path='/products', name='', app=<fasthtml.core.FastHTML object at 0x1482269c0>)]
    [Route(path='/ho', name='ho', methods=['GET', 'HEAD', 'POST'])]

``` python
test_eq(cli.get('/ho').text, 'Ho ho! /ho http://nb/ho')
test_eq(cli.get('/products/ho').text, 'Ho ho ho ho! /ho http://nb/ho')  # <-- wrong

test_eq(app.url_path_for('ho'), '/ho')
```

Nope. We can¬¥t rely on `req.url_for(...)` or `app.url_path_fpr(...)`
unless we add another global dependency.

``` python
app.routes.clear()
ar.to_app(app)

ar2 = APIRouter()

@ar2("/ho")
def ho(req):
    return f"{noelmeter(state2['count'])} /products{ar2.ho.to()} {req.url_for('products:ho')}"  # or
        #  f"{noelmeter(state2['count'])} {ar2.prefix}{ar2.ho.to()} {req.url_for('products:ho')}"

app2,cli2,_ = get_app()
ar2.to_app(app2)
app.routes.append(Mount('/products', app2, name='products'))  # <-- assume `ar2` mounted with the name `products`
```

``` python
test_eq(cli.get('/ho').text, 'Ho ho! /ho http://nb/ho')
test_eq(cli.get('/products/ho').text, 'Ho ho ho ho! /products/ho http://nb/products/ho')

test_eq(app.url_path_for('ho'), '/ho')
test_eq(app.url_path_for('products:ho'), '/products/ho')
```

The fix above finally works. But now not only `ho` depends on globals
`ar2` and `state2`, also on knowledge of the mount route name.

## add_routes

Besides support for methods,
[`APIRouterC`](https://civvic.github.io/bridget/route_provider.html#apirouterc)
also has features to ease adding/mounting `APIRouter`s.

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/routing.py#L320"
target="_blank" style="float:right; font-size:smaller">source</a>

### mount

>  mount (app:fasthtml.core.FastHTML,
>             prov:fasthtml.core.APIRouter|__main__.RouteProviderP,
>             path:str|None=None, name:str|None=None)

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/routing.py#L272"
target="_blank" style="float:right; font-size:smaller">source</a>

### add_routes

>  add_routes
>                  (prov:fasthtml.core.APIRouter|__main__.RouteProviderP|typing.
>                  Any, mount:bool=False, path:str|None=None,
>                  name:str|None=None, appcls:Callable=<function nb_app>)

*Register provider routes*

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>prov</td>
<td>fasthtml.core.APIRouter | <strong>main</strong>.RouteProviderP |
typing.Any</td>
<td></td>
<td>APIRouterC or RouteProvider</td>
</tr>
<tr>
<td>mount</td>
<td>bool</td>
<td>False</td>
<td>mount routes under <code>path</code>; if false will add routes under
APIRouter prefix</td>
</tr>
<tr>
<td>path</td>
<td>str | None</td>
<td>None</td>
<td>if <a
href="https://civvic.github.io/bridget/route_provider.html#mount"><code>mount</code></a>,
submount path (or auto-generated based on <code>prov</code> class)</td>
</tr>
<tr>
<td>name</td>
<td>str | None</td>
<td>None</td>
<td>if <a
href="https://civvic.github.io/bridget/route_provider.html#mount"><code>mount</code></a>,
name for submount (or auto-generated based on path)</td>
</tr>
<tr>
<td>appcls</td>
<td>Callable</td>
<td>nb_app</td>
<td>use FastHTML factory for submounts</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>APIRouter</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

[`add_routes`](https://civvic.github.io/bridget/route_provider.html#add_routes)
handles two scenarios: 1.
[`mount`](https://civvic.github.io/bridget/route_provider.html#mount) is
`False`. This is equivalent to `APIRouter.to_app`, the routes are
available under `APIRuter.prefix`. 2.
[`mount`](https://civvic.github.io/bridget/route_provider.html#mount) is
`True`. The routes are mounted under `path` and are available under
path/prefix.

App routes can be organized at two levels: 1. **root Level**: Global
routes 2. **Provider Level**: Scoped routes defined by providers

This allows for clean organization of routes and natural encapsulation
of component behavior directly in the notebook. This will be handy when
we start defining ipywidgets like widgets with FastHTML.

Though I think it‚Äôs convenient, you don‚Äôt need to mount routes providers
at all, add its routes directly to the root level app.

``` python
ar = APIRoute
```

``` python
class Counter(RouteProvider):
    def __init__(self, value:int=0): self._value = value
    
    @ar('/value', name='value')
    def get_value(self): 
        return self._value  # `0` is not a valid FastHTML response
    
    @ar('/inc')
    def increment(self, x:int=1): 
        self._value += x
        return self.get_value()


app, cli, _ = get_app()

counter = Counter()
add_routes(app, counter)
print(app.routes)

test_eq(cli.get('/value').text, '')
test_eq(cli.get('/inc').text, '1')
```

    [Route(path='/value', name='value', methods=['GET', 'HEAD']), Route(path='/inc', name='increment', methods=['GET', 'HEAD'])]

Add routes to apps (notebook-level `app` above). Routes available under
`{self.ar.prefix}/...` or `{self.ar.to()}/...`

[`add_routes`](https://civvic.github.io/bridget/route_provider.html#add_routes)
returns the `APIRouter` used to define the routes.

``` python
counter2 = Counter(7)
add_routes(app, counter2)
print(app.routes)

test_eq(cli.get('/value').text, '7')
test_eq(cli.get(f"{counter2.ar.to()}/value").text, '7')
```

    [Route(path='/value', name='value', methods=['GET', 'HEAD']), Route(path='/inc', name='increment', methods=['GET', 'HEAD'])]

Note, however, routes are bound to a given `Counter` instance. Existing
routes will be overwritten if you add routes from another instance.

``` python
counter3 = Counter(17)
# car3 = add_routes(app, counter3, path='/counter', name='cnt')  # routes under /... and /counter/...
car3 = add_routes(app, counter3, path='/counter')  # routes under /... and /counter/...
print(app.routes)
print(app.routes[-1].app.routes)  # type: ignore

test_is(counter3.ar, car3)

test_eq(cli.get('/inc').text, '8')

test_eq(cli.get(car3.get_value.to()).text, '17')
test_eq(cli.get('/counter/inc').text, '18')
test_eq(app.url_path_for('value'), '/value')
test_eq(app.url_path_for(car3.name('value')), '/counter/value')
```

    [Route(path='/value', name='value', methods=['GET', 'HEAD']), Route(path='/inc', name='increment', methods=['GET', 'HEAD']), Mount(path='/counter', name='counter', app=<fasthtml.core.FastHTML object at 0x148226570>)]
    [Route(path='/value', name='value', methods=['GET', 'HEAD']), Route(path='/inc', name='increment', methods=['GET', 'HEAD'])]

You can add instance routes under different `path` prefix.

Note
[`add_routes`](https://civvic.github.io/bridget/route_provider.html#add_routes)
with `path` argument will auto generate a `name` for the route if not
provided.

``` python
counter32 = Counter(177)
car32= add_routes(app, counter32, path='/counter', name='cnt')  # routes under /... and /counter/...
print(app.routes)
print(app.routes[-1].app.routes)  # type: ignore

test_eq(cli.get(car32.get_value.to()).text, '177')
test_eq(cli.get('/counter/inc').text, '178')
test_eq(app.url_path_for('value'), '/value')
test_eq(app.url_path_for(car32.name('value')), '/counter/value')
```

    [Route(path='/value', name='value', methods=['GET', 'HEAD']), Route(path='/inc', name='increment', methods=['GET', 'HEAD']), Mount(path='/counter', name='cnt', app=<fasthtml.core.FastHTML object at 0x148226840>)]
    [Route(path='/value', name='value', methods=['GET', 'HEAD']), Route(path='/inc', name='increment', methods=['GET', 'HEAD'])]

Use
[`mount`](https://civvic.github.io/bridget/route_provider.html#mount) to
submount APIRouters under class name (or
`add_routes(..., mount=True, ...)`).

``` python
counter4 = Counter(23)
car4 = mount(app, counter4, '/counter', 'counter')  # routes under /..., /counter/..., and /Counter/counter/...
print(app.routes)
print(app.routes[-1].app.routes)  # type: ignore
print(app.routes[-1].app.routes[-1].routes)  # type: ignore

test_eq(cli.get('/inc').text, '9')
test_eq(cli.get('/counter/inc').text, '179')

test_eq(cli.get('/Counter/counter/value').text, '23')
test_eq(cli.get('/Counter/counter/inc').text, '24')
test_eq(cli.get(car4.get_value.to()).text, '24')
test_eq(cli.get(f"{car4.to()}/value").text, '24')
test_eq(car4.name('increment'), 'Counter:counter:increment')
```

    [Route(path='/value', name='value', methods=['GET', 'HEAD']), Route(path='/inc', name='increment', methods=['GET', 'HEAD']), Mount(path='/counter', name='cnt', app=<fasthtml.core.FastHTML object at 0x148226840>), Mount(path='/Counter', name='Counter', app=<fasthtml.core.FastHTML object at 0x14823f440>)]
    [Mount(path='/counter', name='counter', app=<fasthtml.core.FastHTML object at 0x14823e510>)]
    [Route(path='/value', name='value', methods=['GET', 'HEAD']), Route(path='/inc', name='increment', methods=['GET', 'HEAD'])]

Mount with explicit path.  
An APIRouterC from an instance, discloses its mounted name with
`self.ar.name()`.

``` python
counter5 = Counter(-7)
car5 = mount(app, counter5)  # routes under /counter/..., and root.
print(app.routes)
print(app.routes[-1].app.routes)  # type: ignore
print(app.routes[-1].app.routes[-1].routes)  # type: ignore

test_eq(cli.get(f"{car5.to()}/value").text, '-7')
test_eq(cli.get(f"{car5.increment.to()}").text, '-6')
test_eq(cli.get(car5.to('increment')).text, '-5')
```

    [Route(path='/value', name='value', methods=['GET', 'HEAD']), Route(path='/inc', name='increment', methods=['GET', 'HEAD']), Mount(path='/counter', name='cnt', app=<fasthtml.core.FastHTML object at 0x148226840>), Mount(path='/Counter', name='Counter', app=<fasthtml.core.FastHTML object at 0x14823f440>)]
    [Mount(path='/counter', name='counter', app=<fasthtml.core.FastHTML object at 0x14823e510>), Mount(path='/Counter_1-1764770681', name='Counter_1-1764770681', app=<fasthtml.core.FastHTML object at 0x1482609b0>)]
    [Route(path='/value', name='value', methods=['GET', 'HEAD']), Route(path='/inc', name='increment', methods=['GET', 'HEAD'])]

Mount routes with automatic path generation.

``` python
counter6 = Counter(111)
car6 = mount(app, counter6, path='/')
print(app.routes)
print(app.routes[-1].app.routes)  # type: ignore

test_eq(cli.get(f"{car6.prefix}/value").text, '111')
test_eq(cli.get(car6.to('increment')).text, '112')
```

    [Route(path='/value', name='value', methods=['GET', 'HEAD']), Route(path='/inc', name='increment', methods=['GET', 'HEAD']), Mount(path='/counter', name='cnt', app=<fasthtml.core.FastHTML object at 0x148226840>), Mount(path='/Counter', name='Counter', app=<fasthtml.core.FastHTML object at 0x14823f440>)]
    [Mount(path='/counter', name='counter', app=<fasthtml.core.FastHTML object at 0x14823e510>), Mount(path='/Counter_1-1764770681', name='Counter_1-1764770681', app=<fasthtml.core.FastHTML object at 0x1482609b0>), Route(path='/value', name='value', methods=['GET', 'HEAD']), Route(path='/inc', name='increment', methods=['GET', 'HEAD'])]

`counter_6` routes added at `Counter` submount as root routes.

Thus
[`add_routes`](https://civvic.github.io/bridget/route_provider.html#add_routes)
can be used to add routes to an app with instance-based routes: -
mount=False, path=None =\> root-level routes (e.g.¬†`/inc`). Equivalent
to FastHTML `APIRouter.to_app` - mount=False, path=‚Ä¶: root-level
subroutes (e.g.¬†`/counter/inc`). Equivalent to FastHTML
`APIRouter.to_app` + prefix - mount=True, path=None =\> auto routes
scoped under class name (e.g.¬†`/Counter/inc` ) - mount=True, path=‚Ä¶ =\>
auto routes scoped under class name and path
(e.g.¬†`/Counter/counter/inc` )

# Route introspection

``` python
class Counter(RouteProvider):
    def __init__(self): self._value = 0
    
    @ar('/value', name='value')
    def get_value(self) -> int: 
        return self._value  # `0` (int(0)) is not a valid FastHTML response (will be converted to `''`)
    
    @ar('/inc', name='inc')
    def increment(self): 
        self._value += 1
        return self.get_value()

    @ar('/add/{x}')
    def add(self, x:int): 
        self._value += x
        return self.get_value()

    @ar.post('/sub')
    def sub(self, x:int): 
        self._value -= x
        return self.get_value()
    
    @ar
    def link(self, req): 
        nm = self.ar.name('add')
        req.url_for(f"{nm}", x=2)
        return (Div('+ 3', link=uri(nm, x='3')), 
                Div('+ 2', href=f"{req.url_for(f"{nm}", x=2)}"))


app, cli, rt = get_app()

c = Counter()
test_eq(c.increment(), 1)

c.ar.to_app(app)

test_eq(c.ar.name(), '')

test_eq(cli.get('/inc').text, '2')
test_eq(cli.get('/add/5').text, '7')
test_eq(cli.post('/sub', data={'x':2}).text, '5')  # type: ignore
test_eq(cli.post('/sub?x=3').text, '2')
test_eq(cli.get('/link').text, ' <div href="/add/3">+ 3</div>\n <div href="http://nb/add/2">+ 2</div>\n')

test_eq(c.increment(), 3)
```

``` python
test_eq(c.ar.increment.to(), '/inc')
test_eq(c.ar.inc.to(), '/inc')
test_eq(c.ar.add.to(), '/add/{x}')
test_eq(c.ar.to('add'), '/add/{x}')
test_eq(c.ar.to('sub', x=3), '/sub?x=3')

test_eq(app.url_path_for(c.ar.name('inc')), '/inc')
test_eq(app.url_path_for(c.ar.name('add'), x=5), '/add/5')
test_eq(app.url_path_for(c.ar.name('sub')), '/sub')
```

``` python
app, cli, rt = get_app()

c = Counter()
add_routes(app, c, path='/counter')
# mount(app, c, '/counter')
print(app.routes)
print(app.routes[-1].app.routes)  # type: ignore

test_eq(c.ar.prefix, '/counter')

test_eq(c.ar.add.to(), '/counter/add/{x}')
test_eq(c.ar.to('increment'), '/counter/inc')
test_eq(c.ar.to('inc'), '/counter/inc')
test_eq(c.ar.to('add'), '/counter/add/{x}')
test_eq(c.ar.to('sub', x=3), '/counter/sub?x=3')

test_eq(c.ar.name('inc'), f"counter:inc")
test_eq(app.url_path_for(c.ar.name('inc')), '/counter/inc')
test_eq(app.url_path_for(c.ar.name('link')), '/counter/link')
test_eq(app.url_path_for(c.ar.name('add'), x=5), '/counter/add/5')
```

    [Mount(path='/counter', name='counter', app=<fasthtml.core.FastHTML object at 0x148213260>)]
    [Route(path='/value', name='value', methods=['GET', 'HEAD']), Route(path='/inc', name='inc', methods=['GET', 'HEAD']), Route(path='/add/{x}', name='add', methods=['GET', 'HEAD']), Route(path='/sub', name='sub', methods=['POST']), Route(path='/link', name='link', methods=['GET', 'HEAD'])]

Above is equivalent `to_app` using a custom prefix. Mounting another
instance at same path will override the routes.

``` python
app, cli, rt = get_app()

c = Counter()
mount(app, c, '/counter')
print(app.routes)
print(app.routes[-1].app.routes)  # type: ignore
print(app.routes[-1].app.routes[-1].app.routes)  # type: ignore

test_eq(c.ar.prefix, '/Counter/counter')

test_eq(c.ar.add.to(), '/Counter/counter/add/{x}')
test_eq(c.ar.to('increment'), '/Counter/counter/inc')
test_eq(c.ar.to('add'), '/Counter/counter/add/{x}')
test_eq(c.ar.to('sub', x=3), '/Counter/counter/sub?x=3')

test_eq(app.url_path_for(c.ar.name('link')), '/Counter/counter/link')

test_eq(c.ar.name('increment'), f"Counter:counter:inc")
test_eq(app.url_path_for(c.ar.name('inc')), '/Counter/counter/inc')
test_eq(app.url_path_for(c.ar.name('add'), x=5), '/Counter/counter/add/5')
```

    [Mount(path='/Counter', name='Counter', app=<fasthtml.core.FastHTML object at 0x1482245c0>)]
    [Mount(path='/counter', name='counter', app=<fasthtml.core.FastHTML object at 0x148279730>)]
    [Route(path='/value', name='value', methods=['GET', 'HEAD']), Route(path='/inc', name='inc', methods=['GET', 'HEAD']), Route(path='/add/{x}', name='add', methods=['GET', 'HEAD']), Route(path='/sub', name='sub', methods=['POST']), Route(path='/link', name='link', methods=['GET', 'HEAD'])]

``` python
app, cli, rt = get_app()

c = Counter()
mount(app, c, '/counter', 'cnt')

test_eq(app.url_path_for(c.ar.name('link')), '/Counter/counter/link')

test_eq(c.ar.name('increment'), f"Counter:cnt:inc")
test_eq(app.url_path_for(c.ar.name('inc')), '/Counter/counter/inc')
test_eq(app.url_path_for(c.ar.name('add'), x=5), '/Counter/counter/add/5')
```

# Examples

``` python
bridge_cfg.auto_show = True
show(DetailsJSON(bridge_cfg.as_dict()))
```

``` python
app = FastHTML()
rt = app.route

server = JupyUviB(app)
```

<script>
document.body.addEventListener('htmx:configRequest', (event) => {
    if(event.detail.path.includes('://')) return;
    htmx.config.selfRequestsOnly=false;
    event.detail.path = `http://0.0.0.0:8000${event.detail.path}`;
});
</script>

``` python
render_ft()
```

``` python
fh_cfg['auto_id']=True
show(Script(src='https://unpkg.com/htmx.org@2.0.4/dist/htmx.js'), fhjsscr, scopesrc, surrsrc)
clear_output()
```

``` python
display(Javascript('''
if (window.htmx) htmx.process(document.body);
'''))
clear_output()
```

Below we define several hypothetical product related routes in a
`Products` and then demonstrate how they can seamlessly be incorporated
into a FastHTML app instance.

``` python
class Products:
    @ar('/all')
    def all_products(self, req):
        return Div(
            "Welcome to the Products Page! Click the button below to look at the details for product 42",
            Div(
                Button(
                    'Details',
                    hx_get=self.ar.to('details', pid=42),  # type: ignore
                    hx_target='#products_list',
                    hx_swap='outerHTML',
                ),
            ),
            id='products_list',
        )


    @ar('/{pid}', name='details')  # or @ar('/{pid}') or @ar.get('/{pid}') or @ar.get('/{pid}', name='details')
    def details(self, pid: int):
        return f"Here are the product details for ID: {pid}"


products = Products()
add_routes(app, products, path='/products', name='products')

products.ar.all_products.to(), str(products.ar.rt_funcs.details)  # type: ignore
```

    ('/products/all', '/products/{pid}')

Since we specified the `path='/products'` when mounting our hypothetical
object, all routes defined in that provider will be found under
`/products`.

``` python
Div(
    "Click me for a look at our products",
    hx_get=products.ar.all_products,  # type: ignore
    hx_swap="outerHTML",
)
```

``` html
<div hx-get="/products/all" hx-swap="outerHTML" id="_q2x2satfRI2WnYF_H0FJIg">Click me for a look at our products</div>
```

Note how you can reference our python route functions via
`APIRouter.rt_funcs` or `APIRouter.{name}` or `APIRouter.to('name')` in
your `hx_{http_method}` calls like normal.

``` python
server.stop()
```

------------------------------------------------------------------------
</doc><doc title="Notebook State" desc="Live state capture"># Notebook state




------------------------------------------------------------------------

``` python
bridge_cfg.auto_show = True
bridge_cfg.auto_id = False
```

``` python
bridge = get_bridge(show_logger=True, wait=5)
```

<div id='brd-logger_1-1764771587' class='brd-logger' style='width: 100%; max-height: 200px;'></div>

# NBStateFeedback

> Simple visual feedback of notebook state. We manage the notebook state
> In the front-end and use this helper to show a little feedback of
> state changes.

If yuou‚Äôre reading this in VSCode-ish environment, ensure the extension
developed in [nbinspect-vscode](../packages/nbinspect-vscode/README.md)
is enabled.

If you want to know how the notebook‚Äôs state gets here in real-time,
take a look at the [packages](../packages) folder.

``` python
# NBStateFeedback.show(feedback=False, hide=True,debug=False)
NBStateFeedback.show()
```

Note that the state data **is** still in the **front-end** (JS-land).
This function is just a visual feedback of state changes, but we haven‚Äôt
transferred yet the state to the **kernel** (python-land). We need to
have something (the bridge) in the front-end that can transfer the state
to the kernel. For that, see next sections.

**VSCode weirdness (again)**: Bridget uses an extension to capture
notebook state. In Jupyter environments, the extension is triggered when
a notebook is opened, monitors state changes, and sends notifications to
the frontend, waiting for a widget to retrieve them. Check the
JavaScript console to see the extension‚Äôs traces.

In VSCode, the extension is also activated when a notebook is opened.
However, the front end of the extension‚ÄîRenderer in VSCode Notebook
Extension API parlance‚Äîis isolated within a webview, an iframe-like
object that the extension can only communicate with via the a very
limited messaging API. Renderers are the only means by which extensions
can communicate with the JavaScript running in the webview. And
renderers can only be triggered by a cell displaying specific MIME types
at least once. Therefore, since VSCode only renders its output when a
visible cell is executed, the extension‚Äôs renderer can only obtain the
notebook state relayed by the main extension when the cell is run
interactively or is already in the notebook and visible. Fortunately,
this only needs to happen once; you can delete the cell or its output,
and the extension will continue to work. VSCode‚Äôs foibles.

Keep this in mind when running commands like `Execute Above Cells` or
`Execute All Cells` or similar. If the above cell is already displaying
its output, that‚Äôs fine; if not, the extension renderer won‚Äôt be
triggered until it appears, the state won‚Äôt be passed to the front end,
and the rest of the notebook won‚Äôt work properly.

``` python
print(19)
```

    19

After executing above cell, you‚Äôve noticed a pink flash. We‚Äôre
monitoring state changes in real-time.

Clear the output of the above cell. Open the details and look for cell
\#19 (if you haven‚Äôt added any new cells above it). Check that it
doesn‚Äôt have any outputs.

Run the cell again and check to see that it now has outputs.

Create a new cell below this, source or markdown, and write something.
Notice that we‚Äôre updating the state of cell inputs not just outputs.

``` python
NBStateFeedback.update(feedback=False)
```

With feedback disabled, the details disclosure in not shown.

``` python
NBStateFeedback.update(feedback=True)
```

``` python
NBStateFeedback.update(debug=False)
```

[`debug`](https://civvic.github.io/bridget/bridge.html#debug) affects
javascript dev console logging.

``` python
print(29)
```

    29

``` python
NBStateFeedback.update(debug=True)
```

``` python
NBStateFeedback.show()
```

    Unable to display output for mime type(s): application/x-notebook-state+json

``` python
NBStateFeedback.hide()
```

Though we‚Äôve hided the feedback output, Bridget is still monitoring and
capturing state changes, as you can see in the dev console. In fact,
once activated by showing the feedback output, it‚Äôs not possible to
deactivate it.

# NBStateFetcher

> A bridge plugin to retrieve notebook state from the front-end to
> `bridge.state`.

Simple plugin to grab the notebook state from the front-end and return
it to Python where we really want and need it. And where it should have
always been, imho. How much unnecessary pain has the MVC pattern done!

``` python
bundled(nbstate_js)();
```

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/nb_state.py#L78"
target="_blank" style="float:right; font-size:smaller">source</a>

### NBStateFetcher

>  NBStateFetcher ()

*Bridge plugin that retrieves notebook state from the front-end*

``` python
bridge.logger.show(clear=True)
```

<div id='brd-logger_2-1764771587' class='brd-logger' style='width: 100%; max-height: 200px;'></div>

``` python
bridge.add_plugins(fetcher := NBStateFetcher(), wait=3)

l = 80
test_is('fetcher' in bridge.plugins, True)
test_is(len(bridge.state.cells) in (0, l), True)
```

WARNING: the extension debounces state notifications to avoid excesive
throughput. When running `Execute Above Cells` or `Execute All Cells` or
similar commands, the extension will group state notifications and the
cell below will probably fail. If that‚Äôs the case, simply run the cell
again.

``` python
# cell 39
test_eq(len(bridge.state.cells), l)
uri = urllib.parse.urlparse(bridge.state.nbData['notebookUri'])
if in_vscode_notebook(): test_eq(uri.path, __vsc_ipynb_file__)  # type: ignore
bridge.state[39]
```

> markdown

``` json
{
  'idx': 39,
  'cell_type': 'markdown',
  'source': "WARNING: the extension debounces state notifications to avoid excesive throughput. When running `Execute Above Cells` or `Execute All Cells` or similar commands, the extension will group state notifications and the cell below will probably fail. If that's the case, simply run the cell again.",
  'id': 'X54sZmlsZQ==',
  'metadata': {'brd': {'id': '5d660c84-66e2-41ab-b3c5-c2e67f16fc7d'}}
}
```

Note after running previous cell, the state has not yet been updated.
Check that it has no outputs or the outputs are old. We‚Äôll see how to
access the state of the current cell below.

``` python
# cell 41
bridge.state.cells[39]
```

> markdown

``` json
{
  'idx': 39,
  'cell_type': 'markdown',
  'source': "WARNING: the extension debounces state notifications to avoid excesive throughput. When running `Execute Above Cells` or `Execute All Cells` or similar commands, the extension will group state notifications and the cell below will probably fail. If that's the case, simply run the cell again.",
  'id': 'X54sZmlsZQ==',
  'metadata': {'brd': {'id': '5d660c84-66e2-41ab-b3c5-c2e67f16fc7d'}}
}
```

``` python
bridge.logger.show()
```

<div id='brd-logger_3-1764771587' class='brd-logger' style='width: 100%; max-height: 200px;'></div>

``` python
print('test5')
```

    test5

``` python
display(HTML('<div>test6</div>'))
```

<div>test6</div>

# NBState

> Simple wrapper around
> [`NB`](https://civvic.github.io/bridget/nb.html#nb) +
> [`NBStateFetcher`](https://civvic.github.io/bridget/nb_state.html#nbstatefetcher)
> & `NBHooks` bridge plugins

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/nb_state.py#L144"
target="_blank" style="float:right; font-size:smaller">source</a>

### NBState

>  NBState (source:Union[__main__.StateProvider,Mapping,NoneType]=None,
>               *bridge_args, plugins=None, **bridge_kw)

*Inherit from this to have all attr accesses in `self._xtra` passed down
to `self.default`*

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/nb_state.py#L139"
target="_blank" style="float:right; font-size:smaller">source</a>

### StateProvider

>  StateProvider (*args, **kwargs)

\*Base class for protocol classes.

Protocol classes are defined as::

    class Proto(Protocol):
        def meth(self) -> int:
            ...

Such classes are primarily used with static type checkers that recognize
structural subtyping (static duck-typing).

For example::

    class C:
        def meth(self) -> int:
            return 0

    def func(x: Proto) -> int:
        return x.meth()

    func(C())  # Passes static type check

See PEP 544 for details. Protocol classes decorated with
@typing.runtime_checkable act as simple-minded runtime protocols that
check only the presence of given attributes, ignoring their type
signatures. Protocol classes can be generic, they are defined as::

    class GenProto[T](Protocol):
        def meth(self) -> T:
            ...*

``` python
state = json.loads(Path('../packages/nbinspect-vscode/test/outputs.json').read_text('utf-8'))

nb = NBState(state)
```

``` python
display(nb.mds)
nb.codes
```

    (#2) [0,23]

    (#40) [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20...]

``` python
nb = NBState(show_logger=True, wait=5)
test_eq(nb.source, get_bridge())
```

<div id='brd-logger_4-1764771587' class='brd-logger' style='width: 100%; max-height: 200px;'></div>

``` python
if len(nb.cells): display(nb[50])
```

> code

``` json
{
  'idx': 50,
  'cell_type': 'code',
  'source': 'nb = NBState(show_logger=True, wait=5)\ntest_eq(nb.source, get_bridge())',
  'id': 'Y101sZmlsZQ==',
  'metadata': {'brd': {'id': '14138586-2875-4e27-9c03-200e102a591d'}},
  'outputs': [
    {
      'output_type': 'display_data',
      'data': {
        'text/html': "<div id='brd-logger_4-1764771587' class='brd-logger' style='width: 100%; max-height: 200px;'></div>",
        'text/plain': '<bridget.helpers.HTML object>'
      },
      'metadata': {'transient': {}}
    }
  ],
  'execution_count': 40
}
```

``` python
list(shortens(nb[40:50], 'r', 80))
```

    ['{\'idx\': 40, \'cell_type\': \'code\', \'source\': "# cell 39\\ntest_eq(len(bridge.state.‚Ä¶',
     '{\'idx\': 41, \'cell_type\': \'markdown\', \'source\': "Note after running previous cell‚Ä¶',
     "{'idx': 42, 'cell_type': 'code', 'source': '# cell 41\\nbridge.state.cells[39]', ‚Ä¶",
     "{'idx': 43, 'cell_type': 'code', 'source': 'bridge.logger.show()', 'id': 'X61sZm‚Ä¶",
     '{\'idx\': 44, \'cell_type\': \'code\', \'source\': "print(\'test5\')", \'id\': \'X62sZmlsZQ==‚Ä¶',
     '{\'idx\': 45, \'cell_type\': \'code\', \'source\': "display(HTML(\'<div>test6</div>\'))", ‚Ä¶',
     "{'idx': 46, 'cell_type': 'markdown', 'source': '# NBState\\n> Simple wrapper arou‚Ä¶",
     '{\'idx\': 47, \'cell_type\': \'code\', \'source\': "#| export\\n\\n@runtime_checkable\\ncla‚Ä¶',
     '{\'idx\': 48, \'cell_type\': \'code\', \'source\': "state = json.loads(Path(\'../packages‚Ä¶',
     "{'idx': 49, 'cell_type': 'code', 'source': 'display(nb.mds)\\nnb.codes', 'id': 'Y‚Ä¶"]

``` python
list(shortens(nb.find('class').attrgot('source'), 'r', 80))
```

    ["#| export\n\nNBSTATE_MIME = 'application/x-notebook-state+json'\n\nclass _NBStateFee‚Ä¶",
     '#| export\n\nclass NBStateFetcher(BridgePlugin):\n    "Bridge plugin that retrieves‚Ä¶',
     '#| export\n\n@runtime_checkable\nclass StateProvider(Protocol):\n    @property\n    d‚Ä¶',
     "list(shortens(nb.find('class').attrgot('source'), 'r', 80))"]

``` python
# find_me
```

``` python
# this cell2
# nb.update()
nb.find('# this cell2').attrgot('source')
```

    (#1) ["# this cell2\n# nb.update()\nnb.find('# this cell2').attrgot('source')"]

# Cell id

For this to work, bridge must be loaded with the
[`NBHooksPlugin`](https://civvic.github.io/bridget/bridge_plugins.html#nbhooksplugin)
(NBState takes care of all that) .

``` python
# really hate stupid wiggly reds
__cellinfo__:AD
```

``` python
print(f"{__cellinfo__.cell_id!r}\n{__cellinfo__.source!r}")
test_eq(__cellinfo__.source[:29], 'print(f"{__cellinfo__.cell_id')
```

    'Y114sZmlsZQ=='
    'print(f"{__cellinfo__.cell_id!r}\\n{__cellinfo__.source!r}")\ntest_eq(__cellinfo__.source[:29], \'print(f"{__cellinfo__.cell_id\')'

``` python
# cell x
idx = nb.find('# cell x')[0].idx  # type: ignore
test_eq(__cellinfo__.cell_id, nb[idx].id)
nb[idx]
```

> code

``` json
{
  'idx': 61,
  'cell_type': 'code',
  'source': "# cell x\nidx = nb.find('# cell x')[0].idx  # type: ignore\ntest_eq(__cellinfo__.cell_id, nb[idx].id)\nnb[idx]",
  'id': 'Y115sZmlsZQ==',
  'metadata': {'brd': {'id': 'dbdca1cc-dcde-4bc3-9738-c1e14cd72069'}},
  'outputs': [],
  'execution_count': None
}
```

# this

[`this`](https://civvic.github.io/bridget/nb_state.html#this) marks the
finale of the first part of Bridget.

We now have all the pieces to build the bridge. - fasthtml & other
helper scripts - loader of arbitrary JS code - notebook state fetcher -
nbstate and nb hooks

Next steps will be to add tools to edit notebook outputs.

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/nb_state.py#L179"
target="_blank" style="float:right; font-size:smaller">source</a>

### this

>  this (idx:int|None=None)

*Current cell if `idx` is None, or cell at `idx` from current cell
upwards. Raises if not found.*

``` python
bridge.logger.show(clear=True)
```

<div id='brd-logger_5-1764771587' class='brd-logger' style='width: 100%; max-height: 200px;'></div>

``` python
c = this(); c
```

> code

``` json
{
  'idx': 66,
  'cell_type': 'code',
  'source': 'c = this(); c',
  'id': 'Y123sZmlsZQ==',
  'metadata': {'brd': {'id': '73daee75-5371-4c72-9211-52443b4b2bf7'}},
  'outputs': [],
  'execution_count': None
}
```

``` python
c
```

> code

``` json
{
  'idx': 66,
  'cell_type': 'code',
  'source': 'c = this(); c',
  'id': 'Y123sZmlsZQ==',
  'metadata': {'brd': {'id': '73daee75-5371-4c72-9211-52443b4b2bf7'}},
  'outputs': [
    {
      'output_type': 'execute_result',
      'execution_count': 54,
      'data': {
        'text/plain': "{'idx': 66,\n 'cell_type': 'code',\n 'source': 'c = this(); c',\n 'id': 'Y123sZmlsZQ==',\n 'metadata': {'brd': {'id': '73daee75-5371-4c72-9211-52443b4b2bf7'}},\n 'outputs': [],\n 'execution_count': None}",
        'text/html': '<style>details ul { list-style-type:none; list-style-position: outside; padding-inline-start: 22px; margin: 0; } details .string { color: #24837b; } details .string::before { content: "\'"; } details .string::after { content: "\'"; } details .number { color: #ad8301; } details .true { color: blue; } details .false { color: red; } details .null { color: gray; } span.n { color: darkgrey; } </style>\n<details open><summary>NBCell@66\n</summary>  <ul>\n    <li>\n<span><span class="n">idx</span>: <span class="v number">66</span></span>    </li>\n    <li>\n<span><span class="n">cell_type</span>: <span class="v string">code</span></span>    </li>\n    <li>\n<span><span class="n">source</span>: <span class="v string">c = this(); c</span></span>    </li>\n    <li>\n<span><span class="n">id</span>: <span class="v string">Y123sZmlsZQ==</span></span>    </li>\n    <li>\n<span><span class="n">metadata</span>: <span class="v ">{&#x27;brd&#x27;: {&#x27;id&#x27;: &#x27;73daee75-5371-4c72-9211-52443b4b2bf7&#x27;}}</span></span>    </li>\n<details open><summary>outputs\n</summary>      <ul></ul>\n</details>    <li>\n<span><span class="n">execution_count</span>: <span class="v null">None</span></span>    </li>\n  </ul>\n</details>',
        'text/markdown': "> code\n\n```json\n{\n  'idx': 66,\n  'cell_type': 'code',\n  'source': 'c = this(); c',\n  'id': 'Y123sZmlsZQ==',\n  'metadata': {'brd': {'id': '73daee75-5371-4c72-9211-52443b4b2bf7'}},\n  'outputs': [],\n  'execution_count': None\n}\n```"
      },
      'metadata': {}
    }
  ],
  'execution_count': 54
}
```

[`this`](https://civvic.github.io/bridget/nb_state.html#this) is meant
to be used interactively (as most of Bridget is).

The main function of
[`this`](https://civvic.github.io/bridget/nb_state.html#this) is to get
the current cell, or more so, the current cell‚Äôs index, and get your
bearings in the current notebook structure.

Note that due to the client-server nature of the Jupyter notebooks, code
running in the kernel can‚Äôt possibly access the cell currently being
executed. The cell state is maintained byt the front-end, not the
kernel. The kernel in fact knows nothing of notebooks or their
structure. We can aspire at most to get the cell‚Äôs index and source. The
output is not yet determined, though Bridget will capture it and you can
access it **after** the cell has run, not during the cell execution. You
can find the cell with NBState afterwards.

Also be aware, as always, that batch commands like ‚ÄúExecute Above Cells‚Äù
and similar are implemented very differently by Jupyter Notebooks
vendors. The cells in the run queue may start running in order (or not,
I‚Äôve seen ships on fire off the shoulder of Orion), but not necessarily
finish up in that order. Bridget may receive the cells in any order and
therefore, the notebook state is not settled until the end. In general,
in Jupyter Notebooks, cells that depends on outputs of other cells will
surely fail when not running interactively. This is known issue (and a
desing flaw imo, that can be resolved simply by the front-end sending
the cells in order to the kernel and waiting for each one to fisnish
before sending the next one) and one of the reason Marimo and other
Jupyter modern alternatives exists.

``` python
this(-1)
```

> markdown

``` json
{
  'idx': 68,
  'cell_type': 'markdown',
  'source': '[`this`](https://civvic.github.io/bridget/nb_state.html#this) is meant to be used interactively (as most of Bridget is).\n\nThe main function of [`this`](https://civvic.github.io/bridget/nb_state.html#this) is to get the current cell, or more so, the current cell\'s index, and get your bearings in the current notebook structure.\n\nNote that due to the client-server nature of the Jupyter notebooks, code running in the kernel can\'t possibly access the cell currently being executed. The cell state is maintained byt the front-end, not the kernel. The kernel in fact knows nothing of notebooks or their structure. We can aspire at most to get the cell\'s index and source. The output is not yet determined, though Bridget will capture it and you can access it **after** the cell has run, not during the cell execution. You can find the cell with NBState afterwards.\n\nAlso be aware, as always, that batch commands like "Execute Above Cells" and similar are implemented very differently by Jupyter Notebooks vendors. The cells in the run queue may start running in order (or not, I\'ve seen ships on fire off the shoulder of Orion), but not necessarily finish up in that order. Bridget may receive the cells in any order and therefore, the notebook state is not settled until the end. In general, in Jupyter Notebooks, cells that depends on outputs of other cells will surely fail when not running interactively. This is known issue (and a desing flaw imo, that can be resolved simply by the front-end sending the cells in order to the kernel and waiting for each one to fisnish before sending the next one) and one of the reason Marimo and other Jupyter modern alternatives exists.',
  'id': 'Y125sZmlsZQ==',
  'metadata': {'brd': {'id': '93341472-e8c3-44ed-8a54-24e71d861fbc'}}
}
```

``` python
this(-3).source
```

    'c'

``` python
this(FIRST).source
```

    '#| default_exp nb_state'

``` python
this(LAST).source
```

    "#| hide\n#| eval: false\n\nif FC.IN_NOTEBOOK:\n    BUNDLE_PATH = bundle_path(__name__)\n    for f in ['nbstate']: bundled(BUNDLE_PATH / f'js/{f}.js')()\n    nb_path = '21_nb_state.ipynb'\n    nbdev_clean(nb_path)\n    nbdev.nbdev_export(nb_path)"

``` python
this(1).source
```

    '# get_nb'

# get_nb

------------------------------------------------------------------------

<a
href="https://github.com/civvic/bridget/blob/main/bridget/nb_state.py#L201"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_nb

>  get_nb (*args, show_feedback:bool=False, logger:NBLogger|None=None,
>              show_logger:bool=False, lnks:dict[str,FT]|None=None,
>              esms:dict[str,str|Path]|None=None,
>              plugins:Sequence[BridgePlugin]|None=None,
>              kwplugins:dict[str,str]|None=None, wait:int=0,
>              summary:bool=False, factory:Callable[...,Any]|None=None,
>              timeout:float=10, sleep:float=0.2, n:int=10,
>              show:Callable[[bool],None]|None=None)

<table>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>args</td>
<td>VAR_POSITIONAL</td>
<td></td>
<td></td>
</tr>
<tr>
<td>show_feedback</td>
<td>bool</td>
<td>False</td>
<td></td>
</tr>
<tr>
<td>logger</td>
<td>NBLogger | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>show_logger</td>
<td>bool</td>
<td>False</td>
<td></td>
</tr>
<tr>
<td>lnks</td>
<td>dict[str, FT] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>esms</td>
<td>dict[str, str | Path] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>plugins</td>
<td>Sequence[BridgePlugin] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>kwplugins</td>
<td>dict[str, str] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>wait</td>
<td>int</td>
<td>0</td>
<td>seconds to wait for plugins/links/modules to load</td>
</tr>
<tr>
<td>summary</td>
<td>bool</td>
<td>False</td>
<td></td>
</tr>
<tr>
<td>factory</td>
<td>Callable[‚Ä¶, Any] | None</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>timeout</td>
<td>float</td>
<td>10</td>
<td></td>
</tr>
<tr>
<td>sleep</td>
<td>float</td>
<td>0.2</td>
<td></td>
</tr>
<tr>
<td>n</td>
<td>int</td>
<td>10</td>
<td></td>
</tr>
<tr>
<td>show</td>
<td>Callable[[bool], None] | None</td>
<td>None</td>
<td></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------
</doc><doc title="FastHTML" desc="FastHTML framework"># FastHTML

> FastHTML is a python library which brings together Starlette, Uvicorn, HTMX, and fastcore's `FT` "FastTags" into a library for creating server-rendered hypermedia applications. The `FastHTML` class itself inherits from `Starlette`, and adds decorator-based routing with many additions, Beforeware, automatic `FT` to HTML rendering, and much more.

Things to remember when writing FastHTML apps:

- Although parts of its API are inspired by FastAPI, it is *not* compatible with FastAPI syntax and is not targeted at creating API services
- FastHTML includes support for Pico CSS and the fastlite sqlite library, although using both are optional; sqlalchemy can be used directly or via the fastsql library, and any CSS framework can be used. Support for the Surreal and css-scope-inline libraries are also included, but both are optional
- FastHTML is compatible with JS-native web components and any vanilla JS library, but not with React, Vue, or Svelte
- Use `serve()` for running uvicorn (`if __name__ == "__main__"` is not needed since it's automatic)
- When a title is needed with a response, use `Titled`; note that that already wraps children in `Container`, and already includes both the meta title as well as the H1 element.

## Docs

- [FastHTML concise guide](https://www.fastht.ml/docs/ref/concise_guide.html.md): A brief overview of idiomatic FastHTML apps
- [HTMX reference](https://raw.githubusercontent.com/bigskysoftware/htmx/master/www/content/reference.md): Brief description of all HTMX attributes, CSS classes, headers, events, extensions, js lib methods, and config options
- [Starlette quick guide](https://gist.githubusercontent.com/jph00/e91192e9bdc1640f5421ce3c904f2efb/raw/61a2774912414029edaf1a55b506f0e283b93c46/starlette-quick.md): A quick overview of some Starlette features useful to FastHTML devs.

## API

- [API List](https://www.fastht.ml/docs/apilist.txt): A succint list of all functions and methods in fasthtml.
- [MonsterUI API List](https://raw.githubusercontent.com/AnswerDotAI/MonsterUI/refs/heads/main/docs/apilist.txt): Complete API Reference for Monster UI, a component framework similar to shadcn, but for FastHTML


## Examples

- [Websockets application](https://raw.githubusercontent.com/AnswerDotAI/fasthtml/main/examples/basic_ws.py): Very brief example of using websockets with HTMX and FastHTML
- [Todo list application](https://raw.githubusercontent.com/AnswerDotAI/fasthtml/main/examples/adv_app.py): Detailed walk-thru of a complete CRUD app in FastHTML showing idiomatic use of FastHTML and HTMX patterns.

## Optional

- [Surreal](https://raw.githubusercontent.com/AnswerDotAI/surreal/main/README.md): Tiny jQuery alternative for plain Javascript with inline Locality of Behavior, providing `me` and `any` functions
- [Starlette full documentation](https://gist.githubusercontent.com/jph00/809e4a4808d4510be0e3dc9565e9cbd3/raw/9b717589ca44cedc8aaf00b2b8cacef922964c0f/starlette-sml.md): A subset of the Starlette documentation useful for FastHTML development.
- [JS App Walkthrough](https://www.fastht.ml/docs/tutorials/e2e.html.md): An end-to-end walkthrough of a complete FastHTML app, including deployment to railway.
- [FastHTML by Example](https://www.fastht.ml/docs/tutorials/by_example.html.md): A collection of 4 FastHTML apps showcasing idiomatic use of FastHTML and HTMX patterns.
- [Using Jupyter to write FastHTML](https://www.fastht.ml/docs/tutorials/jupyter_and_fasthtml.html.md): A guide to developing FastHTML apps inside Jupyter notebooks.
- [FT Components](https://www.fastht.ml/docs/explains/explaining_xt_components.html.md): Explanation of the `FT` components, which are a way to write HTML in a Pythonic way.
- [FAQ](https://www.fastht.ml/docs/explains/faq.html.md): Answers to common questions about FastHTML.
- [MiniDataAPI Spec](https://www.fastht.ml/docs/explains/minidataapi.html.md): Explanation of the MiniDataAPI specification, which allows us to use the same API for many different database engines.
- [OAuth](https://www.fastht.ml/docs/explains/oauth.html.md): Tutorial and explanation of how to use OAuth in FastHTML apps.
- [Routes](https://www.fastht.ml/docs/explains/routes.html.md): Explanation of how routes work in FastHTML.
- [WebSockets](https://www.fastht.ml/docs/explains/websockets.html.md): Explanation of websockets and how they work in FastHTML.
- [Custom Components](https://www.fastht.ml/docs/ref/defining_xt_component.md): Explanation of how to create custom components in FastHTML.
- [Handling Handlers](https://www.fastht.ml/docs/ref/handlers.html.md): Explanation of how to request and response handlers work in FastHTML as routes.
- [Live Reloading](https://www.fastht.ml/docs/ref/live_reload.html.md): Explanation of how to use live reloading for FastHTML development.</doc><doc title="HTMX reference" desc="HTMX library">+++
title = "Reference"
+++

## Contents

* [htmx Core Attributes](#attributes)
* [htmx Additional Attributes](#attributes-additional)
* [htmx CSS Classes](#classes)
* [htmx Request Headers](#request_headers)
* [htmx Response Headers](#response_headers)
* [htmx Events](#events)
* [htmx Extensions](/extensions)
* [JavaScript API](#api)
* [Configuration Options](#config)

## Core Attribute Reference {#attributes}

The most common attributes when using htmx.

<div class="info-table">

| Attribute                                        | Description                                                                                                        |
|--------------------------------------------------|--------------------------------------------------------------------------------------------------------------------|
| [`hx-get`](@/attributes/hx-get.md)               | issues a `GET` to the specified URL                                                                                |
| [`hx-post`](@/attributes/hx-post.md)             | issues a `POST` to the specified URL                                                                               |
| [`hx-on*`](@/attributes/hx-on.md)                | handle events with inline scripts on elements                                                                      |
| [`hx-push-url`](@/attributes/hx-push-url.md)     | push a URL into the browser location bar to create history                                                         |
| [`hx-select`](@/attributes/hx-select.md)         | select content to swap in from a response                                                                          |
| [`hx-select-oob`](@/attributes/hx-select-oob.md) | select content to swap in from a response, somewhere other than the target (out of band)                           |
| [`hx-swap`](@/attributes/hx-swap.md)             | controls how content will swap in (`outerHTML`, `beforeend`, `afterend`, ...)                                      |
| [`hx-swap-oob`](@/attributes/hx-swap-oob.md)     | mark element to swap in from a response (out of band)                                                              |
| [`hx-target`](@/attributes/hx-target.md)         | specifies the target element to be swapped                                                                         |
| [`hx-trigger`](@/attributes/hx-trigger.md)       | specifies the event that triggers the request                                                                      |
| [`hx-vals`](@/attributes/hx-vals.md)             | add values to submit with the request (JSON format)                                                                |

</div>

## Additional Attribute Reference {#attributes-additional}

All other attributes available in htmx.

<div class="info-table">

| Attribute                                            | Description                                                                                                                        |
|------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------|
| [`hx-boost`](@/attributes/hx-boost.md)               | add [progressive enhancement](https://en.wikipedia.org/wiki/Progressive_enhancement) for links and forms                           |
| [`hx-confirm`](@/attributes/hx-confirm.md)           | shows a `confirm()` dialog before issuing a request                                                                                |
| [`hx-delete`](@/attributes/hx-delete.md)             | issues a `DELETE` to the specified URL                                                                                             |
| [`hx-disable`](@/attributes/hx-disable.md)           | disables htmx processing for the given node and any children nodes                                                                 |
| [`hx-disabled-elt`](@/attributes/hx-disabled-elt.md) | adds the `disabled` attribute to the specified elements while a request is in flight                                               |
| [`hx-disinherit`](@/attributes/hx-disinherit.md)     | control and disable automatic attribute inheritance for child nodes                                                                |
| [`hx-encoding`](@/attributes/hx-encoding.md)         | changes the request encoding type                                                                                                  |
| [`hx-ext`](@/attributes/hx-ext.md)                   | extensions to use for this element                                                                                                 |
| [`hx-headers`](@/attributes/hx-headers.md)           | adds to the headers that will be submitted with the request                                                                        |
| [`hx-history`](@/attributes/hx-history.md)           | prevent sensitive data being saved to the history cache                                                                            |
| [`hx-history-elt`](@/attributes/hx-history-elt.md)   | the element to snapshot and restore during history navigation                                                                      |
| [`hx-include`](@/attributes/hx-include.md)           | include additional data in requests                                                                                                |
| [`hx-indicator`](@/attributes/hx-indicator.md)       | the element to put the `htmx-request` class on during the request                                                                  |
| [`hx-inherit`](@/attributes/hx-inherit.md)           | control and enable automatic attribute inheritance for child nodes if it has been disabled by default                            |
| [`hx-params`](@/attributes/hx-params.md)             | filters the parameters that will be submitted with a request                                                                       |
| [`hx-patch`](@/attributes/hx-patch.md)               | issues a `PATCH` to the specified URL                                                                                              |
| [`hx-preserve`](@/attributes/hx-preserve.md)         | specifies elements to keep unchanged between requests                                                                              |
| [`hx-prompt`](@/attributes/hx-prompt.md)             | shows a `prompt()` before submitting a request                                                                                     |
| [`hx-put`](@/attributes/hx-put.md)                   | issues a `PUT` to the specified URL                                                                                                |
| [`hx-replace-url`](@/attributes/hx-replace-url.md)   | replace the URL in the browser location bar                                                                                        |
| [`hx-request`](@/attributes/hx-request.md)           | configures various aspects of the request                                                                                          |
| [`hx-sync`](@/attributes/hx-sync.md)                 | control how requests made by different elements are synchronized                                                                   |
| [`hx-validate`](@/attributes/hx-validate.md)         | force elements to validate themselves before a request                                                                             |
| [`hx-vars`](@/attributes/hx-vars.md)                 | adds values dynamically to the parameters to submit with the request (deprecated, please use [`hx-vals`](@/attributes/hx-vals.md)) |

</div>

## CSS Class Reference {#classes}

<div class="info-table">

| Class | Description |
|-----------|-------------|
| `htmx-added` | Applied to a new piece of content before it is swapped, removed after it is settled.
| `htmx-indicator` | A dynamically generated class that will toggle visible (opacity:1) when a `htmx-request` class is present
| `htmx-request` | Applied to either the element or the element specified with [`hx-indicator`](@/attributes/hx-indicator.md) while a request is ongoing
| `htmx-settling` | Applied to a target after content is swapped, removed after it is settled. The duration can be modified via [`hx-swap`](@/attributes/hx-swap.md).
| `htmx-swapping` | Applied to a target before any content is swapped, removed after it is swapped. The duration can be modified via [`hx-swap`](@/attributes/hx-swap.md).

</div>

## HTTP Header Reference {#headers}

### Request Headers Reference {#request_headers}

<div class="info-table">

| Header | Description |
|--------|-------------|
| `HX-Boosted` | indicates that the request is via an element using [hx-boost](@/attributes/hx-boost.md)
| `HX-Current-URL` | the current URL of the browser
| `HX-History-Restore-Request` | "true" if the request is for history restoration after a miss in the local history cache
| `HX-Prompt` | the user response to an [hx-prompt](@/attributes/hx-prompt.md)
| `HX-Request` | always "true"
| `HX-Target` | the `id` of the target element if it exists
| `HX-Trigger-Name` | the `name` of the triggered element if it exists
| `HX-Trigger` | the `id` of the triggered element if it exists

</div>

### Response Headers Reference {#response_headers}

<div class="info-table">

| Header                                               | Description |
|------------------------------------------------------|-------------|
| [`HX-Location`](@/headers/hx-location.md)            | allows you to do a client-side redirect that does not do a full page reload
| [`HX-Push-Url`](@/headers/hx-push-url.md)            | pushes a new url into the history stack
| [`HX-Redirect`](@/headers/hx-redirect.md)            | can be used to do a client-side redirect to a new location
| `HX-Refresh`                                         | if set to "true" the client-side will do a full refresh of the page
| [`HX-Replace-Url`](@/headers/hx-replace-url.md)      | replaces the current URL in the location bar
| `HX-Reswap`                                          | allows you to specify how the response will be swapped. See [hx-swap](@/attributes/hx-swap.md) for possible values
| `HX-Retarget`                                        | a CSS selector that updates the target of the content update to a different element on the page
| `HX-Reselect`                                        | a CSS selector that allows you to choose which part of the response is used to be swapped in. Overrides an existing [`hx-select`](@/attributes/hx-select.md) on the triggering element
| [`HX-Trigger`](@/headers/hx-trigger.md)              | allows you to trigger client-side events
| [`HX-Trigger-After-Settle`](@/headers/hx-trigger.md) | allows you to trigger client-side events after the settle step
| [`HX-Trigger-After-Swap`](@/headers/hx-trigger.md)   | allows you to trigger client-side events after the swap step

</div>

## Event Reference {#events}

<div class="info-table">

| Event | Description |
|-------|-------------|
| [`htmx:abort`](@/events.md#htmx:abort) | send this event to an element to abort a request
| [`htmx:afterOnLoad`](@/events.md#htmx:afterOnLoad) | triggered after an AJAX request has completed processing a successful response
| [`htmx:afterProcessNode`](@/events.md#htmx:afterProcessNode) | triggered after htmx has initialized a node
| [`htmx:afterRequest`](@/events.md#htmx:afterRequest)  | triggered after an AJAX request has completed
| [`htmx:afterSettle`](@/events.md#htmx:afterSettle)  | triggered after the DOM has settled
| [`htmx:afterSwap`](@/events.md#htmx:afterSwap)  | triggered after new content has been swapped in
| [`htmx:beforeCleanupElement`](@/events.md#htmx:beforeCleanupElement)  | triggered before htmx [disables](@/attributes/hx-disable.md) an element or removes it from the DOM
| [`htmx:beforeOnLoad`](@/events.md#htmx:beforeOnLoad)  | triggered before any response processing occurs
| [`htmx:beforeProcessNode`](@/events.md#htmx:beforeProcessNode) | triggered before htmx initializes a node
| [`htmx:beforeRequest`](@/events.md#htmx:beforeRequest)  | triggered before an AJAX request is made
| [`htmx:beforeSwap`](@/events.md#htmx:beforeSwap)  | triggered before a swap is done, allows you to configure the swap
| [`htmx:beforeSend`](@/events.md#htmx:beforeSend)  | triggered just before an ajax request is sent
| [`htmx:beforeTransition`](@/events.md#htmx:beforeTransition)  | triggered before the [View Transition](https://developer.mozilla.org/en-US/docs/Web/API/View_Transitions_API) wrapped swap occurs
| [`htmx:configRequest`](@/events.md#htmx:configRequest)  | triggered before the request, allows you to customize parameters, headers
| [`htmx:confirm`](@/events.md#htmx:confirm)  | triggered after a trigger occurs on an element, allows you to cancel (or delay) issuing the AJAX request
| [`htmx:historyCacheError`](@/events.md#htmx:historyCacheError)  | triggered on an error during cache writing
| [`htmx:historyCacheHit`](@/events.md#htmx:historyCacheHit)  | triggered on a cache hit in the history subsystem
| [`htmx:historyCacheMiss`](@/events.md#htmx:historyCacheMiss)  | triggered on a cache miss in the history subsystem
| [`htmx:historyCacheMissLoadError`](@/events.md#htmx:historyCacheMissLoadError)  | triggered on a unsuccessful remote retrieval
| [`htmx:historyCacheMissLoad`](@/events.md#htmx:historyCacheMissLoad)  | triggered on a successful remote retrieval
| [`htmx:historyRestore`](@/events.md#htmx:historyRestore)  | triggered when htmx handles a history restoration action
| [`htmx:beforeHistorySave`](@/events.md#htmx:beforeHistorySave)  | triggered before content is saved to the history cache
| [`htmx:load`](@/events.md#htmx:load)  | triggered when new content is added to the DOM
| [`htmx:noSSESourceError`](@/events.md#htmx:noSSESourceError)  | triggered when an element refers to a SSE event in its trigger, but no parent SSE source has been defined
| [`htmx:onLoadError`](@/events.md#htmx:onLoadError)  | triggered when an exception occurs during the onLoad handling in htmx
| [`htmx:oobAfterSwap`](@/events.md#htmx:oobAfterSwap)  | triggered after an out of band element as been swapped in
| [`htmx:oobBeforeSwap`](@/events.md#htmx:oobBeforeSwap)  | triggered before an out of band element swap is done, allows you to configure the swap
| [`htmx:oobErrorNoTarget`](@/events.md#htmx:oobErrorNoTarget)  | triggered when an out of band element does not have a matching ID in the current DOM
| [`htmx:prompt`](@/events.md#htmx:prompt)  | triggered after a prompt is shown
| [`htmx:pushedIntoHistory`](@/events.md#htmx:pushedIntoHistory)  | triggered after a url is pushed into history
| [`htmx:replacedInHistory`](@/events.md#htmx:replacedInHistory)  | triggered after a url is replaced in history
| [`htmx:responseError`](@/events.md#htmx:responseError)  | triggered when an HTTP response error (non-`200` or `300` response code) occurs
| [`htmx:sendAbort`](@/events.md#htmx:sendAbort)  | triggered when a request is aborted
| [`htmx:sendError`](@/events.md#htmx:sendError)  | triggered when a network error prevents an HTTP request from happening
| [`htmx:sseError`](@/events.md#htmx:sseError)  | triggered when an error occurs with a SSE source
| [`htmx:sseOpen`](/events#htmx:sseOpen)  | triggered when a SSE source is opened
| [`htmx:swapError`](@/events.md#htmx:swapError)  | triggered when an error occurs during the swap phase
| [`htmx:targetError`](@/events.md#htmx:targetError)  | triggered when an invalid target is specified
| [`htmx:timeout`](@/events.md#htmx:timeout)  | triggered when a request timeout occurs
| [`htmx:validation:validate`](@/events.md#htmx:validation:validate)  | triggered before an element is validated
| [`htmx:validation:failed`](@/events.md#htmx:validation:failed)  | triggered when an element fails validation
| [`htmx:validation:halted`](@/events.md#htmx:validation:halted)  | triggered when a request is halted due to validation errors
| [`htmx:xhr:abort`](@/events.md#htmx:xhr:abort)  | triggered when an ajax request aborts
| [`htmx:xhr:loadend`](@/events.md#htmx:xhr:loadend)  | triggered when an ajax request ends
| [`htmx:xhr:loadstart`](@/events.md#htmx:xhr:loadstart)  | triggered when an ajax request starts
| [`htmx:xhr:progress`](@/events.md#htmx:xhr:progress)  | triggered periodically during an ajax request that supports progress events

</div>

## JavaScript API Reference {#api}

<div class="info-table">

| Method | Description |
|-------|-------------|
| [`htmx.addClass()`](@/api.md#addClass)  | Adds a class to the given element
| [`htmx.ajax()`](@/api.md#ajax)  | Issues an htmx-style ajax request
| [`htmx.closest()`](@/api.md#closest)  | Finds the closest parent to the given element matching the selector
| [`htmx.config`](@/api.md#config)  | A property that holds the current htmx config object
| [`htmx.createEventSource`](@/api.md#createEventSource)  | A property holding the function to create SSE EventSource objects for htmx
| [`htmx.createWebSocket`](@/api.md#createWebSocket)  | A property holding the function to create WebSocket objects for htmx
| [`htmx.defineExtension()`](@/api.md#defineExtension)  | Defines an htmx [extension](https://htmx.org/extensions)
| [`htmx.find()`](@/api.md#find)  | Finds a single element matching the selector
| [`htmx.findAll()` `htmx.findAll(elt, selector)`](@/api.md#find)  | Finds all elements matching a given selector
| [`htmx.logAll()`](@/api.md#logAll)  | Installs a logger that will log all htmx events
| [`htmx.logger`](@/api.md#logger)  | A property set to the current logger (default is `null`)
| [`htmx.off()`](@/api.md#off)  | Removes an event listener from the given element
| [`htmx.on()`](@/api.md#on)  | Creates an event listener on the given element, returning it
| [`htmx.onLoad()`](@/api.md#onLoad)  | Adds a callback handler for the `htmx:load` event
| [`htmx.parseInterval()`](@/api.md#parseInterval)  | Parses an interval declaration into a millisecond value
| [`htmx.process()`](@/api.md#process)  | Processes the given element and its children, hooking up any htmx behavior
| [`htmx.remove()`](@/api.md#remove)  | Removes the given element
| [`htmx.removeClass()`](@/api.md#removeClass)  | Removes a class from the given element
| [`htmx.removeExtension()`](@/api.md#removeExtension)  | Removes an htmx [extension](https://htmx.org/extensions)
| [`htmx.swap()`](@/api.md#swap)  | Performs swapping (and settling) of HTML content
| [`htmx.takeClass()`](@/api.md#takeClass)  | Takes a class from other elements for the given element
| [`htmx.toggleClass()`](@/api.md#toggleClass)  | Toggles a class from the given element
| [`htmx.trigger()`](@/api.md#trigger)  | Triggers an event on an element
| [`htmx.values()`](@/api.md#values)  | Returns the input values associated with the given element

</div>


## Configuration Reference {#config}

Htmx has some configuration options that can be accessed either programmatically or declaratively.  They are
listed below:

<div class="info-table">

| Config Variable                        | Info                                                                                                                                                                       |
|----------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `htmx.config.historyEnabled`           | defaults to `true`, really only useful for testing                                                                                                                         |
| `htmx.config.historyCacheSize`         | defaults to 10                                                                                                                                                             |
| `htmx.config.refreshOnHistoryMiss`     | defaults to `false`, if set to `true` htmx will issue a full page refresh on history misses rather than use an AJAX request                                                |
| `htmx.config.defaultSwapStyle`         | defaults to `innerHTML`                                                                                                                                                    |
| `htmx.config.defaultSwapDelay`         | defaults to 0                                                                                                                                                              |
| `htmx.config.defaultSettleDelay`       | defaults to 20                                                                                                                                                             |
| `htmx.config.includeIndicatorStyles`   | defaults to `true` (determines if the indicator styles are loaded)                                                                                                         |
| `htmx.config.indicatorClass`           | defaults to `htmx-indicator`                                                                                                                                               |
| `htmx.config.requestClass`             | defaults to `htmx-request`                                                                                                                                                 |
| `htmx.config.addedClass`               | defaults to `htmx-added`                                                                                                                                                   |
| `htmx.config.settlingClass`            | defaults to `htmx-settling`                                                                                                                                                |
| `htmx.config.swappingClass`            | defaults to `htmx-swapping`                                                                                                                                                |
| `htmx.config.allowEval`                | defaults to `true`, can be used to disable htmx's use of eval for certain features (e.g. trigger filters)                                                                  |
| `htmx.config.allowScriptTags`          | defaults to `true`, determines if htmx will process script tags found in new content                                                                                       |
| `htmx.config.inlineScriptNonce`        | defaults to `''`, meaning that no nonce will be added to inline scripts                                                                                                    |
| `htmx.config.inlineStyleNonce`         | defaults to `''`, meaning that no nonce will be added to inline styles                                                                                                     |
| `htmx.config.attributesToSettle`       | defaults to `["class", "style", "width", "height"]`, the attributes to settle during the settling phase                                                                    |
| `htmx.config.wsReconnectDelay`         | defaults to `full-jitter`                                                                                                                                                  |
| `htmx.config.wsBinaryType`             | defaults to `blob`, the [the type of binary data](https://developer.mozilla.org/docs/Web/API/WebSocket/binaryType) being received over the WebSocket connection            |
| `htmx.config.disableSelector`          | defaults to `[hx-disable], [data-hx-disable]`, htmx will not process elements with this attribute on it or a parent                                                        |
| `htmx.config.disableInheritance`       | defaults to `false`. If it is set to `true`, the inheritance of attributes is completely disabled and you can explicitly specify the inheritance with the [hx-inherit](@/attributes/hx-inherit.md) attribute.
| `htmx.config.withCredentials`          | defaults to `false`, allow cross-site Access-Control requests using credentials such as cookies, authorization headers or TLS client certificates                          |
| `htmx.config.timeout`                  | defaults to 0, the number of milliseconds a request can take before automatically being terminated                                                                         |
| `htmx.config.scrollBehavior`           | defaults to 'instant', the scroll behavior when using the [show](@/attributes/hx-swap.md#scrolling-scroll-show) modifier with `hx-swap`. The allowed values are `instant` (scrolling should happen instantly in a single jump), `smooth` (scrolling should animate smoothly) and `auto` (scroll behavior is determined by the computed value of [scroll-behavior](https://developer.mozilla.org/en-US/docs/Web/CSS/scroll-behavior)). |
| `htmx.config.defaultFocusScroll`       | if the focused element should be scrolled into view, defaults to false and can be overridden using the [focus-scroll](@/attributes/hx-swap.md#focus-scroll) swap modifier. |
| `htmx.config.getCacheBusterParam`      | defaults to false, if set to true htmx will append the target element to the `GET` request in the format `org.htmx.cache-buster=targetElementId`                           |
| `htmx.config.globalViewTransitions`    | if set to `true`, htmx will use the [View Transition](https://developer.mozilla.org/en-US/docs/Web/API/View_Transitions_API) API when swapping in new content.             |
| `htmx.config.methodsThatUseUrlParams`  | defaults to `["get", "delete"]`, htmx will format requests with these methods by encoding their parameters in the URL, not the request body                                |
| `htmx.config.selfRequestsOnly`         | defaults to `true`, whether to only allow AJAX requests to the same domain as the current document                                                             |
| `htmx.config.ignoreTitle`              | defaults to `false`, if set to `true` htmx will not update the title of the document when a `title` tag is found in new content                                            |
| `htmx.config.scrollIntoViewOnBoost`    | defaults to `true`, whether or not the target of a boosted element is scrolled into the viewport. If `hx-target` is omitted on a boosted element, the target defaults to `body`, causing the page to scroll to the top. |
| `htmx.config.triggerSpecsCache`        | defaults to `null`, the cache to store evaluated trigger specifications into, improving parsing performance at the cost of more memory usage. You may define a simple object to use a never-clearing cache, or implement your own system using a [proxy object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Proxy) |
| `htmx.config.responseHandling`         | the default [Response Handling](@/docs.md#response-handling) behavior for response status codes can be configured here to either swap or error                             |
| `htmx.config.allowNestedOobSwaps`      | defaults to `true`, whether to process OOB swaps on elements that are nested within the main response element. See [Nested OOB Swaps](@/attributes/hx-swap-oob.md#nested-oob-swaps). |
| `htmx.config.historyRestoreAsHxRequest`| defaults to `true`, Whether to treat history cache miss full page reload requests as a "HX-Request" by returning this response header. This should always be disabled when using HX-Request header to optionally return partial responses                                                                                                         |
| `htmx.config.reportValidityOfForms`    | defaults to `false`, Whether to report input validation errors to the end user and update focus to the first input that fails validation. This should always be enabled as this matches default browser form submit behaviour                                                                                                                     |


</div>

You can set them directly in javascript, or you can use a `meta` tag:

```html
<meta name="htmx-config" content='{"defaultSwapStyle":"outerHTML"}'>
```</doc><doc title="nbdev llms.txt" desc="Literate programming framework"># nbdev

nbdev makes exploration an integral part of your workflow, all while promoting software engineering best practices. It allows you to write, test, document, and distribute software packages and technical articles ‚Äî all in one place, your notebook.

Here are some of nbdev's features:

- **Supports literate programming**: write prose, code, and tests in notebooks ‚Äî no context-switching
- **Git-friendly notebooks**: human-readable merge conflicts; no unwanted metadata
- **Two-way sync between notebooks and plaintext source code**: allows you to use your IDE for code navigation or quick edits
- **Beautiful technical documentation**: documentation is automatically generated using Quarto and hosted on GitHub Pages; docs support LaTeX, are searchable, and are automatically hyperlinked (including out-of-the-box support for many packages via nbdev-index)
- **Seamless testing**: write tests as ordinary notebook cells, run them in parallel with a single command; out-of-the-box continuous integration with GitHub Actions to ensure tests pass before every merge
- **Simplified package release**: publish packages to PyPI and conda; Python best practices are automatically followed (e.g. only exported objects are included in `__all__`)

## Tutorials

- [Getting started](https://nbdev.fast.ai/getting_started.html.md)
- [Tutorial](https://nbdev.fast.ai/tutorials/tutorial.html.md)
- [Best practices](https://nbdev.fast.ai/tutorials/best_practices.html.md)

## API

- [API List](https://nbdev.fast.ai/apilist.txt): A succint list of all functions and methods in nbdev.

## Optional

- [Git-Friendly Jupyter](https://nbdev.fast.ai/tutorials/git_friendly_jupyter.html.md): How to use nbdev hooks for git-friendly Jupyter notebooks
- [Blogging](https://nbdev.fast.ai/tutorials/blogging.html.md: Creating a blog with notebooks)
- [Pre-Commit Hooks](https://nbdev.fast.ai/tutorials/pre_commit.html.md): How to use nbdev‚Äôs git pre-commit hooks
- [Documentation Only Sites](https://nbdev.fast.ai/tutorials/docs_only.html.md): How to create nbdev powered docs without a library!
- [Modular nbdev](https://nbdev.fast.ai/tutorials/modular_nbdev.html.md): How to use nbdev‚Äôs various tools separately
- [Writing nbdev plugins](https://nbdev.fast.ai/tutorials/extensions.html.md): How to customize nbdev processors to do what you want
- [nbdev1 Migration](https://nbdev.fast.ai/tutorials/migrating.html.md): How to change your nbdev1 repo to work with nbdev2
- [nbdev.config](https://nbdev.fast.ai/api/config.html.md): Configuring nbdev and bootstrapping notebook export
- [nbdev.maker](https://nbdev.fast.ai/api/maker.html.md): Create one or more modules from selected notebook cells
- [nbdev.process](https://nbdev.fast.ai/api/process.html.md): A notebook processor
- [nbdev.export](https://nbdev.fast.ai/api/export.html.md): Exporting a notebook to a library
- [nbdev.doclinks](https://nbdev.fast.ai/api/doclinks.html.md): Generating a documentation index from a module
- [nbdev.sync](https://nbdev.fast.ai/api/sync.html.md): Propagate small changes in the library back to notebooks
- [nbdev.merge](https://nbdev.fast.ai/api/merge.html.md): Fix merge conflicts in jupyter notebooks
- [nbdev.showdoc](https://nbdev.fast.ai/api/showdoc.html.md): Display symbol documentation in notebook and website
- [nbdev.frontmatter](https://nbdev.fast.ai/api/frontmatter.html.md): A YAML and formatted-markdown frontmatter processor
- [nbdev.processor](https://nbdev.fast.ai/api/processors.html.md): Some processors for NBProcessor
- [nbdev.clean](https://nbdev.fast.ai/api/clean.html.md): Strip superfluous metadata from notebooks
- [nbdev.test](https://nbdev.fast.ai/api/test.html.md): Run unit tests on notebooks in parallel
- [nbdev.cli](https://nbdev.fast.ai/api/cli.html.md): CLI commands
- [nbdev.quarto](https://nbdev.fast.ai/api/quarto.html.md): Install and interact with Quarto from nbdev
- [nbdev.qmd](https://nbdev.fast.ai/api/qmd.html.md): Basic qmd generation helpers (experimental)
- [nbdev.migrate](https://nbdev.fast.ai/api/migrate.html.md): Utilities for migrating to nbdev
- [nbdev.serve](https://nbdev.fast.ai/api/serve.html.md): A parallel ipynb processor (experimental)
- [nbdev.release](https://nbdev.fast.ai/api/release.html.md): Auto-generated tagged releases and release notes from GitHub issues</doc><doc title="AnyWidget README" desc="Jupyter widget infrastructure"><h1>
<p align="center">
  <img src="https://raw.githubusercontent.com/manzt/anywidget/main/docs/public/favicon.svg" alt="anywidget logo. A circular icon with two connected arrows pointing clockwise, symbolizing a refresh or restart action" width="60">
  <br>anywidget
</h1>
<samp>
  <p align="center">
    <span>reusable widgets made easy</span>
      <br>
      <br>
      <a href="#installation">installation</a> .
      <a href="https://anywidget.dev">docs</a> .
      <a href="https://discord.gg/W5h4vPMbDQ">discord</a> .
      <a href="https://blog.jupyter.org/anywidget-jupyter-widgets-made-easy-164eb2eae102">learn</a>
  </p>
</samp>
</p>

## About

**anywidget** is both a [**specification**](https://anywidget.dev/en/afm) and
**toolkit** for authoring reusable web-based widgets for interactive computing
environments.

- üõ†Ô∏è create custom Jupyter Widgets **without complicated cookiecutter templates**
- üìö **publish to PyPI** like any other Python package
- ü§ñ prototype **within** `.ipynb` or `.py` files
- üöÄ run in **Jupyter**, **JupyterLab**, **Google Colab**, **VSCode**, [**marimo**](https://github.com/marimo-team/marimo) and more
- ‚ö° develop with **instant HMR**, like modern web frameworks

Learn more in the
[Jupyter blog](https://blog.jupyter.org/anywidget-jupyter-widgets-made-easy-164eb2eae102).

## Installation

**anywidget** is available on [PyPI](https://pypi.org/project/anywidget/):

```bash
pip install "anywidget[dev]"
```

and also on [conda-forge](https://anaconda.org/conda-forge/anywidget):

```bash
conda install -c conda-forge anywidget
```

## Usage

The easiest way to start developing with **anywidget** is with the Python package.

```python
import anywidget
import traitlets

class CounterWidget(anywidget.AnyWidget):
    # Widget front-end JavaScript code
    _esm = """
    function render({ model, el }) {
      let button = document.createElement("button");
      button.innerHTML = `count is ${model.get("value")}`;
      button.addEventListener("click", () => {
        model.set("value", model.get("value") + 1);
        model.save_changes();
      });
      model.on("change:value", () => {
        button.innerHTML = `count is ${model.get("value")}`;
      });
      el.appendChild(button);
    }
    export default { render };
    """
    # Stateful property that can be accessed by JavaScript & Python
    value = traitlets.Int(0).tag(sync=True)
```

Front-end code can also live in separate files (recommend):

```python
import pathlib
import anywidget
import traitlets

class CounterWidget(anywidget.AnyWidget):
    _esm = pathlib.Path("index.js")
    _css = pathlib.Path("styles.css")
    value = traitlets.Int(0).tag(sync=True)
```

Read [the documentation](https://anywidget.dev/en/getting-started) to learn
more.

## Packages

Beyond the primary Python package, **anywidget** provides an ecosystem of
tooling to help you build and distribute custom widgets.

| Name                                                                                             | Description                     | Version (click for changelogs)                                                                                                                                                                     |
| ------------------------------------------------------------------------------------------------ | ------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| [`anywidget`](https://github.com/manzt/anywidget/tree/main/packages/anywidget)                   | Primary Python package          | [![version](https://img.shields.io/pypi/v/anywidget.svg?labelColor=0273B7&color=0C3141)](https://github.com/manzt/anywidget/blob/main/packages/anywidget/CHANGELOG.md)                             |
| [`npm:@anywidget/types`](https://github.com/manzt/anywidget/tree/main/packages/types)            | Client type declarations        | [![version](https://img.shields.io/npm/v/@anywidget/types.svg?labelColor=C43636&color=0C3141&logo=npm&label)](https://github.com/manzt/anywidget/blob/main/packages/types/CHANGELOG.md)            |
| [`npm:@anywidget/vite`](https://github.com/manzt/anywidget/tree/main/packages/vite)              | Vite plugin                     | [![version](https://img.shields.io/npm/v/@anywidget/vite.svg?labelColor=C43636&color=0C3141&logo=npm&label)](https://github.com/manzt/anywidget/blob/main/packages/vite/CHANGELOG.md)              |
| [`npm:@anywidget/react`](https://github.com/manzt/anywidget/tree/main/packages/react)            | React framework bridge          | [![version](https://img.shields.io/npm/v/@anywidget/react.svg?labelColor=C43636&color=0C3141&logo=npm&label)](https://github.com/manzt/anywidget/blob/main/packages/react/CHANGELOG.md)            |
| [`npm:@anywidget/svelte`](https://github.com/manzt/anywidget/tree/main/packages/svelte)          | Svelte framework bridge         | [![version](https://img.shields.io/npm/v/@anywidget/svelte.svg?labelColor=C43636&color=0C3141&logo=npm&label)](https://github.com/manzt/anywidget/blob/main/packages/svelte/CHANGELOG.md)          |
| [`npm:create-anywidget`](https://github.com/manzt/anywidget/tree/main/packages/create-anywidget) | CLI to bootstrap a new project  | [![version](https://img.shields.io/npm/v/create-anywidget.svg?labelColor=C43636&color=0C3141&logo=npm&label)](https://github.com/manzt/anywidget/blob/main/packages/create-anywidget/CHANGELOG.md) |
| [`jsr:@anywidget/deno`](https://github.com/manzt/anywidget/tree/main/packages/deno)              | Backend for Deno Jupyter kernel | [![version](https://jsr.io/badges/@anywidget/deno)](https://github.com/manzt/anywidget/blob/main/packages/deno/CHANGELOG.md)                                                                       |
| [`jsr:@anywidget/signals`](https://github.com/manzt/anywidget/tree/main/packages/signals)        | Signals bridge                  | [![version](https://jsr.io/badges/@anywidget/signals)](https://github.com/manzt/anywidget/blob/main/packages/signals/CHANGELOG.md)                                                                 |

## Support

Having trouble? Get help in our [Discord](https://discord.gg/W5h4vPMbDQ) or open
a [Discussion](https://github.com/manzt/anywidget/issues/new).

## Contributing

**New contributors welcome!** Check out our
[Contributors Guide](./CONTRIBUTING.md) for help getting started.

Join us on [Discord](https://discord.gg/W5h4vPMbDQ) to meet other maintainers.
We'll help you get your first contribution in no time!

## Citation

If you use **anywidget** in your work, please consider citing the following
publications:

Our [JOSS paper](https://joss.theoj.org/papers/10.21105/joss.06939) describing
the overall project and vision:

```bibtex
@article{manz2024anywidget,
  title = {anywidget: reusable widgets for interactive analysis and visualization in computational notebooks},
  volume = {9},
  url = {https://doi.org/10.21105/joss.06939},
  doi = {10.21105/joss.06939},
  number = {102},
  journal = {Journal of Open Source Software},
  author = {Manz, Trevor and Abdennur, Nezar and Gehlenborg, Nils},
  year = {2024},
  note = {Publisher: The Open Journal},
  pages = {6939},
}
```

Our [SciPy paper](https://proceedings.scipy.org/articles/NRPV2311), detailing
the motivation and approach behind Jupyter Widget ecosystem compatibility:

```bibtex
@inproceedings{manz2024notebooks,
  title = {Any notebook served: authoring and sharing reusable interactive widgets},
  copyright = {https://creativecommons.org/licenses/by/4.0/},
  url = {https://doi.org/10.25080/NRPV2311},
  doi = {10.25080/NRPV2311},
  urldate = {2024-10-07},
  booktitle = {Proceedings of the 23rd {Python} in {Science} {Conference}},
  author = {Manz, Trevor and Gehlenborg, Nils and Abdennur, Nezar},
  month = jul,
  year = {2024},
}
```</doc></optional></project>
